/*5/22/2017, 4:51:29 PM smartisan*/
"use strict";navigator.userAgent.indexOf("Mac OS X")>-1?$("body").addClass("macos"):($("body").addClass("windows"),0===$(".ie8,.ie9").length&&$("body").addClass("gt-ie9"));var app=angular.module("noteApp",["ngRoute"]);app.run(["$rootScope",function($rootScope){}]),app.controller("MainCtrl",["$timeout","$rootScope","$scope","TaskService","DialogService","AnimationService","OnlineDataService","DataMergeService","ToastService","SyncDiffManageService","SyncQueueService","MoodService","PushManageService","InitManageService","WebSocketService","StatusService",function($timeout,$rootScope,$scope,TaskService,DialogService,AnimationService,OnlineDataService,DataMergeService,ToastService,SyncDiffManageService,SyncQueueService,MoodService,PushManageService,InitManageService,WebSocketService,StatusService){var task=TaskService($scope,"MainCtrl","mainTask");task.add("toastTextChange",function(text){$scope.toastText=text}),task.add("dialogCancel",function(){DialogService.cancel()}),task.add("dialogConfirm",function(){DialogService.confirm()}),task.add("dialogCustom",function(type){DialogService.custom(type)}),task.add("newNote",function(){MoodService.change({type:MoodService.type.EDIT,info:MoodService.info.BLUR}),TaskService.fire("NoteListCtrl.createNote")}),task.add("refresh",function(){MoodService.change({type:MoodService.type.EDIT,info:MoodService.info.BLUR}),$scope.isRefreshing||($scope.isRefreshing=!0,SyncDiffManageService.update(function(data){var curNote=StatusService.getValue(StatusService.name.CUR_NOTE);TaskService.fire("NoteEditCtrl.refresh",curNote)}),$timeout(function(){$scope.isRefreshing&&($scope.isRefreshing=!1)},3e3))}),task.add("relogin",function(){DialogService.open("LoginTimeout",function(){top.CloudAPI&&top.CloudAPI.relogin("notes"),DialogService.close()})}),$scope.isSpecialFolderSelected=function(){var result=!1;return TaskService.fire("FolderListCtrl.specialFolderIsSelected",function(isSelected){result=isSelected}),result},$scope.openSide=function(){top.CloudAPI&&top.CloudAPI.openSide()},$scope.removeMenuMask=function(){$rootScope.ifPreventSide=!1},SyncQueueService.onChange(function(){SyncQueueService.hasAllComplete()?$scope.isRefreshing=!1:$scope.isRefreshing=!0,$scope.$$phase||$scope.$apply()}),AnimationService.action("screenWidthResize")();setTimeout(function(){var IE9FileBugLabel_immersive=$("#IE9FileBugLabel-immersive");IE9FileBugLabel_immersive.attr({for:$(".a-insert-image input").attr("id")});var IE9FileBugLabel_normal=$("#IE9FileBugLabel-normal");IE9FileBugLabel_normal.attr({for:$(".a-insert-image-button input").attr("id")})},1e3),$scope.stopBubble=function(){event.stopPropagation(),event.cancelBubble=!0}}]),app.controller("NoteListCtrl",["$filter","$scope","TaskService","AnimationService","DataEventService","ScrollBarService","SortAndFilterNoteListService","NoteService","NoteListService","DialogService","GlobalConfigService","NoteListScrollService","MoodService","StatusService",function($filter,$scope,TaskService,AnimationService,DataEventService,ScrollBarService,SortAndFilterNoteListService,NoteService,NoteListService,DialogService,GlobalConfigService,NoteListScrollService,MoodService,StatusService){function isShift(event){return!!event.shiftKey}function isCtrl(){return ctrlKey}function setSelectedNotes(note){if(_.isArray(note))$scope.selectedNotes=_.clone(note);else{if(NoteService.isNullNote(note))return;_.indexOf($scope.selectedNotes,note)>-1?$scope.selectedNotes.length>1&&($scope.selectedNotes=_.without($scope.selectedNotes,note)):$scope.selectedNotes.push(note)}TaskService.fire("NoteListCtrl.deleteEmptyNote"),StatusService.setValue(StatusService.name.SELECTED_NOTES,$scope.selectedNotes)}function setSelectedNote(note){NoteService.isNullNote(note)?$scope.selectedNotes=[]:$scope.selectedNotes=[note],TaskService.fire("NoteListCtrl.deleteEmptyNote"),StatusService.setValue(StatusService.name.SELECTED_NOTES,$scope.selectedNotes)}function isMultiSelected(){return $scope.selectedNotes.length>1}function hasNewNote(){if(_.isEmpty($scope.sortNoteList))return!1;var note=$scope.sortNoteList[0];return!!_.isEmpty(note.detail)}var _lastNoteID=NoteService.NULL_NOTEID,_noteTitleHeight=GlobalConfigService.NOTE_TITLE_HEIGHT;StatusService.setValue(StatusService.name.CUR_SEARCH_TYPE,"IsAllNote"),StatusService.setValue(StatusService.name.CUR_KEYWORD,""),$scope.selectedNotes=[],$scope.noteList=[],$scope.sortNoteList=[],$scope.visibleNoteList=[],$scope.visibleNoteListPos=0,$scope.noteListContainerMinHeight=0,$scope.emptyInfo="",$scope.$filter=$filter;var task=TaskService($scope,"NoteListCtrl");$scope.isSelected=function(note){return _.indexOf($scope.selectedNotes,note)>-1},NoteListScrollService.bind($scope,"sortNoteList","visibleNoteList","visibleNoteListPos");var isInit=!1;DataEventService.onInit(function(){isInit=!0,TaskService.fire("NoteListCtrl.updateFilterList")}),NoteListService.on(DataEventService.ADD,function(note){$scope.noteList.push(note),isInit&&TaskService.fire("NoteListCtrl.updateFilterList"),$scope.$$phase||$scope.$apply()}),NoteListService.on(DataEventService.REMOVE,function(note){$scope.noteList=_.without($scope.noteList,note);var list=_.without($scope.sortNoteList,note);TaskService.fire("NoteListCtrl.setSortNoteList",list),$scope.$$phase||$scope.$apply()}),NoteListService.on(DataEventService.UPDATE,function(note){isInit&&"browser"!=note.origin&&(MoodService.isType(MoodService.type.EDIT)&&_.indexOf($scope.selectedNotes,note)>-1&&TaskService.fire("NoteEditCtrl.refresh",note),TaskService.fire("NoteListCtrl.updateFilterList")),$scope.$$phase||$scope.$apply()}),task.add("listClick",function(note,$event){if(isShift($event)){var curNote=StatusService.getValue(StatusService.name.CUR_NOTE),start=_.indexOf($scope.sortNoteList,curNote),end=_.indexOf($scope.sortNoteList,note),notes=[];notes=start<end?_.clone($scope.sortNoteList).splice(start,end-start+1):_.clone($scope.sortNoteList).splice(end,start-end+1),setSelectedNotes(notes),TaskService.fire("NoteCopyDirc.set",_.clone(notes).splice(-3,notes.length))}else isCtrl($event)?(setSelectedNotes(note),TaskService.fire("NoteCopyDirc.set",note)):(setSelectedNote(note),TaskService.fire("NoteCopyDirc.set",[note]));TaskService.fire("BottomMenuCtrl.changeSelectedCounter"),isMultiSelected()?MoodService.change({type:MoodService.type.MULTI,info:""}):(MoodService.change({type:MoodService.type.EDIT,info:MoodService.info.BLUR}),TaskService.fire("NoteListCtrl.switchNote",note))});var ctrlKey=!1;$(window).keydown(function(e){(e.ctrlKey||e.metaKey)&&(ctrlKey=!0)}),$(window).keyup(function(e){ctrlKey=!1}),task.add("favoriteClick",function(note){MoodService.isType(MoodService.type.EDIT)&&NoteService.updateFavorite(note)}),task.add("updateFilterList",function(note){var type=StatusService.getValue(StatusService.name.CUR_SEARCH_TYPE),keyword=StatusService.getValue(StatusService.name.CUR_KEYWORD);TaskService.fire("NoteListCtrl.filterList",type,keyword)}),task.add("switchNote",function(note){note||(note=$scope.sortNoteList.length>0?$scope.sortNoteList[0]:{_id:null,detail:""}),_lastNoteID=note._id,setSelectedNote(note),TaskService.fire("NoteCopyDirc.set",[note]),StatusService.setValue(StatusService.name.CUR_NOTE,note),TaskService.fire("NoteEditCtrl.openNote"),MoodService.change({type:MoodService.type.EDIT,info:MoodService.info.BLUR}),TaskService.fire("BottomMenuCtrl.changeSelectedCounter")}),task.add("defaultSelectNote",function(){var note={_id:null,detail:""};$scope.sortNoteList.length>0&&(note=$scope.sortNoteList[0]),_lastNoteID=note._id,setSelectedNote(note),TaskService.fire("NoteCopyDirc.set",[note]),StatusService.setValue(StatusService.name.CUR_NOTE,note),TaskService.fire("NoteEditCtrl.openNote"),TaskService.fire("BottomMenuCtrl.changeSelectedCounter")}),task.add("setSortNoteList",function(list){$scope.sortNoteList=_.clone(list);var len=list.length;if($scope.noteListContainerMinHeight=_noteTitleHeight*len,NoteListScrollService.update(),TaskService.fire("ListFilterCtrl.changeNoteCount",len),len>0){var intersection=_.intersection($scope.selectedNotes,$scope.sortNoteList);0==intersection.length&&TaskService.fire("NoteListCtrl.switchNote",_.first($scope.sortNoteList))}else TaskService.fire("NoteListCtrl.switchNote");TaskService.fire("ListFilterCtrl.getListEmptyTip",function(tip){$scope.emptyInfo=tip})}),task.add("delete",function(list,fn){_.isFunction(list)&&(fn=list,list=$scope.selectedNotes),_.isArray(list)||(list=[list]);var len=list.length;_.each(list,function(note){AnimationService.action("deleteNoteInList")(note,function(){NoteListService.removeNote(note),len--,0===len&&fn&&fn()})})}),task.add("recover",function(fn){TaskService.fire("FolderListCtrl.getAllFolder",function(all){var noteList=$scope.selectedNotes,len=noteList.length;_.each(noteList,function(note){AnimationService.action("deleteNoteInList")(note,function(){len--,0===len&&(NoteService.updateFolder(noteList,all),TaskService.fire("NoteListCtrl.updateFilterList"),fn&&fn())})})})}),task.add("moveToTrash",function(fn){TaskService.fire("FolderListCtrl.getTrash",function(trash){var noteList=$scope.selectedNotes,len=noteList.length;_.each(noteList,function(note){AnimationService.action("deleteNoteInList")(note,function(){len--,0===len&&(NoteService.updateFolder(noteList,trash),TaskService.fire("NoteListCtrl.updateFilterList"),fn&&fn())})})})}),task.add("moveToFolder",function(note,folder){NoteService.updateFolder(note,folder),TaskService.fire("NoteListCtrl.updateFilterList")}),task.add("filterList",function(type,keyword){var filterList=[],allType="IsAllNote,Folder";allType.indexOf(type)<0||("Folder"==type&&keyword._id==GlobalConfigService.ALL_FOLDER_ID&&(type="IsAllNote",keyword=""),StatusService.setValue(StatusService.name.CUR_SEARCH_TYPE,type),StatusService.setValue(StatusService.name.CUR_KEYWORD,keyword),filterList=SortAndFilterNoteListService.filterBy(type,$scope.noteList,keyword),TaskService.fire("NoteListCtrl.setSortNoteList",filterList),TaskService.fire("NoteListCtrl.createEmptyNoteIfNoteListIsEmpty"))}),task.add("createNote",function(){if(!hasNewNote()){ScrollBarService.scrollTop("NoteList",0);var folder=StatusService.getValue(StatusService.name.CUR_FOLDER),note=NoteService.createNote(folder);NoteListService.addNote(note),TaskService.fire("NoteListCtrl.switchNote",note)}}),task.add("deleteEmptyNote",function(fn){var list=[];if(_.each($scope.noteList,function(note){0===note.detail.length&&list.push(note)}),0===len)return void(fn&&fn());$scope.selectedNotes.length>1?_.intersection($scope.selectedNotes,list).length>0&&setSelectedNotes(_.difference($scope.selectedNotes,list)):list=_.difference(list,$scope.selectedNotes);var len=list.length;return 0===len?void(fn&&fn()):void TaskService.fire("NoteListCtrl.delete",list,function(){fn&&fn()})}),task.add("createEmptyNoteIfNoteListIsEmpty",function(fn){var allNotes=SortAndFilterNoteListService.filterBy("IsAllNote",$scope.noteList,"");0===allNotes.length&&"IsAllNote"==StatusService.getValue(StatusService.name.CUR_SEARCH_TYPE)&&MoodService.isType(MoodService.type.EDIT)&&TaskService.fire("NoteListCtrl.createNote")}),MoodService.onChange(function(origin,target){MoodService.isChange(MoodService.type.MULTI,MoodService.type.EDIT)&&$scope.selectedNotes.length>1&&TaskService.fire("NoteListCtrl.defaultSelectNote")})}]),app.controller("FolderListCtrl",["$filter","$timeout","$rootScope","$scope","TaskService","AnimationService","DataEventService","FolderNameInputService","FolderService","FolderListService","FolderListFindService","DialogService","ContextMenuService","NoteListService","NoteListFindService","ToastService","GlobalConfigService","ScrollBarService","UtilService","MoodService","StatusService","SortAndFilterNoteListService",function($filter,$timeout,$rootScope,$scope,TaskService,AnimationService,DataEventService,FolderNameInputService,FolderService,FolderListService,FolderListFindService,DialogService,ContextMenuService,NoteListService,NoteListFindService,ToastService,GlobalConfigService,ScrollBarService,UtilService,MoodService,StatusService,SortAndFilterNoteListService){function removeFolder(folder){var title=folder.title;UtilService.subMixString(title,40),DialogService.setContent("DeleteFolder",{title:folder.title}),DialogService.open("DeleteFolder",function(){var notes=SortAndFilterNoteListService.filterBy("Folder",NoteListFindService.getAll(),folder);TaskService.fire("NoteListCtrl.moveToFolder",notes,$scope.trash),FolderListService.removeFolder(folder),TaskService.fire("FolderListCtrl.listClick",$scope.all),DialogService.close()})}function countNote(noteList){_.each($scope.folderList,function(folder){folder.sum=0,folder.maxPos=0}),_.each(noteList,function(note){1==note.favorite&&$scope.fav.sum++,note.isCallNote&&$scope.call.sum++;var folder=FolderListFindService.findFolderByNote(note);folder!=$scope.all&&(folder.sum++,_.isNumber(note.position_in_folder)&&note.position_in_folder>folder.maxPos&&(folder.maxPos=note.position_in_folder)),$scope.all.sum++,folder==$scope.trash&&(1==note.favorite&&$scope.fav.sum--,note.isCallNote&&$scope.call.sum--,$scope.all.sum--)})}$scope.temp={sum:0,title:"",isShow:!1},$scope.all={sum:0},$scope.trash={sum:0},$scope.folderList=[],$scope.curFolder=null;var task=TaskService($scope,"FolderListCtrl");FolderListService.on(DataEventService.ADD,function(folder){$scope.folderList.push(folder),$scope.folderList=FolderListService.sortFolderList($scope.folderList),$scope.all=_.first($scope.folderList),$scope.fav=$scope.folderList[1],$scope.call=$scope.folderList[2],$scope.curFolder||($scope.curFolder=$scope.all,StatusService.setValue(StatusService.name.CUR_FOLDER,$scope.all)),$scope.trash=_.last($scope.folderList),$scope.$$phase||$scope.$apply()}),FolderListService.on(DataEventService.REMOVE,function(folder){$scope.folderList=_.without($scope.folderList,folder),$scope.$$phase||$scope.$apply()}),FolderListService.on(DataEventService.UPDATE,function(folder){$scope.folderList=FolderListService.sortFolderList($scope.folderList),$scope.$$phase||$scope.$apply()}),task.add("listClick",function(folder){$scope.curFolder!=folder&&($scope.curFolder=folder,StatusService.setValue(StatusService.name.CUR_FOLDER,folder),TaskService.fire("ListFilterCtrl.cleanSearch"),ScrollBarService.scrollTop("NoteList",0),TaskService.fire("NoteListCtrl.filterList","Folder",folder),MoodService.change({type:MoodService.type.EDIT,info:MoodService.info.BLUR}))}),task.add("createFolderBtnClick",function(note){return $scope.folderList.length-4<GlobalConfigService.FOLDER_MAX?(MoodService.change({type:MoodService.type.EDIT,info:MoodService.info.BLUR}),$scope.temp.isShow=!0,ScrollBarService.scrollTop("FolderList",0),void $timeout(function(){FolderNameInputService.init("",$(".a-folder-temp"),function(val){val.length>0&&TaskService.fire("FolderListCtrl.createFolder",val),$scope.temp.isShow=!1,$scope.$$phase||$scope.$apply()})})):void ToastService.open("FOLDER_NUMBER_EXCEEDED")}),task.add("createFolder",function(title){var folder=FolderService.createFolder(title);folder&&FolderListService.addFolder(folder)}),task.add("allFolderIsSelected",function(fn){fn($scope.curFolder==$scope.all)}),task.add("specialFolderIsSelected",function(fn){fn($scope.curFolder==$scope.trash||$scope.curFolder==$scope.fav||$scope.curFolder==$scope.call?!0:!1)}),task.add("getTrash",function(fn){fn($scope.trash)}),task.add("getAllFolder",function(fn){fn($scope.all)}),task.add("listTrashBtnClick",function(folder){removeFolder(folder)}),DataEventService.onInit(function(){var noteList=NoteListFindService.getAll();countNote(noteList),DataEventService.onChange(function(){var noteList=NoteListFindService.getAll();countNote(noteList)})}),ContextMenuService.on("FolderMenu.rename","data-id",function(id,targetDom){var folder=FolderListFindService.findFolder(id);FolderNameInputService.init(folder.title,targetDom,function(val){FolderService.updateFolderTitle(folder,val),$scope.$$phase||$scope.$apply()})}),ContextMenuService.on("FolderMenu.delete","data-id",function(id,targetDom){var folder=FolderListFindService.findFolder(id);removeFolder(folder)}),MoodService.onChange(function(origin,target){target.type==MoodService.type.SEARCH&&($scope.curFolder=$scope.all)})}]),app.controller("ListFilterCtrl",["$scope","TaskService","LayerService","AnimationService","I18NService","ScrollBarService",function($scope,TaskService,LayerService,AnimationService,I18NService,ScrollBarService){$scope.search={keyword:""},$scope.inputIsFocus=!1;var task=TaskService($scope,"ListFilterCtrl"),optionMap={IsAllNote:{className:"all",name:"全部便签"},IsFavNote:{className:"fav",name:"加星便签"},IsImageNote:{className:"img",name:"图片便签"},IsCallNote:{className:"call",name:"通话便签"}};$scope.searchKeywordChanged=function(keyword){$scope.curOption=optionMap.IsAllNote,TaskService.fire("NoteListCtrl.filterList","IsAllNote",keyword),TaskService.fire("NoteEditCtrl.hightLightKeyword"),ScrollBarService.scrollTop("NoteList",0)},task.add("cleanSearch",function(){$scope.search.keyword="",$scope.curOption=optionMap.IsAllNote,TaskService.fire("NoteListCtrl.filterList","IsAllNote",""),TaskService.fire("NoteEditCtrl.hightLightKeyword")}),task.add("changeNoteCount",function(number){$.isNumeric(number)&&($scope.itemCount=number,AnimationService.action("changeFilterStyle")())});var emptyTipMap={noFilter:"",all:I18NService("NO_SEARCH_RESULT").$$unwrapTrustedValue(),fav:I18NService("NO_FAV_RESULT").$$unwrapTrustedValue(),img:I18NService("NO_IMAGE_RESULT").$$unwrapTrustedValue(),call:I18NService("NO_CALL_RESULT").$$unwrapTrustedValue(),folder:I18NService("NO_FOLDER_RESULT").$$unwrapTrustedValue()};task.add("getListEmptyTip",function(fn){var status="noFilter";$scope.search.keyword.length>0&&"all"==$scope.curOption.className&&(status=$scope.curOption.className),"all"!=$scope.curOption.className&&(status=$scope.curOption.className),TaskService.fire("FolderListCtrl.allFolderIsSelected",function(result){fn(result?emptyTipMap[status]:emptyTipMap.folder)})}),$scope.curOption=optionMap.IsAllNote}]),app.controller("BottomMenuCtrl",["$scope","TaskService","AnimationService","GlobalConfigService","StatusService",function($scope,TaskService,AnimationService,GlobalConfigService,StatusService){$scope.selectedCounter=1;var task=TaskService($scope,"BottomMenuCtrl");task.add("changeSelectedCounter",function(length){var notes=StatusService.getValue(StatusService.name.SELECTED_NOTES);$scope.selectedCounter=notes.length}),task.add("fold",function(){var columnNum=GlobalConfigService.getConfig("column");3==columnNum?GlobalConfigService.setConfig("column",2):GlobalConfigService.setConfig("column",3),$(window).trigger("resize")})}]),app.controller("NoteMenuCtrl",["$rootScope","TaskService","DialogService","$scope","AnimationService","OnlineToolService","TypoService","ShareService","NoteService","SyncQueueService","DataEventService","ToastService","MoodService","StatusService","FolderService",function($rootScope,TaskService,DialogService,$scope,AnimationService,OnlineToolService,TypoService,ShareService,NoteService,SyncQueueService,DataEventService,ToastService,MoodService,StatusService,FolderService){function noteIsEmpty(){var result=!1,selected_notes=StatusService.getValue(StatusService.name.SELECTED_NOTES);return _.isArray(selected_notes)&&selected_notes.length>0?_.each(selected_notes,function(note){note&&0===note.detail.length&&(result=!0)}):result=!0,result}function noteIsNoSync(){var result=!1,selected_notes=StatusService.getValue(StatusService.name.SELECTED_NOTES);return _.isArray(selected_notes)&&selected_notes.length>0?_.each(selected_notes,function(note){note&&!note.sync_id&&(result=!0)}):result=!0,result}function isNullNote(){var result=!1,selected_notes=StatusService.getValue(StatusService.name.SELECTED_NOTES);return _.isArray(selected_notes)&&selected_notes.length>0?_.each(selected_notes,function(note){NoteService.isNullNote(note)&&(result=!0)}):result=!0,result}function isTrashFolder(){var folder=StatusService.getValue(StatusService.name.CUR_FOLDER);return FolderService.isTrashFolder(folder)}function isType(type){return MoodService.isType(type)}function isLoading(){return StatusService.getValue(StatusService.name.PREVIEW_IMAGE_LOADING)}function isInfo(info){return MoodService.isInfo(info)}function getShareImageSrc(imageName){return"https://cloud.smartisan.com/apps/"+Math.round((new Date).getTime()/1e3)+"/weiboimage/"+imageName}function createShareImageX(callback,note){OnlineToolService.createShareImage(note).then(function(data){curShareImageName=data.image;var src=getShareImageSrc(data.image);window.LocalEnvironment&&(src="/notesimage/"+data.image);var imgDom=$(".a-img-preview .preview-img");imgDom.attr("src",src),imgDom.one("load",function(){callback&&callback()}).each(function(){this.complete&&$(this).trigger("load")})})}function createShareImage(callback){var note=StatusService.getValue(StatusService.name.CUR_NOTE);if(NoteService.isSyncNote(note))createShareImageX(callback,note);else{var queue=SyncQueueService.findQueueByNote(DataEventService.ADD,note);if(queue&&queue.status==SyncQueueService.COMPLETE_STATUS&&(queue=SyncQueueService.findQueueByNote(DataEventService.UPDATE,note),queue&&queue.status==SyncQueueService.COMPLETE_STATUS))return;SyncQueueService.onComplete(queue,function(){createShareImageX(callback,note)}),SyncQueueService.forcePush()}}var curShareImageName=null,task=TaskService($scope,"NoteMenuCtrl"),btnShowVaildMap={insertImage:function(){return isType(MoodService.type.EDIT)&&!isNullNote()},moveNote:function(){return!isTrashFolder()&&!isNullNote()&&!isType(MoodService.type.PREVIEW)},recoverNote:function(){return isTrashFolder()&&!isNullNote()},deleteNote:function(){return!isType(MoodService.type.PREVIEW)&&!isNullNote()&&!$rootScope.ifImmersive},shareNote:function(){return isType(MoodService.type.EDIT)&&!isTrashFolder()&&!isNullNote()},unimmersive:function(){return isType(MoodService.type.EDIT)&&$rootScope.ifImmersive},saveImage:function(){return isType(MoodService.type.PREVIEW)},imgShareToWeibo:function(){return isType(MoodService.type.PREVIEW)},shareToLongWeibo:function(){return isType(MoodService.type.PREVIEW)},back:function(){return isType(MoodService.type.PREVIEW)}},btnDisabledVaildMap={insertImage:function(){return isType(MoodService.type.EDIT)&&isInfo(MoodService.info.BLUR)},moveNote:function(){return noteIsNoSync()&&noteIsEmpty()},recoverNote:function(){return!0},deleteNote:function(){return noteIsNoSync()&&noteIsEmpty()},shareNote:function(){return noteIsEmpty()||noteIsNoSync()},saveImage:function(){return isLoading()},imgShareToWeibo:function(){return isLoading()}};$scope.isShow=function(btnName){return btnShowVaildMap[btnName]()},$scope.isDisabled=function(btnName){return btnDisabledVaildMap[btnName]()},task.add("deleteBtnClick",function(){var selectedNotes=StatusService.getValue(StatusService.name.SELECTED_NOTES);if(_.isArray(selectedNotes)&&0!==selectedNotes.length){var folder=StatusService.getValue(StatusService.name.CUR_FOLDER);FolderService.isTrashFolder(folder)?DialogService.open("DeleteNote",function(){AnimationService.action("deleteNote")(function(){TaskService.fire("NoteListCtrl.delete",function(){TaskService.fire("NoteListCtrl.switchNote")})}),DialogService.close()}):DialogService.open("MoveToTrash",function(){AnimationService.action("deleteNote")(function(){TaskService.fire("NoteListCtrl.moveToTrash",function(){TaskService.fire("NoteListCtrl.switchNote")})}),DialogService.close()})}}),task.add("immersiveModeSwitch",function(isOpen){TaskService.fire("NoteEditCtrl.immersiveModeSwitch",isOpen)}),task.add("webPreviewBtnClick",function(){MoodService.change({type:MoodService.type.PREVIEW,info:""});var note=StatusService.getValue(StatusService.name.CUR_NOTE);note.detail.length>0&&(StatusService.setValue(StatusService.name.PREVIEW_IMAGE_LOADING,!0),createShareImage(function(){TypoService.onComplete(function(){AnimationService.action("preview")("loadComplete"),StatusService.setValue(StatusService.name.PREVIEW_IMAGE_LOADING,!1),$scope.$$phase||$scope.$apply()}),0===note.formatting_mode&&TypoService.typo(note.detail),1===note.formatting_mode&&TypoService.rtf(note.detail,note.rtf_style),2===note.formatting_mode&&TypoService.markdown(note.detail)}))}),task.add("imgPreviewBtnClick",function(){curShareImageName=null,AnimationService.action("preview")("img",function(){$(".a-preview-loading").show(),$(".a-img-preview .preview-img").hide()}),createShareImage()}),task.add("cancelBtnClick",function(){MoodService.change({type:MoodService.type.EDIT,info:MoodService.info.BLUR})}),task.add("saveImage",function(){var isloading=StatusService.getValue(StatusService.name.PREVIEW_IMAGE_LOADING);if(!isloading){var imageID=curShareImageName.replace(/\.\w+$/,""),filename="note_"+Math.uuid(16).toLowerCase(),url="/apps/note/index.php?r=weibo/download&image_name="+imageID+"&title="+filename;window.open(url)}}),task.add("imgShareBtnClick",function(){var isloading=StatusService.getValue(StatusService.name.PREVIEW_IMAGE_LOADING);if(!isloading){var note=StatusService.getValue(StatusService.name.CUR_NOTE);ShareService.imgShare(getShareImageSrc(curShareImageName),note)}}),task.add("webShareBtnClick",function(){var note=StatusService.getValue(StatusService.name.CUR_NOTE);ShareService.webShare(note)}),task.add("moveBtnClick",function(){DialogService.open("MoveNoteToFolder",function(){TaskService.fire("FolderListDirc.moveToFolder",function(){MoodService.change({type:MoodService.type.EDIT,info:MoodService.info.BLUR}),DialogService.close()})},function(){TaskService.fire("FolderListDirc.reset"),DialogService.close()},function(customType){"CreateFolder"==customType&&TaskService.fire("FolderListDirc.showFolderNameInput")})}),task.add("recoverBtnClick",function(){TaskService.fire("NoteListCtrl.recover",function(){ToastService.open("RESTORED_TO_ALL")})}),MoodService.onChange(function(origin,target){MoodService.isChange(MoodService.type.PREVIEW,MoodService.type.ALL)&&AnimationService.action("preview")("exit"),MoodService.isChange(MoodService.type.ALL,MoodService.type.PREVIEW)&&AnimationService.action("preview")("web")})}]),app.controller("NoteEditCtrl",["$rootScope","$scope","$filter","$timeout","TaskService","LayerService","DialogService","EditorService","ClipImageService","NoteService","AnimationService","GlobalConfigService","I18NService","ScrollBarService","StatusService","MoodService","ImmersiveModeService","FolderListFindService","NoteListScrollService",function($rootScope,$scope,$filter,$timeout,TaskService,LayerService,DialogService,EditorService,ClipImageService,NoteService,AnimationService,GlobalConfigService,I18NService,ScrollBarService,StatusService,MoodService,ImmersiveModeService,FolderListFindService,NoteListScrollService){function updateNotePosition(){$scope.note.pos<NoteService.getMaxPos()&&($scope.note.pos=NoteService.maxPosaAutIoncrement());var folder=FolderListFindService.findFolderByNote($scope.note);folder&&_.isNumber($scope.note.position_in_folder)&&$scope.note.position_in_folder<folder.maxPos&&($scope.note.position_in_folder=folder.maxPos+1,folder.maxPos=$scope.note.position_in_folder),TaskService.fire("NoteListCtrl.updateFilterList"),ScrollBarService.scrollTop("NoteList")}$scope.wordCounter=0,$scope.$filter=$filter,$scope.leftText=null,$scope.rtfBtn={bold:"normal",ul:"normal",quote:"normal",center:"normal",head:"normal"};var task=TaskService($scope,"NoteEditCtrl");task.add("openNote",function(){var note=StatusService.getValue(StatusService.name.CUR_NOTE);if(note&&note._id){if($scope.note==note)return;$scope.note&&($scope.note.history=EditorService.getHistory()),$scope.note=note,$scope.leftText=null,$scope.wordCounter=0,EditorService.setMode(note.formatting_mode),EditorService.setValue(note.detail,note.rtf_style),ScrollBarService.scrollTop("EditWrap"),EditorService.setHistory(note.history)}else $scope.leftText=null,$scope.wordCounter=0,$scope.note=note,EditorService.setValue(""),ScrollBarService.scrollTop("EditWrap")}),task.add("refresh",function(note){note&&$scope.note._id==note._id&&($scope.wordCounter=0,EditorService.setMode(note.formatting_mode),EditorService.refresh(note.detail,note.rtf_style),$scope.wordCounter=EditorService.wordsCount())}),task.add("insertImage",function(imageObj){EditorService.insertImage(imageObj)}),task.add("clipImage",function(imgSrc,callback){ClipImageService.clip(imgSrc,callback)}),task.add("noteChange",function(disabledSave){if($scope.note&&$scope.note._id){$scope.wordCounter=EditorService.wordsCount();var detail=EditorService.getValue(),rtf_style=EditorService.getStyle();if(disabledSave||(updateNotePosition(),NoteService.saveDetail($scope.note,detail,rtf_style)),$scope.wordCounter+500>GlobalConfigService.EDITOR_MAX_CONTENT_LENGTH){var wordsLeft=GlobalConfigService.EDITOR_MAX_CONTENT_LENGTH-$scope.wordCounter;wordsLeft>=0?$scope.leftText=I18NService("EDITOR_WORDS_LEFT",wordsLeft):$scope.leftText=I18NService("EDITOR_WORDS_EXCEED",Math.abs(wordsLeft))}else $scope.leftText=null;$scope.$$phase||$scope.$apply()}}),task.add("editorBlur",function(){MoodService.change({type:MoodService.type.EDIT,info:MoodService.info.BLUR}),$scope.$$phase||$scope.$apply()}),task.add("editorFocus",function(){MoodService.change({type:MoodService.type.EDIT,info:MoodService.info.FOCUS}),$scope.$$phase||$scope.$apply()});var switchOutRTF=function(val){EditorService.setMode(val),NoteService.updateFormattingMode($scope.note,val),EditorService.hideStyle()};task.add("editModeSwitch",function(val){var curMode=EditorService.getMode();curMode==GlobalConfigService.RTF_MODE&&val!=GlobalConfigService.RTF_MODE?EditorService.isRTFEmptyStyle()?switchOutRTF(val):DialogService.open("RtfStyleDelete",function(){switchOutRTF(val),updateNotePosition(),NoteService.clearStyle($scope.note),DialogService.close()}):(EditorService.setMode(val),NoteService.updateFormattingMode($scope.note,val),val==GlobalConfigService.RTF_MODE&&""==$scope.note.rtf_style&&($scope.note.rtf_style=EditorService.getStyle()))}),task.add("immersiveModeSwitch",function(isOpen){ImmersiveModeService.openImmersiveMode(isOpen),EditorService.resetCursorPos()}),task.add("favoriteClick",function(){NoteService.updateFavorite($scope.note)}),task.add("hightLightKeyword",function(){EditorService.hightLight()}),task.add("rtfBtnClick",function(styleName){EditorService.addStyle(styleName)}),task.add("changeRtfBtnStatus",function(rtfBtnStatus){$scope.rtfBtn=rtfBtnStatus,$scope.$$phase||$scope.$apply()}),task.add("hideStyle",function(){EditorService.hideStyle()}),task.add("showStyle",function(){EditorService.showStyle($scope.note)}),task.add("clearStyle",function(){NoteService.clearStyle($scope.note)}),MoodService.onChange(function(origin,target){MoodService.isChange(MoodService.type.ALL,MoodService.type.MULTI)&&TaskService.fire("NoteCopyDirc.show"),MoodService.isChange(MoodService.type.MULTI,MoodService.type.ALL)&&TaskService.fire("NoteCopyDirc.hide")}),$(".CodeMirror").delegate(".line-todo","click",function(){$(this).parent().prev().hasClass("rtf-todo")?EditorService.toggleRtfTodo("checked"):EditorService.toggleRtfTodo("")})}]),app.factory("ToastService",["AnimationService","TaskService","I18NService",function(AnimationService,TaskService,I18NService){var service={};return service.open=function(text){var itext=text;_.isString(text)&&(itext=/^[A-Z_]+$/.test(text)?I18NService(text):text),TaskService.fire("MainCtrl.toastTextChange",itext),setTimeout(function(){AnimationService.action("openToast")()},100)},service}]),app.factory("DialogService",["AnimationService",function(AnimationService){var domsMap={},scopeMap={},dialogConfirm=function(){},dialogCancel=function(){},dialogCustom=function(){},curDialogName="";return{setContent:function(name,content){scopeMap[name].dialogContent=content},open:function(name,confirm,cancel,custom){var self=this;dialogConfirm=function(){self.close()},dialogCancel=function(){self.close()},dialogCustom=function(){self.close()},angular.isFunction(confirm)&&(dialogConfirm=confirm),angular.isFunction(cancel)&&(dialogCancel=cancel),angular.isFunction(custom)&&(dialogCustom=custom),domsMap[curDialogName]&&domsMap[curDialogName].removeClass("on"),
curDialogName=name,domsMap[curDialogName].addClass("on"),AnimationService.action("openDialog")(),"LoginTimeout"!=name&&setTimeout(function(){$("body").one("click.dialog",function(){$(document).off("keyup.dialog"),AnimationService.action("closeDialog")()}),$(document).one("keyup.dialog",function(e){27===e.keyCode&&($("body").off("click.dialog"),AnimationService.action("closeDialog")())})},1)},close:function(){$("body").off("click.dialog"),$(document).off("keyup.dialog"),"LoginTimeout"!=curDialogName&&AnimationService.action("closeDialog")()},cancel:function(){dialogCancel()},confirm:function(){dialogConfirm()},custom:function(type){dialogCustom(type)},addDom:function(name,dom,scope){domsMap[name]=dom,scopeMap[name]=scope}}}]),app.factory("AnimationService",["$timeout",function($timeout){function checkNodeLoaded(selectors,callback){var len=selectors.length;$.each(selectors,function(i){$(selectors[i]).length>0&&len--}),0!==len?setTimeout(function(){checkNodeLoaded(selectors,callback)},50):callback()}function getSelectors(fn){var fnStr=fn.toString(),selectors=[];return fnStr.replace(/\$\(\'([^\']+)\'\)/g,function(str,s1){return selectors.push(s1),str}),selectors}var service={},checkNodes={},actions={};return service.action=function(name){return actions[name]?function(){var args=arguments,action=actions[name],selectors=checkNodes[name];checkNodeLoaded(selectors,function(){$timeout(function(){action.apply(null,args)},1)})}:void(window.console&&console.log("%cAnimate不存在："+name,"color:red"))},service.add=function(name,fn,needCheckNodes){if(actions[name])return void(window.console&&console.log("%cAction已存在："+name,"color:red"));actions[name]=fn;var selectors=getSelectors(fn);return $.isArray(needCheckNodes)&&needCheckNodes.length>0&&(selectors=selectors.concat(needCheckNodes)),checkNodes[name]=selectors,service.action(name)},service.install=function(name,fn,needCheckNodes){service.add(name,fn,needCheckNodes)()},window.LocalEnvironment&&(window.AnimationService=service),service}]),app.factory("DataService",["$rootScope","OfflineDataService","DataEventService","UtilService",function($rootScope,OfflineDataService,DataEventService,UtilService){function offlineSave(queue){apiMap[queue.type][queue.dataName](queue.data)}function makeQueueId(queue){var id="",subType="";return queue.data&&queue.data._id&&(queue.dataId=queue.data._id),queue.dataId&&(id=queue.dataId),queue.subType&&(subType=queue.subType),queue.type+queue.dataName+subType+id}function isSame(queue){var tmpOldQueue=_oldQueue;if(_oldQueue=queue,!tmpOldQueue)return!1;var oldId=makeQueueId(tmpOldQueue),newId=makeQueueId(queue);return oldId==newId}var service={},ADD=DataEventService.ADD,UPDATE=DataEventService.UPDATE,REMOVE=DataEventService.REMOVE,GET=DataEventService.GET,NOTE=(DataEventService.FAVORITE,DataEventService.MARKDOWN,DataEventService.FOLDER,DataEventService.NOTE),VERSION=DataEventService.VERSION,FOLDER=DataEventService.FOLDER,apiMap={};apiMap[ADD]={},apiMap[UPDATE]={},apiMap[REMOVE]={},apiMap[GET]={},apiMap[ADD][NOTE]=OfflineDataService.createNote,apiMap[ADD][FOLDER]=OfflineDataService.createFolder,apiMap[UPDATE][NOTE]=OfflineDataService.updateNote,apiMap[UPDATE][FOLDER]=OfflineDataService.updateFolder,apiMap[UPDATE][VERSION]=OfflineDataService.updateVersion,apiMap[REMOVE][NOTE]=OfflineDataService.deleteNote,apiMap[REMOVE][FOLDER]=OfflineDataService.deleteFolder,apiMap[GET][FOLDER]=OfflineDataService.getFolderList,apiMap[GET][NOTE]=OfflineDataService.getNoteList,apiMap[GET][VERSION]=OfflineDataService.getVersion;var throttleOfflineSave=_.throttle(offlineSave,500),_oldQueue=null;return service.update=function(queue){UtilService.isSupportOfflineDataService()&&(isSame(queue)?throttleOfflineSave(queue):offlineSave(queue)),DataEventService.trigger(queue.type,queue.dataName,queue.data,queue.subType)},service.get=function(name){return apiMap[GET][name]()},service}]),app.factory("DataEventService",[function(){var binds=[],server={},triggerRecord=[];return server.ADD="add",server.UPDATE="update",server.REMOVE="remove",server.GET="get",server.FAVORITE="favorite",server.MARKDOWN="markdown",server.FORMATTING_MODE="formatting_mode",server.SYNC_ID="syncId",server.DETAIL="detail",server.MODIFY_TIME="modifyTime",server.NOTE="note",server.VERSION="version",server.FOLDER="folder",server.on=function(eventName,dataName,fn){"change"===eventName&&"init"===eventName||_.each(triggerRecord,function(record){record.eventName==eventName&&(dataName&&record.dataName==dataName?fn(record.data,record.subType):dataName||fn(record.data))}),binds.push({eventName:eventName,dataName:dataName,fn:fn})},server.onAdd=function(dataName,fn){server.on(server.ADD,dataName,fn)},server.onRemove=function(dataName,fn){server.on(server.REMOVE,dataName,fn)},server.onUpdate=function(dataName,fn){server.on(server.UPDATE,dataName,fn)},server.onInit=function(fn){server.on("init",null,fn)},server.onChange=function(fn){server.on("change",null,fn)},server.trigger=function(eventName,dataName,data,subType){triggerRecord.push({eventName:eventName,dataName:dataName,data:data,subType:subType}),_.each(binds,function(bind){bind.eventName==eventName&&(bind.dataName&&bind.dataName==dataName?bind.fn(data,subType):bind.dataName||bind.fn(data))}),_.each(binds,function(bind){"change"==bind.eventName&&bind.fn()})},server}]),app.factory("OnlineDataService",["$rootScope","$http","$q","ToastService","ErrorService","DataEventService","DataService","GlobalConfigService",function($rootScope,$http,$q,ToastService,ErrorService,DataEventService,DataService,GlobalConfigService){function batchReject(delays){_.each(delays,function(delay){delay.reject()})}function batchResolve(delays){_.each(delays,function(delay){delay.resolve()})}function batchUpdateFolderPost(){var sync_ids=[];_.each(_batchUpdateFolderData,function(note){sync_ids.push({sync_id:note.sync_id,position_in_folder:note.position_in_folder})}),service.updateFolder({sync_ids:JSON.stringify(sync_ids),folderType:_batchUpdateFolderData[0].folderType,folderId:_batchUpdateFolderData[0].folderId,delays:_batchUpdateFolderDelays}).then(function(param){batchResolve(param.delays)},function(param){batchReject(param.delays)})}var tabId=GlobalConfigService.TAB_ID,service={},batchStatus=!1,batchData=[],batchDelays=[],POST=function(url,param){param||(param={});var delay=$q.defer();return param.tab_id=tabId,$http({method:"POST",url:url,data:$.param(param),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(msg){if(1==msg.code){ErrorService.catch(msg);var is2154=!1;for(var key in msg.errInfo)if("2154"==key||2154==key){is2154=!0;break}is2154?delay.resolve(msg.data):delay.reject(msg)}else delay.resolve(msg.data)}).error(function(){ErrorService.catch({errInfo:{e500:"http error"}}),delay.reject(null)}),delay.promise},GET=function(url,param){param||(param={}),param.tab_id=tabId;var delay=$q.defer();return $http({method:"GET",url:url,data:$.param(param)}).success(function(msg){1==msg.code?(ErrorService.catch(msg),delay.reject(null)):delay.resolve(msg.data)}).error(function(){ErrorService.catch({errInfo:{e500:"http error"}}),delay.reject(null)}),delay.promise};service.getUid=function(){return GET("index.php?r=account/login")},service.getDiff=function(noteVersion){return POST("index.php?r=v2/diff",{note_version:noteVersion})},service.getInitData=function(){return GET("index.php?r=v2/getList")},service.deleteNote=function(note){return POST("index.php?r=note/deleteAll",{sync_ids:note.sync_id})},service.deleteNotes=function(param){return new Promise(function(resolve,reject){POST("index.php?r=note/deleteAll",{sync_ids:param.sync_ids}).then(function(){resolve(param)},function(){reject(param)})})},service.batchDeleteNotes=function(note){var delay=$q.defer();return batchStatus||(batchStatus=!0,batchData=[],batchDelays=[],setTimeout(function(){batchStatus=!1;var sync_ids=[];_.each(batchData,function(n){sync_ids.push(n.sync_id)}),service.deleteNotes({sync_ids:sync_ids.join(","),delays:batchDelays}).then(function(param){batchResolve(param.delays)},function(param){batchReject(param.delays)})},1e3)),batchDelays.push(delay),batchData.push(note),delay.promise},service.updateNote=function(note){var delay=$q.defer(),param={rtf_style:note.rtf_style,detail:note.detail,sync_id:note.sync_id,formatting_mode:note.formatting_mode,favorite:note.favorite,title:note.title,position_in_folder:note.position_in_folder,pos:note.pos};return POST("index.php?r=note/update",param).then(function(data){note.modify_time=data.note.modify_time,DataService.update({type:DataEventService.UPDATE,dataName:DataEventService.NOTE,data:note,subType:DataEventService.MODIFY_TIME}),delay.resolve(data)}),delay.promise},service.createNote=function(note){var delay=$q.defer(),param={detail:note.detail,favorite:note.favorite,markdown:note.markdown,folderId:note.folderId,formatting_mode:note.formatting_mode,title:note.title};return POST("index.php?r=note/create",param).then(function(data){note.sync_id=data.note.sync_id,DataService.update({type:DataEventService.UPDATE,dataName:DataEventService.NOTE,data:note,subType:DataEventService.SYNC_ID}),delay.resolve(data)},function(){delay.reject()}),delay.promise},service.updateMarkdown=function(note){var param={sync_id:note.sync_id,markdown:note.markdown};return POST("index.php?r=note/updateMarkdown",param)},service.updateFormattingMode=function(note){var param={sync_id:note.sync_id,formatting_mode:note.formatting_mode};return POST("index.php?r=note/updateFormattingMode",param)},service.updateFavorite=function(note){var param={sync_id:note.sync_id,favorite:note.favorite};return POST("index.php?r=note/updateFav",param)},service.updateFolder=function(param){return new Promise(function(resolve,reject){POST("index.php?r=note/updateFolder",{sync_ids:param.sync_ids,folder_type:param.folderType,folderId:param.folderId}).then(function(){resolve(param)},function(){reject(param)})})};var _batchUpdateFolderStatus=!1,_batchUpdateFolderData=[],_batchUpdateFolderDelays=[],_batchUpdateFolderTime=null;return service.batchUpdateFolder=function(note){var delay=$q.defer();return _batchUpdateFolderStatus?note.folderId==_batchUpdateFolderData[0].folderId?(_batchUpdateFolderData.push(note),_batchUpdateFolderDelays.push(delay)):(clearTimeout(_batchUpdateFolderTime),batchUpdateFolderPost(),_batchUpdateFolderData=[],_batchUpdateFolderDelays=[],_batchUpdateFolderData.push(note),_batchUpdateFolderDelays.push(delay),_batchUpdateFolderTime=setTimeout(function(){batchUpdateFolderPost(),_batchUpdateFolderStatus=!1,_batchUpdateFolderData=[],_batchUpdateFolderDelays=[]},1e3)):(_batchUpdateFolderStatus=!0,_batchUpdateFolderData.push(note),_batchUpdateFolderDelays.push(delay),_batchUpdateFolderTime=setTimeout(function(){batchUpdateFolderPost(),_batchUpdateFolderStatus=!1,_batchUpdateFolderData=[],_batchUpdateFolderDelays=[]},1e3)),delay.promise},service.getFolderList=function(){return GET("index.php?r=folder/getList")},service.deleteFolder=function(folder){var param={sync_ids:folder.sync_id};return POST("index.php?r=folder/deleteAll",param)},service.updateFolderTitle=function(folder){var param={title:folder.title,sync_id:folder.sync_id};return POST("index.php?r=folder/update",param)},service.createFolder=function(folder){var delay=$q.defer(),param={title:folder.title,position:folder.position};return POST("index.php?r=folder/create",param).then(function(data){delay.resolve(data),data.noteFolder._id=folder._id,DataService.update({type:DataEventService.UPDATE,dataName:DataEventService.FOLDER,data:data.noteFolder,subType:DataEventService.SYNC_ID})},function(){delay.reject()}),delay.promise},service}]),app.factory("OfflineDataService",["$q","GlobalConfigService",function($q,GlobalConfigService){function getId(key){var uid=GlobalConfigService.getConfig("uid");return uid+"::"+key}function hasUid(id){var uid=GlobalConfigService.getConfig("uid");return 0===id.indexOf(uid+"::")}var dataService={},noteDB=new PouchDB("note",{size:50,auto_compaction:!0}),folderDB=new PouchDB("folder",{auto_compaction:!0}),configDB=new PouchDB("config",{auto_compaction:!0});return window.LocalEnvironment&&(window.clearNoteDB=function(){noteDB.destroy()},window.clearFolderDB=function(){folderDB.destroy()},window.clearConfigDB=function(){configDB.destroy()}),dataService.clearDB=function(fn){var callback=_.after(3,fn);noteDB.destroy().then(function(){noteDB=new PouchDB("note",{size:50,auto_compaction:!0}),callback()}),folderDB.destroy().then(function(){folderDB=new PouchDB("folder",{auto_compaction:!0}),callback()}),configDB.destroy().then(function(){configDB=new PouchDB("config",{auto_compaction:!0}),callback()})},dataService.getConfig=function(name){var delay=$q.defer();return configDB.get(getId(name)).then(function(doc){delay.resolve(doc.value)}).catch(function(err){delay.resolve(null)}),delay.promise},dataService.updateConfig=function(name,value){configDB.get(getId(name)).then(function(doc){return configDB.put({_id:getId(name),_rev:doc._rev,value:value})}).catch(function(err){404==err.status&&dataService.createConfig(name,value)})},dataService.createConfig=function(name,value){var param={_id:getId(name),value:value};configDB.put(param).catch(function(err){window.console&&window.console.log(err)})},dataService.getUid=function(uid){var delay=$q.defer();return configDB.get("uid").then(function(doc){delay.resolve(doc.uid)}).catch(function(err){delay.resolve(null)}),delay.promise},dataService.updateUid=function(uid){configDB.get("uid").then(function(doc){return configDB.put({_id:"uid",_rev:doc._rev,uid:uid})}).catch(function(err){404==err.status&&dataService.createUid(uid)})},dataService.createUid=function(uid){var param={_id:"uid",uid:uid};configDB.put(param).catch(function(err){window.console&&window.console.log(err)})},dataService.updateVersion=function(value){dataService.updateConfig("version",value)},dataService.getVersion=function(value){return dataService.getConfig("version")},dataService.getNoteList=function(){var delay=$q.defer();return noteDB.allDocs({include_docs:!0,attachments:!0}).then(function(result){var list=[];_.each(result.rows,function(row){hasUid(row.doc._id)&&list.push(row.doc.note)}),delay.resolve(list)}).catch(function(err){window.console&&window.console.log(err)}),delay.promise},dataService.deleteNote=function(note){noteDB.get(getId(note._id)).then(function(doc){return noteDB.remove(doc)}).catch(function(err){window.console&&window.console.log(err)})},dataService.updateNote=function(note){var param={_id:getId(note._id),note:note};noteDB.get(getId(note._id)).then(function(doc){return param._rev=doc._rev,noteDB.put(param)}).catch(function(err){window.console&&window.console.log(err)})},dataService.createNote=function(note){var param={_id:getId(note._id),note:note};noteDB.put(param).catch(function(err){window.console&&window.console.log(err)})},dataService.getFolderList=function(){var delay=$q.defer();return folderDB.allDocs({include_docs:!0,attachments:!0}).then(function(result){var list=[];_.each(result.rows,function(row){hasUid(row.doc._id)&&list.push(row.doc.folder)}),delay.resolve(list)}).catch(function(err){window.console&&window.console.log(err)}),delay.promise},dataService.deleteFolder=function(folder){folderDB.get(getId(folder._id)).then(function(doc){return folderDB.remove(doc)}).catch(function(err){window.console&&window.console.log(err)})},dataService.updateFolder=function(folder){var param={_id:getId(folder._id),folder:folder};folderDB.get(getId(folder._id)).then(function(doc){return param._rev=doc._rev,folderDB.put(param)}).catch(function(err){window.console&&window.console.log(err)})},dataService.createFolder=function(folder){var param={_id:getId(folder._id),folder:folder};folderDB.put(param).catch(function(err){window.console&&window.console.log(err)})},dataService}]),app.factory("OnlineToolService",["$rootScope","$q","ErrorService","GlobalConfigService",function($rootScope,$q,ErrorService,GlobalConfigService){var tabId=GlobalConfigService.TAB_ID,onlineToolService={},POST=function(url,param){var delay=$q.defer();return $.ajax({type:"POST",url:url,dataType:"json",data:param,success:function(msg){1==msg.code?ErrorService.catch(msg):delay.resolve(msg.data)},error:function(){delay.reject("网络异常!")}}),delay.promise};return onlineToolService.clipImage=function(clipInfo){var param={image_name:clipInfo.image_name,x:clipInfo.x,y:clipInfo.y,width:Math.ceil(clipInfo.width),height:Math.ceil(clipInfo.height)};return POST("index.php?r=image/crop",param)},onlineToolService.createWebShareLink=function(note){var rtf_style="{}";_.isString(note.rtf_style)&&(rtf_style=note.rtf_style);var param={title:note.title,content:note.detail,sync_id:note.sync_id,rtf_style:rtf_style,formatting_mode:note.formatting_mode};return POST("/apps/note-share/index.php?r=web/create",param)},onlineToolService.shareWeibo=function(data){var rtf_style="{}";_.isString(data.rtf_style)&&(rtf_style=data.rtf_style);var param={title:data.title,content:data.content,note_content:data.note_content,sync_id:data.sync_id,rtf_style:rtf_style,formatting_mode:data.formatting_mode};return POST("/apps/note-share/index.php?r=web/sendshort",param)},onlineToolService.createShareImage=function(note){var rtf_style="{}";_.isString(note.rtf_style)&&(rtf_style=note.rtf_style);var param={detail:note.detail,sync_id:note.sync_id,rtf_style:rtf_style,formatting_mode:note.formatting_mode,tab_id:tabId};return POST("index.php?r=note/image",param)},onlineToolService}]),void function(){function isRepeat(arr){var hash={};for(var i in arr){if(hash[arr[i]])return arr[i];hash[arr[i]]=!0}return!1}function translate(input,params){var reg=new RegExp(","+input+"::([a-z]+)","i"),key=KEY_STRING.match(reg);if(!key)return window.console&&console.log("%c未找到对应的语言翻译："+input,"color:red"),"error";key=key[1];var val=LANGUAGE[key];return val.replace(/\$\d/g,function(t){return params.length?params.shift():""})}var KEY=["YESTERDAY::yesterday","MONTH::month","FUTURE::future","DAY::day","YEAR::year","TODAY::today","CALL_RECORD::recordInCalling","AFTERNOON::afternoon","MORNING::morning","NO_SEARCH_RESULT::noResult","NO_FAV_RESULT::noFavResult","NO_CALL_RESULT::noCallResult","NO_IMAGE_RESULT::noImgResult","NO_FOLDER_RESULT::noFolderResult","DAY_SUFFIX::daysAgo","FILE_UNSUPPORT::fileUnsupport","IMAGE_OVERSIZE::imageOversize","UPLOAD_IMAGE_FAIL::uploadImageFail","SENSITIVE_WORDS::sensitiveWords","WEIBO_TAIL::weiboTail","DAY_0::day0","DAY_1::day1","DAY_2::day2","DAY_3::day3","DAY_4::day4","DAY_5::day5","DAY_6::day6","RESTORED_TO_ALL::hasBeenRestoredToAll","FOLDER_NAME_CAN_NOT_BE_EMPTY::folderNameCanNotBeEmpty","FOLDER_NAME_MUST_BE_UNIQUE::folderNameMustBeUnique","FOLDER_NUMBER_EXCEEDED::folderNumberExceeded","FOLDER_EXIST_EXCEPTION::folderExistException","EDITOR_WORDS_LEFT::editorWordsLeft","EDITOR_WORDS_EXCEED::editorWordsExceed","IMAGE_TYPE_ERROR::imageTypeError","SHARE_SUCCESS::shareSuccess","DIALOG_RELOGIN_TIP::dialogRelogin","RELOGIN::relogin","LOGIN_TIMEOUT::loginTimeout","CANCEL_BTN::cancelBtn","CONFIRM_BTN::confirmBtn","DELETE_TITLE::deleteTitle","DELETE_NOTE_TIP::deleteNoteTip","FORCE_DELETE_NOTE_TIP::forceDeleteNoteTip"];isRepeat(KEY)&&window.console&&console.log("%cKEY有重复项，重复项位置："+isRepeat(KEY),"color:red");var CN={yesterday:"昨天",future:"未来",month:"月",day:"日",today:"今天",year:"年",afternoon:"下午",morning:"早上",noResult:"搜索结果为空",noFavResult:"无收藏便签",noCallResult:"无通话便签",noImgResult:"无图片便签",noFolderResult:"无便签",recordInCalling:"在 $1 通话中记录",daysAgo:"天前",fileUnsupport:"暂不支持该格式文件",imageOversize:"图片大小超过5M最大限制，请剪裁图片后重试",weiboTail:" （来自锤子便签网页版 http://note.t.tt）",day0:"星期日",day1:"星期一",day2:"星期二",day3:"星期三",day4:"星期四",day5:"星期五",day6:"星期六",sensitiveWords:"抱歉，您的便签中有不适合公开发表的内容，请修改后重试。",uploadImageFail:"上传图片出错",hasBeenRestoredToAll:"便签已恢复至全部便签",folderNameCanNotBeEmpty:"文件夹名称不能为空",folderNameMustBeUnique:"文件夹不能重名",folderNumberExceeded:"文件夹数量已到达上限",folderExistException:"该文件夹不存在，请刷新后重试",editorWordsLeft:"还可以输入 $1 个字",editorWordsExceed:"已超出 $1 个字",imageTypeError:"文件异常，请检查后重试",shareSuccess:"分享成功",dialogRelogin:"您已退出登录，当前操作无法保存，请重新登录后继续使用。",relogin:"重新登录",loginTimeout:"登录超时",confirmBtn:"确认",cancelBtn:"取消",deleteTitle:"删除",deleteNoteTip:"确认要删除选中的便签？",forceDeleteNoteTip:"确认要彻底删除选中的便签？"},EN={$000:"yesterday",$001:"month",$002:"day",$003:"year"},LANGUAGE=CN;app.filter("i18n",["$routeParams","$sce",function($routeParams,$sce){return $routeParams.i18n&&"EN"==$routeParams.i18n&&(LANGUAGE=EN),function(input){var params=Array.prototype.slice.call(arguments,1);return $sce.trustAsHtml(translate(input,params))}}]),app.factory("I18NService",["$routeParams","$sce",function($routeParams,$sce){return $routeParams.i18n&&"EN"==$routeParams.i18n&&(LANGUAGE=EN),function(input){var params=Array.prototype.slice.call(arguments,1);return $sce.trustAsHtml(translate(input,params))}}]);var KEY_STRING=","+KEY.join(",")}(),app.factory("TaskService",["$rootScope",function($rootScope){function taskClass(scope,ctrlName,taskVarName){taskVarName=taskVarName||"task",angular.isUndefined(scope[taskVarName])&&(scope[taskVarName]={}),this.taskScope=scope[taskVarName],this.ctrlName=ctrlName,tasks.ctrlList.push(ctrlName)}var tasks={map:{},ctrlList:[]},asyncTaskActions=[];return window.LocalEnvironment&&(window.showAllTasks=function(){return tasks}),taskClass.prototype.add=function(taskName,taskFunc){var fireTaskName=this.ctrlName+"."+taskName;return tasks.map[fireTaskName]?void(window.console&&console.log("%cTask已存在："+taskName,"color:red")):(tasks.map[fireTaskName]=taskFunc,this.taskScope[taskName]=taskFunc,void $(asyncTaskActions).each(function(){this.fireTaskName==fireTaskName&&this.taskAction(),delete this}))},taskClass.fire=function(fireTaskName){var arr=Array.prototype.slice.call(arguments);return arr.shift(),tasks.map[fireTaskName]?void tasks.map[fireTaskName].apply(null,arr):(window.console&&console.log("%cTask不存在："+fireTaskName,"color:red"),void asyncTaskActions.push({fireTaskName:fireTaskName,taskAction:function(){tasks.map[this.fireTaskName].apply(null,arr)}}))},taskClass.fn=function(scope,ctrlName,taskVarName){return new taskClass(scope,ctrlName,taskVarName)},taskClass.fn.fire=taskClass.fire,taskClass.fn}]),app.factory("GlobalConfigService",["$rootScope",function($rootScope){$rootScope.Global={},$rootScope.Global.noteVersion=null,$rootScope.Global.weiboAuthorize=!1,$rootScope.Global.weiboName="",$rootScope.Global.uid=null,$rootScope.Global.timeDiff=0,$rootScope.Global.column=3;var ALL_FOLDER_ID=0,TRASH_FOLDER_ID=3,FAV_FOLDER_ID=2,CALL_FOLDER_ID=4,FOLDER_NAME_MAX=85,ALT_NAME_MAX=72,SYNC_DELAY_TIME=3e3,NOTE_TITLE_HEIGHT=50,VISIBLE_MAX_LENGTH=30,SINGLE_SELECT="singleSelect",MULTI_SELECT="multiSelect",FOLDER_MAX=100,QUEUE_LOCAL_STORAGE_NAME="cloud_note_queues",TAB_ID=Math.uuid(8),EDITOR_MAX_CONTENT_LENGTH=2e4,NO_MODE=0,MARKDOWN_MODE=2,RTF_MODE=1;return{setConfig:function(key,val){$rootScope.Global[key]=val},getConfig:function(key){return $rootScope.Global[key]},checkSpecialFolder:function(type){var str="."+ALL_FOLDER_ID+".";return str+=TRASH_FOLDER_ID+".",str+=FAV_FOLDER_ID+".",str+=CALL_FOLDER_ID+".",str.indexOf("."+type+".")>-1},ALL_FOLDER_ID:ALL_FOLDER_ID,TRASH_FOLDER_ID:TRASH_FOLDER_ID,FAV_FOLDER_ID:FAV_FOLDER_ID,CALL_FOLDER_ID:CALL_FOLDER_ID,FOLDER_NAME_MAX:FOLDER_NAME_MAX,SYNC_DELAY_TIME:SYNC_DELAY_TIME,NOTE_TITLE_HEIGHT:NOTE_TITLE_HEIGHT,VISIBLE_MAX_LENGTH:VISIBLE_MAX_LENGTH,SINGLE_SELECT:SINGLE_SELECT,MULTI_SELECT:MULTI_SELECT,FOLDER_MAX:FOLDER_MAX,QUEUE_LOCAL_STORAGE_NAME:QUEUE_LOCAL_STORAGE_NAME,TAB_ID:TAB_ID,EDITOR_MAX_CONTENT_LENGTH:EDITOR_MAX_CONTENT_LENGTH,ALT_NAME_MAX:ALT_NAME_MAX,NO_MODE:NO_MODE,MARKDOWN_MODE:MARKDOWN_MODE,RTF_MODE:RTF_MODE}}]),app.factory("LayerService",["$rootScope","UtilService",function($rootScope,UtilService){function show(layerName){layer[layerName].dom.addClass("on"),UtilService.isSafari()&&($(".bottom-menu .create-folder-btn").hide().show(0),$(".a-insert-image").hide().show(0)),layer[layerName].disBodyClick||setTimeout(function(){$("body").one("click",function(){layer[layerName].dom.removeClass("on")})},100)}function hide(layerName){layer[layerName].dom.removeClass("on")}function toggle(layerName){layer[layerName].dom.hasClass("on")?hide(layerName):show(layerName)}var layer={};return $rootScope.layer={show:show,hide:hide,toggle:toggle},{show:show,hide:hide,toggle:toggle,add:function(layerName,dom,disBodyClick){layer[layerName]={dom:dom,disBodyClick:disBodyClick}}}}]),app.factory("ClipImageService",["$rootScope","DialogService","OnlineToolService",function($rootScope,DialogService,OnlineToolService){function init(img,imgSrc){loaded=!0;var height=img.height,width=img.width,originWidth=width;clipWrap=$(".a-clip-image"),layoutDom=clipWrap.find(".clip-wrap"),clipDom=clipWrap.find(".clip-region"),maskDom=clipWrap.find(".clip-mask"),regionImgDom=clipWrap.find(".clip-region-img"),imgDom=clipWrap.find("img"),width/maxWidth>height/maxHeight?width>maxWidth&&(height=parseInt(maxWidth/width*height),width=maxWidth):height>maxHeight&&(width=parseInt(maxHeight/height*width),height=maxHeight),scale=originWidth/width,oWidth=width,oHeight=height,clipH=height,clipW=width,clipY=0,clipX=0,imgDom.attr("src",imgSrc).css({height:height,width:width}),layoutDom.css({marginLeft:(414-width)/2+20}),clipDom.css({height:height,width:width,top:0,left:0}),regionImgDom.css({top:0,left:0}),maskDom.css({height:height,width:width}),clipWrap.find(".clip-pointer").off().on("mousedown",function(event){loaded&&(press=!0,pointerPos=$(this).data("type"),pressX=event.pageX,pressY=event.pageY)}),imgDom.off().on("dragstart",function(event){event.preventDefault()})}function clipRange(min,max,num){return num>max?max:num<min?min:num}var clipWrap,layoutDom,clipDom,maskDom,regionImgDom,imgDom,maxHeight=416,maxWidth=416,pointerVectorMap={"left-top":[-1,-1,1,1],"left-mid":[-1,0,1,0],"left-bottom":[-1,1,1,0],"mid-top":[0,-1,0,1],"mid-bottom":[0,1,0,0],"right-top":[1,-1,0,1],"right-mid":[1,0,0,0],"right-bottom":[1,1,0,0]},pointerPos=null,press=!1,clipH=0,clipW=0,clipY=0,clipX=0,oWidth=0,oHeight=0,loaded=!1,scale=1,pressX=0,pressY=0;return $("body").on("mousemove",function(event){if(press){var vector=pointerVectorMap[pointerPos],moveX=event.pageX-pressX,moveY=event.pageY-pressY,newClipW=clipW+moveX*vector[0],newClipH=clipH+moveY*vector[1],newClipX=clipX+moveX*vector[2],newClipY=clipY+moveY*vector[3];newClipW=clipRange(50,oWidth*(vector[0]+vector[2])+clipW*vector[2]-clipX*vector[0],newClipW),newClipH=clipRange(50,oHeight*(vector[1]+vector[3])+clipH*vector[3]-clipY*vector[1],newClipH),newClipW=0==vector[0]?clipW:newClipW,newClipH=0==vector[1]?clipH:newClipH,newClipX=clipRange(0,clipX+clipW-50,newClipX),newClipY=clipRange(0,clipY+clipH-50,newClipY),clipDom.css({height:newClipH,width:newClipW,top:newClipY,left:newClipX}),regionImgDom.css({top:-newClipY,left:-newClipX})}}),$("body").on("mouseup",function(event){if(press){var vector=pointerVectorMap[pointerPos],moveX=event.pageX-pressX,moveY=event.pageY-pressY,tmpClipW=clipW+moveX*vector[0],tmpClipH=clipH+moveY*vector[1],tmpClipX=clipX+moveX*vector[2],tmpClipY=clipY+moveY*vector[3];tmpClipW=clipRange(50,oWidth*(vector[0]+vector[2])+clipW*vector[2]-clipX*vector[0],tmpClipW),tmpClipH=clipRange(50,oHeight*(vector[1]+vector[3])+clipH*vector[3]-clipY*vector[1],tmpClipH),tmpClipW=0==vector[0]?clipW:tmpClipW,tmpClipH=0==vector[1]?clipH:tmpClipH,tmpClipX=clipRange(0,clipX+clipW-50,tmpClipX),tmpClipY=clipRange(0,clipY+clipH-50,tmpClipY),clipW=tmpClipW,clipH=tmpClipH,clipX=tmpClipX,clipY=tmpClipY,press=!1}}),{clip:function(imgSrc,callback){var preloadImg=new Image;preloadImg.src=imgSrc,$(preloadImg).one("load",function(){init(this,imgSrc)}).each(function(){this.complete&&$(this).trigger("load")}),DialogService.open("ClipImage",function(){var clipRegionDom=$(".clip-region"),x=parseInt(clipRegionDom.css("left"),10),y=parseInt(clipRegionDom.css("top"),10),width=parseInt(clipRegionDom.css("width"),10),height=parseInt(clipRegionDom.css("height"),10),image_name=imgSrc.split("/");image_name=image_name[image_name.length-1];var data={image_name:image_name,x:Math.floor(x*scale),y:Math.floor(y*scale),width:Math.floor(width*scale),height:Math.floor(height*scale)};OnlineToolService.clipImage(data).then(function(data){callback(data.file_name,data.width,data.height)}),DialogService.close()})}}}]),app.factory("EditorService",["$timeout","DialogService","TaskService","ImageStringService","EditorImageDecodeService","EditorImageDragService","EditorToolService","EmojiService","GlobalConfigService","ScrollBarService","UtilService","RtfService",function($timeout,DialogService,TaskService,ImageStringService,EditorImageDecodeService,EditorImageDragService,EditorToolService,EmojiService,GlobalConfigService,ScrollBarService,UtilService,RtfService){function scrollerCheck(){var top=editor.charCoords(editor.getCursor()).top,scrollTop=ScrollBarService.getScrollTop("EditWrap");top<113&&(ScrollBarService.scrollTop("EditWrap",top-113+scrollTop),ScrollBarService.update("EditWrap"))}function clearInlineStyleFollowStatus(){_inlineStyleFollowStatus.info={}}function setCursor(pageY){var list=$(".CodeMirror-code").children(":not(.cm-placeholder)"),len=list.length,lineNo=EditorToolService.getLineNoByPageY(pageY),pos=CodeMirror.Pos(lineNo+1,0);lineNo==len&&(pos=CodeMirror.Pos(lineNo-1,0)),editor.setCursor(pos)}function resetCursorPos(){setTimeout(function(){editor.refresh()},400)}function delayEnabledSave(){_disabledSave=!0,setTimeout(function(){_disabledSave=!1},200)}function btnStatusRefresh(){if(_isFoucs){var rtfBtnStatus=RtfService.getRtfBtnStatus(editor,defaultRtfBtnStatus,_inlineStyleFollowStatus);TaskService.fire("NoteEditCtrl.changeRtfBtnStatus",rtfBtnStatus)}else TaskService.fire("NoteEditCtrl.changeRtfBtnStatus",defaultRtfBtnStatus)}function isRtfMode(){return 1==_editMode}function addStyle(styleName,ifToggle){if(_isFoucs){if(styleName.indexOf(TODO)>-1&&!ifToggle){var rtfBtnStatus=RtfService.getRtfBtnStatus(editor,defaultRtfBtnStatus,_inlineStyleFollowStatus);rtfBtnStatus.TODO===ACTIVE_STATUS&&rtfBtnStatus.TODO_CHECKED===NORMAL&&(styleName=TODO),rtfBtnStatus.todo===NORMAL&&rtfBtnStatus.todo_checked===ACTIVE_STATUS&&(styleName=TODO_CHECKED)}RtfService.addStyle(editor,styleName,_inlineStyleFollowStatus),setTimeout(function(){btnStatusRefresh(),TaskService.fire("NoteEditCtrl.noteChange",!1)},100),EditorToolService.decodeEmoji(editor)}}function isRTFEmptyStyle(){var ret=!0;if(_editMode===GlobalConfigService.RTF_MODE){var style=RtfService.getStyleData(editor);style&&""!=style&&(style=RtfService.toJson(style),angular.forEach(style,function(value,key){value&&angular.forEach(value,function(v,k){if("type"===k&&1!=v&&2!=v&&(ret=!1),k&&"type"!=k&&"length"!=k&&"content"!=k&&(angular.isArray(v)&&v.length>0||angular.isNumber(v)&&0!=v||angular.isString(v)&&""!=v)&&(ret=!1),!ret)return ret})}))}return ret}var TODO="todo",TODO_CHECKED="todo_checked",NORMAL="normal",ACTIVE_STATUS="active",_editorService={},_isFoucs=!1,_editMode=0,defaultRtfBtnStatus={todo:"normal",todo_checked:"normal",bold:"normal",ul:"normal",quote:"normal",center:"normal",head:"normal"},_inlineStyleFollowStatus={info:{}},_disabledSave=!1,editor=CodeMirror(document.getElementById("editor"),{lineWrapping:!0,cursorHeight:.4,dragDrop:!1,_noteInputMarginTop:20,smartIndent:!1,electricChars:!1}),keyMap={Tab:function(cm){cm.replaceSelection("")},Left:function(cm){var pos=cm.getCursor(),lineHandler=editor.getLineHandle(pos.line);lineHandler&&lineHandler.wrapClass&&lineHandler.wrapClass.indexOf("img-line")>-1?cm.moveV(-1,"line"):cm.moveH(-1,"char")},"Ctrl-Left":function(cm){var pos=cm.getCursor(),lineHandler=editor.getLineHandle(pos.line);lineHandler&&lineHandler.wrapClass&&lineHandler.wrapClass.indexOf("img-line")>-1?cm.moveV(-1,"line"):cm.moveH(-1,"group")},Enter:function(cm){if(isRtfMode()){var cursor=cm.listSelections();if(cursor.length>1)return void cm.replaceSelection("\n","end");RtfService.preInput(cm,cursor[0].head.line,function(){btnStatusRefresh(),TaskService.fire("NoteEditCtrl.noteChange")})}else cm.replaceSelection("\n","end")},Backspace:function(cm){isRtfMode()?(RtfService.deleteKeyHandler(cm),TaskService.fire("NoteEditCtrl.noteChange")):cm.deleteH(-1,"char");
}};return keyMap["Shift-Backspace"]=keyMap.Backspace,editor.setOption("extraKeys",keyMap),window.LocalEnvironment&&(window.editor678=editor),EditorImageDragService.setEditor(editor,function(){_disabledSave=!1},function(){_disabledSave=!0}),$(window).on("keydown",function(event){var imgDom=$(".edit-wrap .img-line-on");if(imgDom.length>0){if(8==event.keyCode)return 0===$(".a-dialog-wrap.on").length&&$(".edit-wrap .img-line-on .delete").eq(0).click(),event.preventDefault&&event.preventDefault(),event.returnValue=!1,!1;if(46==event.keyCode)return 0===$(".a-dialog-wrap.on").length&&$(".edit-wrap .img-line-on .delete").eq(0).click(),event.preventDefault&&event.preventDefault(),event.returnValue=!1,!1}}),$("body").on("click",function(event){0===$(event.target).parents("img-line").length&&$(".edit-wrap .img-line").removeClass("img-line-on"),isRtfMode()&&(clearInlineStyleFollowStatus(),btnStatusRefresh())}),editor.on("beforeSelectionChange",function(cm,changeObj){if($(".edit-wrap .img-line").removeClass("img-line-on"),!(changeObj.ranges.length>1)){setTimeout(function(){scrollerCheck()},10);var range=changeObj.ranges[0];if(range.head.line==range.anchor.line&&range.head.ch==range.anchor.ch&&("*mouse"==changeObj.origin||"+move"==changeObj.origin)){var line=editor.getLineHandle(range.anchor.line);if(ImageStringService.hasImage(line.text)){if(range.head.ch!==line.text.length){var pos={line:range.head.line,ch:line.text.length};changeObj.update([{anchor:pos,head:pos}])}$(line.widgets[0].node).parents(".img-line").addClass("img-line-on")}}if(range.head.line==range.anchor.line&&range.head.ch!=range.anchor.ch&&("*mouse"==changeObj.origin||"+move"==changeObj.origin)){var line=editor.getLineHandle(range.anchor.line);ImageStringService.hasImage(line.text)&&(changeObj.update([{anchor:range.anchor,head:range.anchor}]),$(line.widgets[0].node).parents(".img-line").addClass("img-line-on"))}if(range.head.line!=range.anchor.line){var cursor=editor.getCursor(),line=editor.getLineHandle(range.head.line);if(ImageStringService.hasImage(line.text))if(range.head.line>range.anchor.line){var pos={line:range.head.line+1,ch:0};cursor.line>range.head.line&&(line=editor.getLineHandle(range.head.line-1),pos=ImageStringService.hasImage(line.text)?{line:range.head.line,ch:0}:{line:range.head.line-1}),changeObj.update([{anchor:range.anchor,head:pos}])}else if(0!==range.head.ch){var pos={line:range.head.line,ch:0};cursor.line==range.head.line&&cursor.ch<range.head.ch&&(pos={line:range.head.line+1,ch:0}),changeObj.update([{anchor:range.anchor,head:pos}])}line=editor.getLineHandle(range.anchor.line),ImageStringService.hasImage(line.text)&&(changeObj.update([{anchor:range.anchor,head:range.anchor}]),$(line.widgets[0].node).parents(".img-line").addClass("img-line-on"))}}}),editor.on("beforeChange",function(cm,changeObj){"+delete"==changeObj.origin&&EditorToolService.imgMayBeChange(cm,changeObj,!0)&&changeObj.cancel(),"paste"!=changeObj.origin&&"+input"!=changeObj.origin&&"*compose"!=changeObj.origin||EditorToolService.imgMayBeChange(cm,changeObj)&&changeObj.cancel();var beforeSum=EditorToolService.wordsCount(editor);if(0===editor.getSelection().length&&GlobalConfigService.EDITOR_MAX_CONTENT_LENGTH-beforeSum<=0&&("paste"==changeObj.origin||"+input"==changeObj.origin||"*compose"==changeObj.origin))return void changeObj.cancel()}),editor.on("change",function(cm,changeObj){ScrollBarService.update("EditWrap"),EditorToolService.polishContent(editor),EditorToolService.decodeEmoji(editor),EditorToolService.highLight(editor),(ImageStringService.hasImage(changeObj.removed.join(""))||ImageStringService.hasImage(changeObj.text.join("")))&&EditorImageDecodeService(editor),"paste"==changeObj.origin&&setTimeout(function(){editor.refresh()},1),setTimeout(function(){TaskService.fire("NoteEditCtrl.noteChange",_disabledSave)},10)}),editor.on("beforeSelectionChange",function(cm,changeObj){if(isRtfMode()){var range=changeObj.ranges[0];range.head.line==range.anchor.line&&range.head.ch==range.anchor.ch||clearInlineStyleFollowStatus();editor.listSelections();setTimeout(function(){btnStatusRefresh(),RtfService.symbolConvertStyle(editor)},1)}}),editor.on("change",function(cm,changeObj){if(isRtfMode()&&("paste"==changeObj.origin||"+input"==changeObj.origin||"*compose"==changeObj.origin)){if(changeObj.text.length>1)return;var from=changeObj.from.ch,text=(changeObj.to.ch,changeObj.text[0]),removeRange=(changeObj.removed[0],[]),addRange=[];text.length>0&&addRange.push({from:{line:changeObj.from.line,ch:from},to:{line:changeObj.from.line,ch:from+text.length}}),RtfService.followModel(cm,addRange,removeRange,_inlineStyleFollowStatus),EditorToolService.decodeEmoji(cm)}}),editor.on("focus",function(){setTimeout(function(){_disabledSave=!1},100),_isFoucs=!0,TaskService.fire("NoteEditCtrl.editorFocus"),clearInlineStyleFollowStatus(),btnStatusRefresh()}),editor.on("blur",function(){_isFoucs=!1,TaskService.fire("NoteEditCtrl.editorBlur"),btnStatusRefresh()}),$(document).on("dragleave drop dragenter dragover",function(event){var evt=event?event:window.event;return evt.preventDefault&&evt.preventDefault(),evt.returnValue=!1,!1}),$(".note-editor").on("drop",function(e){setTimeout(function(){setCursor(e.pageY)},1)}),_editorService={setValue:function(noteContent,styleData){delayEnabledSave(),noteContent=EditorToolService.removeSpecialChar(noteContent),isRtfMode()?(editor.setValue(""),setTimeout(function(){var noteContentAfterSplitImage=ImageStringService.splitImage(noteContent);editor.setValue(noteContentAfterSplitImage),RtfService.setStyleData(editor,styleData,noteContent),EditorToolService.decodeEmoji(editor)},10)):(noteContent=ImageStringService.splitImage(noteContent),editor.setValue(""),setTimeout(function(){editor.setValue(noteContent)},10)),setTimeout(function(){editor.refresh()},100)},insertImage:function(imageObj){var pos=editor.getCursor();0===pos.ch?this.insertText(ImageStringService.getEncodeImageStr(imageObj)+"\n"):(pos.ch=null,editor.setCursor(pos),this.insertText("\n"+ImageStringService.getEncodeImageStr(imageObj))),EditorToolService.blur(editor)},insertText:function(text){var pos=editor.getCursor();editor.replaceRange(text,pos,pos)},wordsCount:function(){return EditorToolService.wordsCount(editor)},getValue:function(){var noteContent=EditorToolService.getDetail(editor);return noteContent},getStyle:function(){return RtfService.getStyleData(editor)},setCursor:setCursor,setHistory:function(history){history?editor.setHistory(history):editor.clearHistory()},getHistory:function(){return editor.getHistory()},hightLight:function(){EditorToolService.highLight(editor)},refresh:function(noteContent,styleData){var content=this.getValue(),style=this.getStyle();content==noteContent&&style==styleData||this.setValue(noteContent,styleData)},addStyle:addStyle,hideStyle:function(){var value=this.getValue(),self=this;this.setValue(""),setTimeout(function(){self.setValue(value)},1)},showStyle:function(note){this.refresh(note.detail,note.rtf_style)},setMode:function(val){RtfService.setMode(val),_editMode=val},getMode:function(){return _editMode},toggleRtfTodo:function(ifChecked){var style;style=ifChecked?"todo_"+ifChecked:"todo",_isFoucs=!0,btnStatusRefresh(),addStyle(style,!0)},resetCursorPos:resetCursorPos,isRTFEmptyStyle:isRTFEmptyStyle}}]),app.factory("EditorImageDecodeService",["EditorHardWrapService","ImageStringService","EditorToolService","EditorImageEditService","UtilService","EmojiService","StatusService",function(EditorHardWrapService,ImageStringService,EditorToolService,EditorImageEditService,UtilService,EmojiService,StatusService){function getID(){return id++}function imageConvert(editor){var highLightKeyword=StatusService.getValue(StatusService.name.CUR_KEYWORD);_.isString(highLightKeyword)||(highLightKeyword=""),editor.eachLine(function(line){if(ImageStringService.hasImage(line.text)&&!(line.widgets&&line.widgets.length>0)){var attrs=ImageStringService.getImageAttr(line.text);if(attrs){var height=parseInt(attrs.height,10),alt=(parseInt(attrs.width),ImageStringService.decodeHtmlSymbol(attrs.describe));alt=UtilService.subMixString(alt,72),alt=ImageStringService.encodeHtmlSymbol(alt);var src=ImageStringService.imagePath(attrs.name),hasAlt=alt.length>0,lineNo=line.lineNo(),imgID="img"+getID();editor.addLineClass(lineNo,"wrap","img-line"),editor.addLineClass(lineNo,"text","hide");var imgHTML='<div class="cm-img" id="'+imgID+'"><div class="cm-img-line-mask"></div><div class="cm-img-wrap" data-line="'+lineNo+'"><div class="cm-img-loading"></div><div class="cm-img-con"><div class="cm-img-edit-bar first"><div class="bar-bg"></div><div class="item clip"></div><div class="item edit-alt"></div><div class="item delete"></div></div><div class="cm-img-edit-bar last"><div class="bar-bg"></div><div class="item clip"></div><div class="item edit-alt"></div><div class="item delete"></div></div><img width="540" src="'+src+'"></div><div class="cm-img-alt '+(hasAlt?"on":"")+'">'+altToHtml(alt,highLightKeyword)+"</div></div></div>";editor.addLineWidget(lineNo,$(imgHTML)[0]);var replaceDom=$(EmojiService.toImage("🏝"));replaceDom.css("width",560),editor.markText({line:lineNo,ch:0},{line:lineNo,ch:line.text.length},{replacedWith:replaceDom[0],handleMouseEvents:!0});var imgWrap=$("#"+imgID).css("visibility","hidden"),height=imgWrap.find(".cm-img-alt").height();height>50&&imgWrap.find(".cm-img-alt").css("textAlign","left"),EditorToolService.imageVerticalMiddle(editor,imgWrap,line),imgWrap.find("img").one("load",function(){imgWrap.find(".cm-img-con").show(),imgWrap.find(".cm-img-loading").hide(),EditorToolService.imageVerticalMiddle(editor,imgWrap,line),imgWrap.parents(".edit-wrap").length>0&&EditorImageEditService.addImageEditEvent(editor,imgWrap,line)}).each(function(){this.complete&&$(this).trigger("load")})}}}),$("img").off("dragstart.editor").on("dragstart.editor",function(event){event.preventDefault()}),$(".edit-wrap").on("click",".img-line",function(event){var pageY=event.pageY,offsetTop=$(this).offset().top,height=$(this).height(),offsetBottom=offsetTop+height,lineNo=EditorToolService.getLineNoByPageY(pageY);pageY-offsetTop>0&&pageY-offsetTop<15&&$(this).prev().hasClass("img-line")&&editor.replaceRange("\n",{line:lineNo-1},{line:lineNo-1}),offsetBottom-pageY>0&&offsetBottom-pageY<15&&$(this).next().hasClass("img-line")&&editor.replaceRange("\n",{line:lineNo},{line:lineNo})})}function altToHtml(alt,highLightKeyword){if(highLightKeyword.length>0){highLightKeyword=ImageStringService.encodeHtmlSymbol(highLightKeyword);var reg=new RegExp(highLightKeyword.replace(/([\-!$%^&*()_+|~=`{}\[\]:";'<>?,.\/])/g,"\\$1"),"g");alt=alt.replace(reg,'<span class="highlight">'+highLightKeyword+"</span>")}return alt=EmojiService.toImage(alt)}var id=0;$(".edit-wrap .CodeMirror-cursors");return imageConvert}]),app.factory("EditorHardWrapService",["GlobalConfigService","RtfService",function(GlobalConfigService,RtfService){function lineNoInSelections(lineNo,Selections){var index=-1;return _.each(Selections,function(seleciton,i){seleciton.anchor.line==lineNo&&(index=i)}),index}function hardWrap(editor,curStyleData){var hardWrapMap={},breakPoints=findWrapBreakPointsInParagraph(editor);if(0===breakPoints.length)return hardWrapMap;var selections=[],replaces=[];_.each(breakPoints,function(val){selections.push({anchor:val,head:val}),replaces.push("\n")}),editor.setSelections(selections),editor.replaceSelections(replaces);var selections=editor.listSelections(),add=0;return editor.eachLine(function(line){var lineNo=line.lineNo(),index=lineNoInSelections(lineNo,selections);if(index>-1){var originLineNo=breakPoints[index].line,originCh=breakPoints[index].ch;hardWrapMap["n"+(lineNo-1)]={orignLineNo:originLineNo,ch:originCh},add++,breakPoints[index+1]&&breakPoints[index+1].line===originLineNo||(hardWrapMap["n"+lineNo]={orignLineNo:originLineNo,ch:-1})}else hardWrapMap["n"+lineNo]={orignLineNo:lineNo-add,ch:-1}}),RtfService.isRtfMode()&&_.each(selections,function(val,i){var curLine=val.anchor.line,originLine=breakPoints[i].line;RtfService.mockStyle(editor,curLine,originLine,curStyleData)}),hardWrapMap}function findWrapBreakPointsInParagraph(editor){var breakPoints=[];return editor.doc.eachLine(function(line){for(var lineNo=line.lineNo(),startTop=0,i=0;i<line.styles[1];i++){var top=editor.charCoords({line:lineNo,ch:i}).top;0==i&&(startTop=top),startTop<top&&(startTop=top,breakPoints.push(CodeMirror.Pos(lineNo,i)))}}),breakPoints}return function(editor,styleData){return hardWrap(editor,styleData)}}]),app.factory("EditorImageDragService",["EditorHardWrapService","EditorToolService","EditorImageDecodeService","GlobalConfigService","RtfService","TaskService","ImmersiveModeService",function(EditorHardWrapService,EditorToolService,EditorImageDecodeService,GlobalConfigService,RtfService,TaskService,ImmersiveModeService){function moveLineTo(lineNo){var lines=$(".edit-wrap .note-editor .CodeMirror-code").children(":not(.cm-placeholder)");return lines.css({"margin-top":0,"margin-bottom":0}),lineNo===-1?void lines.eq(0).css("margin-top",50):void lines.eq(lineNo).css("margin-bottom",50)}function editorScroll(direction){setTimeout(function(){var moveDistance=SCROLL_SPEED*direction;editorWrap.scrollTop=editorWrap.scrollTop+moveDistance,$(window).scrollTop($(window).scrollTop()+moveDistance),isMoving&&scrollstatus&&editorScroll(direction)},30)}function getLineNoByY(mouseOnEditorY){var lineNo=null,directDistance=0;if(null===oldMouseOnEditorY)return void(oldMouseOnEditorY=mouseOnEditorY);directDistance=oldMouseOnEditorY>mouseOnEditorY?-50:0,oldMouseOnEditorY=mouseOnEditorY,mouseOnEditorY+=directDistance;var list=$(".edit-wrap .note-editor .CodeMirror-code").children(":not(.cm-placeholder)"),len=list.length;return list.each(function(i){var top=$(this).offset().top-editorStartTop+editorWrap.scrollTop,topB=top+$(this).height();if(0==i&&mouseOnEditorY<top&&(lineNo=-1,""===$.trim(editor.getLineHandle(0).text)&&(lineNo=0)),mouseOnEditorY>=top&&mouseOnEditorY<topB)return lineNo=i,lineNo===len-1&&(lineNo=len-2),!1}),lineNo}function moveImageBar(pos){if(isPress){if(pos<0)return void imageBar.css({top:pos});var scrollTop=$(window).scrollTop();pos-=scrollTop;var top=pos;pos<limitTop&&(scrollstatus=!0,editorScroll(UPWARD)),pos>limitBottom&&(scrollstatus=!0,editorScroll(DOWNWARD)),pos>limitTop&&pos<limitBottom&&(scrollstatus=!1),pos<limitTop&&(top=limitTop),pos>limitBottom&&(top=limitBottom),imageBar.css({top:top-25,left:imageBarLeft})}}function dragImage(mouseY){var mouseOnEditorY=mouseY-editorStartTop+editorWrap.scrollTop,lineNo=getLineNoByY(mouseOnEditorY);moveImageBar(mouseY),$.isNumeric(lineNo)&&lineNo!==curDragLineNo&&(curDragLineNo=lineNo,moveLineTo(curDragLineNo))}function isRtfMode(){return RtfService.isRtfMode()}function reset(){$(".edit-wrap .note-editor .CodeMirror-code").removeClass("draging"),curDragLineNo=null,oldEditorContent=null,hardWrapMap={},moveImageBar(-1e4),isPress=!1,isMoving=!1,imgDom=null}function isLeftClick(event){var isRightclick,e=event||window.event;return e.which?isRightclick=3==e.which:e.button&&(isRightclick=2==e.button),!isRightclick}function dropImage(){if($.isNumeric(curDragLineNo))if(editor.setValue(curEditorContent),curDragLineNo===-1)editor.replaceRange(imgContent+"\n",{line:0,ch:0},{line:0,ch:0});else{var lineNo=curDragLineNo,ch=-1;hardWrapMap["n"+curDragLineNo]&&(lineNo=hardWrapMap["n"+curDragLineNo].orignLineNo,ch=hardWrapMap["n"+curDragLineNo].ch),ch===-1?editor.replaceRange(imgContent+"\n",{line:lineNo+1,ch:0},{line:lineNo+1,ch:0}):editor.replaceRange("\n"+imgContent+"\n",{line:lineNo,ch:ch},{line:lineNo,ch:ch})}else editor.setValue(oldEditorContent);_enabledSave&&_enabledSave(),TaskService.fire("NoteEditCtrl.noteChange"),reset()}function dropImageWithRTF(){editor.setValue(""),setTimeout(function(){if($.isNumeric(curDragLineNo))if(editor.setValue(curEditorContent),RtfService.setStyleData(editor,curEditorStyle,curEditorContent),curDragLineNo===-1)editor.replaceRange(imgContent+"\n",{line:0,ch:0},{line:0,ch:0});else{var lineNo=curDragLineNo,ch=-1;hardWrapMap["n"+curDragLineNo]&&(lineNo=hardWrapMap["n"+curDragLineNo].orignLineNo,ch=hardWrapMap["n"+curDragLineNo].ch),ch===-1?editor.replaceRange(imgContent+"\n",{line:lineNo+1,ch:0},{line:lineNo+1,ch:0}):(editor.replaceRange("\n"+imgContent+"\n",{line:lineNo,ch:ch},{line:lineNo,ch:ch}),RtfService.cloneStyle(editor,lineNo,lineNo+2))}else editor.setValue(oldEditorContent),RtfService.setStyleData(editor,oldEditorStyle);_enabledSave&&_enabledSave(),TaskService.fire("NoteEditCtrl.noteChange"),reset()},10)}function readyBeforeDrag(moveY){var lineNo=EditorToolService.getLineNoByImageDom(imgDom);imgContent=editor.getLine(lineNo),oldEditorContent=editor.getValue(),EditorToolService.clearLine(editor,lineNo),curEditorContent=editor.getValue(),hardWrapMap=EditorHardWrapService(editor),moveImageBar(moveY),imageBar.find(".img").css({height:34}),$(".edit-wrap .note-editor .CodeMirror-code").addClass("draging")}function readyBeforeDragWithRTF(moveY){var lineNo=EditorToolService.getLineNoByImageDom(imgDom);imgContent=editor.getLine(lineNo),oldEditorContent=editor.getValue(),oldEditorStyle=RtfService.getStyleData(editor),EditorToolService.clearLine(editor,lineNo),curEditorContent=editor.getValue(),curEditorStyle=RtfService.getStyleData(editor),hardWrapMap=EditorHardWrapService(editor,curEditorStyle),moveImageBar(moveY),imageBar.find(".img").css({height:34}),$(".edit-wrap .note-editor .CodeMirror-code").addClass("draging")}function pressReady($dom){imageBarLeft=1==ImmersiveModeService.getImmersiveMode()?$(".edit-wrap").offset().left+50:$(".note-left").width()+50,imageBar.find(".img").css({height:$dom.height(),backgroundImage:"url("+$dom.attr("src")+")"}),imgDom=$dom}var editor,_enabledSave,_disabledSave,hardWrapMap={},curEditorContent="",oldEditorContent="",curEditorStyle="",oldEditorStyle="",imgContent="",curDragLineNo=null,isPress=!1,isMoving=!1,editorStartTop=140,limitTop=editorStartTop-10,limitBottom=$(window).height()-50,imgDom=null,scrollstatus=!1,editorWrap=$(".edit-wrap-scroller")[0],oldMouseOnEditorY=null;$(window).on("resize",function(){limitBottom=$(window).height()-50}),$("body").append('<div class="cm-image-copy"><div class="img"></div></div>');var imageBar=$(".cm-image-copy"),imageBarLeft=0,SCROLL_SPEED=4,UPWARD=-1,DOWNWARD=1;return $(document).on("mouseup",function(event){if(isLeftClick(event))return isMoving?void(isRtfMode()?dropImageWithRTF():dropImage()):void(isPress=!1)}),$(document).on("mousemove",function(event){var moveY=event.pageY;isPress&&!isMoving&&(isRtfMode()?readyBeforeDragWithRTF(moveY):readyBeforeDrag(moveY),isMoving=!0),isPress&&isMoving&&dragImage(moveY)}),$(".note-editor").on("mousedown",".cm-img-con img",function(event){isLeftClick(event)&&(pressReady($(this)),isPress=!0,_disabledSave&&_disabledSave())}),{setEditor:function(oEditor,enabledSave,disabledSave){editor=oEditor,_enabledSave=enabledSave,_disabledSave=disabledSave}}}]),app.factory("EditorImageEditService",["EditorToolService","TaskService","EmojiService","UtilService","AnimationService","ImageStringService","DialogService","ScrollBarService","GlobalConfigService",function(EditorToolService,TaskService,EmojiService,UtilService,AnimationService,ImageStringService,DialogService,ScrollBarService,GlobalConfigService){function creatAltInputField(){altEditor=CodeMirror($(".alt-input")[0],{lineWrapping:!0,cursorHeight:.65,dragDrop:!1,scrollbarStyle:"null"}),altEditor.on("blur",function(){altEditor.isPressEditAltBtn||setTimeout(function(){$(".alt-input").css({left:-3e3});var val=UtilService.subMixString(altEditor.getValue(),GlobalConfigService.ALT_NAME_MAX);saveImgDescribe&&saveImgDescribe(val),saveImgDescribe=null,altEditor.setValue("")},100)}),EditorToolService.singleLineInputCtrl({editor:altEditor,wordCount:function(text){return UtilService.getMixStringLength(text)},subString:function(text,len){return UtilService.subMixString(text,len)},maxLength:GlobalConfigService.ALT_NAME_MAX,afterInput:function(){var pos=altEditor.posFromIndex(altEditor.getValue().length),top1=altEditor.charCoords({line:0,ch:0}).top,top2=altEditor.charCoords(pos).top;top2>top1&&$(".alt-input").css({height:69})}}),$(".alt-input").css({top:0,left:-3e3})}function showAltInputField(altDom,imageStr,callback){var text=ImageStringService.getImageAttr(imageStr).describe;text=ImageStringService.decodeHtmlSymbol(text);var EditorOffsetTop=$(".note-editor").offset().top,top=altDom.offset().top,height=altDom.innerHeight();altEditor.setValue(text);var scrollTop=$(".edit-wrap").scrollTop();$(".alt-input").css({top:top-EditorOffsetTop,width:altDom.width(),left:50,height:height-1}),setTimeout(function(){altEditor.setCursor({line:0,ch:100}),altEditor.focus(),$(".edit-wrap").scrollTop(scrollTop),callback()},10)}function imageEvent(editor,$imageWrapDom,lineHandle){mainEditor=editor;var firstBar=$imageWrapDom.find(".cm-img-edit-bar.first"),lastBar=$imageWrapDom.find(".cm-img-edit-bar.last"),height=$imageWrapDom.find(".cm-img-con").height();$imageWrapDom.find(".cm-img-wrap").off().on("mousemove",function(event){var pageY=event.pageY,topPos=$(this).offset().top,wHeight=$(window).height(),bottomPos=topPos+height+20;topPos<60&&bottomPos<=wHeight&&(lastBar.addClass("on"),firstBar.removeClass("on")),bottomPos>wHeight&&topPos>=60&&(firstBar.addClass("on"),lastBar.removeClass("on")),bottomPos>wHeight&&topPos<60&&(lastBar.addClass("on"),firstBar.removeClass("on")),bottomPos<=wHeight&&topPos>=60&&(height<=400||pageY>topPos+height/2?(lastBar.addClass("on"),firstBar.removeClass("on")):(firstBar.addClass("on"),lastBar.removeClass("on")))}).on("mouseout",function(event){firstBar.removeClass("on"),lastBar.removeClass("on")}),$imageWrapDom.find(".clip").off().on("click",function(event){event.stopPropagation?event.stopPropagation():event.cancelBubble=!0;var imgSrc=$imageWrapDom.find("img").attr("src");TaskService.fire("NoteEditCtrl.clipImage",imgSrc,function(fileName,width,height){var name=ImageStringService.encodeHtmlSymbol(fileName),imageStr=lineHandle.text,lineNo=lineHandle.lineNo();imageStr=ImageStringService.setAttr(imageStr,"name",name),lineHandle.widgets&&lineHandle.widgets.length>0&&lineHandle.widgets[0].clear(),EditorToolService.replaceLine(editor,lineNo,imageStr)})}),$imageWrapDom.find(".delete").off().on("click",function(event){event.stopPropagation?event.stopPropagation():event.cancelBubble=!0,DialogService.open("DeleteImage",function(){var imgWrap=$(lineHandle.widgets[0].node).parents(".img-line");imgWrap.length>0&&AnimationService.action("deleteImage")(imgWrap,function(){EditorToolService.clearLine(editor,lineHandle.lineNo()),ScrollBarService.update("EditWrap")}),DialogService.close()})}),$imageWrapDom.find(".edit-alt").off().on("mousedown",function(event){var val=UtilService.subMixString(altEditor.getValue(),GlobalConfigService.ALT_NAME_MAX);saveImgDescribe&&saveImgDescribe(val),saveImgDescribe=null,altEditor.setValue(""),altEditor.isPressEditAltBtn=!0,setTimeout(function(){altEditor.isPressEditAltBtn=!1},20);var altDom=$imageWrapDom.find(".cm-img-alt");altDom.hasClass("on")||(altDom.addClass("on"),altDom.parents(".cm-img").css("paddingBottom",50)),altDom.css("visibility","hidden"),showAltInputField(altDom,lineHandle.text,function(){saveImgDescribe=function(des){altDom.css("visibility","visible"),0===$.trim(des).length&&(altDom.removeClass("on"),altDom.parents(".cm-img").css("paddingBottom",0));var describe=ImageStringService.encodeHtmlSymbol(des),imageStr=lineHandle.text,lineNo=lineHandle.lineNo(),replaceStr=ImageStringService.setAttr(imageStr,"describe",describe);replaceStr!=imageStr&&(lineHandle.widgets&&lineHandle.widgets.length>0&&lineHandle.widgets[0].clear(),EditorToolService.replaceLine(editor,lineNo,replaceStr))}})})}var saveImgDescribe,altEditor,mainEditor;return creatAltInputField(),{addImageEditEvent:imageEvent}}]),app.factory("EditorToolService",["ImageStringService","EmojiService","UtilService","ScrollBarService","StatusService",function(ImageStringService,EmojiService,UtilService,ScrollBarService,StatusService){function polishContent(editor){var oldCursor=editor.getCursor(),lastLineNo=editor.lastLine(),firstLineNo=editor.firstLine(),lastLineText=editor.getLineHandle(lastLineNo).text,firstLineText=editor.getLineHandle(firstLineNo).text,lastTextlen=lastLineText.length;editor.removeLineClass(firstLineNo,"wrap","cm-polish-line"),ImageStringService.hasImage(firstLineText)&&(editor.replaceRange("\n",{line:firstLineNo,ch:0},{line:firstLineNo,ch:0}),firstLineNo=editor.firstLine(),editor.addLineClass(firstLineNo,"wrap","cm-polish-line"),lastLineNo++),""!==$.trim(lastLineText)&&(editor.replaceRange("\n",{line:lastLineNo,ch:lastTextlen},{line:lastLineNo,ch:lastTextlen}),lastLineNo=editor.lastLine(),editor.addLineClass(lastLineNo,"wrap","cm-polish-line"),oldCursor&&editor.setCursor(oldCursor))}function removePolishAndGetValue(editor){var str=editor.getValue(),lastLineNo=editor.lastLine(),firstLineNo=editor.firstLine(),lastLine=editor.getLineHandle(lastLineNo),firstLine=editor.getLineHandle(firstLineNo);return"cm-polish-line"==lastLine.wrapClass&&0===lastLine.text.length&&(str=str.replace(/\n$/,"")),"cm-polish-line"==firstLine.wrapClass&&0===firstLine.text.length,str}function getPureText(editor){var str=editor.getValue();return str=ImageStringService.deleteImage(str),str=str.replace(/\r\n/g,""),str=str.replace(/\r/g,""),str=str.replace(/\n/g,"")}function wordsCount(editor){return removeSpecialChar(getPureText(editor)).length}function clearMarker(editor){var markers=editor.getAllMarks();if($.isArray(markers))for(var i=0;i<markers.length;i++)markers[i].clear()}function clearLine(editor,lineNo){editor.replaceRange("",{line:lineNo,ch:0},{line:lineNo+1,ch:0})}function replaceLine(editor,lineNo,lineTxt){clearMarker(editor),editor.replaceRange(lineTxt.replace(/\n/g,"")+"\n",{line:lineNo,ch:0},{line:lineNo+1,ch:0})}function refreshViewer(editor,lineNo){if($.isNumeric(lineNo)&&!(lineNo<0)){var widgets=editor.lineInfo(lineNo).widgets;$.isArray(widgets)&&widgets.length>0&&widgets[0]&&widgets[0].changed()}}function imageVerticalMiddle(editor,$imageWrapDom,lineHandle){var height=$imageWrapDom.find(".cm-img-wrap").outerHeight(),remainder=height%50+50;remainder=remainder>75?remainder-50:remainder,$imageWrapDom.find(".cm-img-wrap").css({top:-remainder/2}),$imageWrapDom.css({height:height+50-remainder,visibility:"visible"}),refreshViewer(editor,lineHandle.lineNo())}function getLineNoByPageY(pageY){var lineNo=null,editorStartTop=140,editorWrap=$(".edit-wrap")[0],mouseOnEditorY=pageY-editorStartTop+editorWrap.scrollTop,list=$(".edit-wrap .note-editor .CodeMirror-code").children(":not(.cm-placeholder)"),len=list.length;return list.each(function(i){var top=$(this).offset().top-editorStartTop+editorWrap.scrollTop,topB=top+$(this).height();return 0==i&&mouseOnEditorY<top?(lineNo=0,!1):mouseOnEditorY>=top&&mouseOnEditorY<topB?(lineNo=i,!1):void(mouseOnEditorY>=topB&&i==len-1&&(lineNo=len))}),lineNo}function getLastChar(str){var lastChar="",lastCharIsEmoji=!1,len=str.length;return emojione.unicodeTo(str,function(unicode,match){var offset=match[match.length-2];return offset+unicode.length==len&&(lastCharIsEmoji=!0,lastChar=unicode),unicode}),lastCharIsEmoji?lastChar:str.substring(len-1,len)}function getLineNoByImageDom(imgLineDom){return imgLineDom.hasClass("img-line")||(imgLineDom=imgLineDom.parents(".img-line")),$(".CodeMirror-code").children().index(imgLineDom)}function getDetail(editor){var detail=removePolishAndGetValue(editor);return detail=removeSpecialChar(detail),detail=ImageStringService.joinImage(detail)}function removeSpecialChar(str){return str.replace(/\u200B|\u200C|\u200D/g,"")}function clearEmojiMark(marks){_.isArray(marks)&&_.each(marks,function(mark){"codeMirror-emoji"==mark.marker.className&&mark.marker.clear()})}function decodeEmoji(editor){editor.eachLine(function(lineHandle){var text=lineHandle.text;if(!ImageStringService.hasImage(text)){clearEmojiMark(lineHandle.markedSpans);var lineNo=lineHandle.lineNo();text.replace(EmojiService.emojiRegExp(),function(){var index=arguments[arguments.length-2],char=arguments[0],replaceDom=(EmojiService.toImage(char),$(EmojiService.toImage(char))[0]);editor.markText({line:lineNo,ch:index},{line:lineNo,ch:index+char.length},{className:"codeMirror-emoji",replacedWith:replaceDom,handleMouseEvents:!0})})}})}function highLight(editor){var highLightKeyword=StatusService.getValue(StatusService.name.CUR_KEYWORD);_.isString(highLightKeyword)&&CodeMirror.editorSearch(editor,highLightKeyword)}function blur(editor){editor.getInputField().blur()}function singleLineInputCtrl(option){option.composeStatus="none";var inputField=option.editor.getInputField();$(inputField).on("compositionstart",function(){option.composeStatus="start"}),$(inputField).on("compositionupdate",function(){option.composeStatus="update"}),$(inputField).on("compositionend",function(){setTimeout(function(){var str=option.editor.getValue(),sum=option.wordCount(str),left=sum-option.maxLength;if(left>0){var cursor=option.editor.getCursor(),ostr=str.substring(0,cursor.ch),cstr=option.subString(ostr,option.wordCount(ostr)-left);left=ostr.length-cstr.length,option.editor.replaceRange("",{line:cursor.line,ch:cursor.ch-left},cursor)}},1),option.composeStatus="none"}),option.editor.on("beforeChange",function(cm,changeObj){var beforeSum=option.wordCount(option.editor.getValue());return 0===option.editor.getSelection().length&&option.maxLength<=beforeSum&&("paste"==changeObj.origin||"+input"==changeObj.origin)&&"none"==option.composeStatus?void changeObj.cancel():void("+input"==changeObj.origin&&changeObj.text.length>1&&option.editor.getInputField().blur())}),option.editor.on("change",function(cm,changeObj){if(decodeEmoji(option.editor),option.afterInput&&option.afterInput(),"+input"==changeObj.origin&&changeObj.text.length>1){var s=cm.getValue().replace(/(\r|\n)/gi,"");cm.setValue(s)}})}function imgMayBeChange(editor,change,needSelect){var isChanged=!1,imgLineHandler=null;return change.from.line==change.to.line&&(imgLineHandler=editor.getLineHandle(change.from.line),ImageStringService.hasImage(imgLineHandler.text)&&(isChanged=!0)),1==Math.abs(change.from.line-change.to.line)&&"+delete"==change.origin&&(imgLineHandler=editor.getLineHandle(change.from.line),ImageStringService.hasImage(imgLineHandler.text)&&(isChanged=!0),isChanged||(imgLineHandler=editor.getLineHandle(change.to.line),ImageStringService.hasImage(imgLineHandler.text)&&(isChanged=!0))),isChanged&&needSelect&&(setTimeout(function(){$(imgLineHandler.widgets[0].node).parents(".img-line").addClass("img-line-on")},10),EditorToolService.blur(editor)),isChanged}var EditorToolService={polishContent:polishContent,getPureText:getPureText,wordsCount:wordsCount,clearLine:clearLine,replaceLine:replaceLine,getLineNoByImageDom:getLineNoByImageDom,clearMarker:clearMarker,imageVerticalMiddle:imageVerticalMiddle,getLineNoByPageY:getLineNoByPageY,getLastChar:getLastChar,getDetail:getDetail,removeSpecialChar:removeSpecialChar,decodeEmoji:decodeEmoji,refreshViewer:refreshViewer,highLight:highLight,blur:blur,singleLineInputCtrl:singleLineInputCtrl,imgMayBeChange:imgMayBeChange};return window.LocalEnvironment&&(window.EditorToolService=EditorToolService),EditorToolService}]),app.factory("ImageStringService",["$rootScope",function($rootScope){return ImageStringTool}]),app.factory("NoteStringService",["$rootScope","ImageStringService",function($rootScope,ImageStringService){function subMixString(str,num){var reg=/[^\x00-\xff]/g,emojis=[],CNWord="麷",CNWordReg=/麷/g,oldStr=str;if(str=emojione.unicodeTo(str,function(symbol){return emojis.push(symbol),CNWord}),str.replace(reg,"mm").length<=num)return oldStr;for(var cnLength=Math.floor(num/2),i=cnLength;i<=str.length;i++)if(str.substring(0,i).replace(reg,"mm").length>num){str=str.substring(0,i-1);break}return str=str.replace(CNWordReg,function(){return emojis.length>0?emojis.shift():CNWord})}function removeSpecialEmpty(s){return s=s.replace(/\r\n/g,"\n"),s=s.replace(/\r/g,"\n"),s.replace(/\u200B|\u200C|\u200D/g,"");
}function ltrim(s){return s.replace(/(^\s*)/g,"")}function decodeHtmlSymbol(s){return s=s.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")}return{getFirstTextLine:function(str,formatting_mode,needEmojiShortName){for(var detail=ImageStringService.deleteImage(str,"\n"),arr=detail.split("\n"),lineText="",i=0;i<arr.length;i++){var text=removeSpecialEmpty(arr[i]);if(text=ltrim(text),""!=text){lineText=text;break}}return lineText.length>0&&2==formatting_mode&&(lineText=Markdown(lineText).replace(/<[^>]+>/g,""),lineText=decodeHtmlSymbol(lineText)),needEmojiShortName&&(lineText=emojione.toShort(lineText,function(shortName){return shortName.replace(/:([^:]+):/g,"[$1]")})),lineText},getTitle:function(note){var title=this.getFirstTextLine(note.detail,note.formatting_mode),isImageNote=ImageStringService.hasImage(note.detail);return""==title&&(title=isImageNote?_.isString(note.title)&&"新建便签"!=note.title?note.title:"图片便签":"新建便签"),subMixString(title,80)},removeSpecialEmpty:removeSpecialEmpty}}]),app.factory("EmojiService",["$rootScope",function($rootScope){return{toImage:function(str){return emojione.unicodeToImage(str)},emojiRegExp:function(){return emojione.unicodeRegexp}}}]),app.factory("ErrorService",["$rootScope","I18NService","ToastService","AccountService","MoodService",function($rootScope,I18NService,ToastService,AccountService,MoodService){var codeMap={};return codeMap._2508=function(){ToastService.open(I18NService("IMAGE_TYPE_ERROR"))},codeMap._2509=function(){ToastService.open(I18NService("IMAGE_OVERSIZE"))},codeMap._2509a=function(){ToastService.open(I18NService("UPLOAD_IMAGE_FAIL"))},codeMap._2224=function(){ToastService.open(I18NService("SENSITIVE_WORDS"))},codeMap._2154=function(){ToastService.open(I18NService("FOLDER_EXIST_EXCEPTION"))},codeMap._2113=function(){ToastService.open(I18NService("SENSITIVE_WORDS")),MoodService.change({type:MoodService.type.EDIT,info:MoodService.info.BLUR})},codeMap._1701=function(){AccountService.reLogin()},codeMap._3001=function(){window.top.location.reload()},{catch:function(data){data.code+""=="1"&&_.each(data.errInfo,function(errMsg,errCode){codeMap["_"+errCode]?codeMap["_"+errCode]():ToastService.open(errMsg)})}}}]),app.factory("SortAndFilterNoteListService",["$rootScope","TaskService","GlobalConfigService","ImageStringService",function($rootScope,TaskService,GlobalConfigService,ImageStringService){function comparePos(a,b){return b.pos-a.pos}function compareDate(a,b){return b.modify_time-a.modify_time}function compareDateAndPos(a,b){return b.pos===a.pos?b.modify_time>a.modify_time?1:-1:b.pos>a.pos?1:-1}function comparePositionInFolder(a,b){return _.isNumber(a.position_in_folder)||(a.position_in_folder=0),_.isNumber(b.position_in_folder)||(b.position_in_folder=0),b.position_in_folder===a.position_in_folder?b.modify_time>a.modify_time?1:-1:b.position_in_folder>a.position_in_folder?1:-1}function noteSort(noteList,sortFn){var list=[];return $.isArray(noteList)&&(list=noteList.concat([])),list.length<2?noteList:list=list.sort(sortFn)}function decodeHtmlSymbol(s){return s=s.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&nbsp;/g," ").replace(/&quot;/g,'"').replace(/&amp;/g,"&")}function filterBy(noteList,filterFn){var filterList=[];return $(noteList).each(function(){filterFn(this)&&filterList.push(this)}),filterList=noteSort(filterList,sortFn),sortFn=compareDateAndPos,filterList}var sortFn=compareDateAndPos;return{sortByPos:function(noteList){return noteSort(noteList,comparePos)},sortByDate:function(noteList){return noteSort(noteList,compareDate)},sortByDateAndPos:function(noteList){return noteSort(noteList,compareDateAndPos)},filterByKeyword:function(noteList,keyword){var allNoteList=this.filterByIsAllNote(noteList);return filterBy(allNoteList,function(note){var detail=ImageStringService.convertImage(note.detail,function(attr){return decodeHtmlSymbol(attr.describe)});return detail.indexOf(keyword)>-1})},filterByIsFavNote:function(noteList){var allNoteList=this.filterByIsAllNote(noteList);return filterBy(allNoteList,function(note){return note.favorite+""=="1"})},filterByIsCallNote:function(noteList){var allNoteList=this.filterByIsAllNote(noteList);return filterBy(allNoteList,function(note){return note.isCallNote})},filterByIsImageNote:function(noteList){var allNoteList=this.filterByIsAllNote(noteList);return filterBy(allNoteList,function(note){return note.isImageNote})},filterByIsAllNote:function(noteList,keyword){return _.isString(keyword)&&keyword.length>0?this.filterByKeyword(noteList,keyword):filterBy(noteList,function(note){return note.folderType!=GlobalConfigService.TRASH_FOLDER_ID})},filterByFolder:function(noteList,folder1){return folder1._id==GlobalConfigService.ALL_FOLDER_ID?this.filterByIsAllNote(noteList):folder1._id==GlobalConfigService.CALL_FOLDER_ID?filterBy(noteList,function(note){return note.isCallNote&&note.folderType!=GlobalConfigService.TRASH_FOLDER_ID}):folder1._id==GlobalConfigService.FAV_FOLDER_ID?filterBy(noteList,function(note){return 1==note.favorite&&note.folderType!=GlobalConfigService.TRASH_FOLDER_ID}):folder1._id==GlobalConfigService.TRASH_FOLDER_ID?filterBy(noteList,function(note){return note.folderType==GlobalConfigService.TRASH_FOLDER_ID}):(sortFn=comparePositionInFolder,filterBy(noteList,function(note){return note.folderLocalId==folder1._id&&note.folderType!=GlobalConfigService.TRASH_FOLDER_ID}))},filterBy:function(filterType,noteList,keyword){if(this["filterBy"+filterType])return this["filterBy"+filterType](noteList,keyword)}}}]),app.factory("UtilService",[function(){function subMixString(str,num){var encodeStr=str.replace(/~/g,"~T"),emojis=[],cnReg=/[^\x00-\xff]/;encodeStr=emojione.unicodeTo(encodeStr,function(unicode){return emojis.push(unicode),"~E"});var strArr=[],sum=0,result="";return encodeStr.replace(/~?./g,function(whole){var len=1;"~T"==whole&&(whole="~"),cnReg.test(whole)&&(len=2),"~E"==whole&&(len=2,whole=emojis.shift()),sum+=len,sum>num&&0===result.length&&(result=strArr.join("")),strArr.push(whole)}),sum<=num?str:result}function subMixStringNoDouble(str,num){var encodeStr=str.replace(/~/g,"~T"),emojis=[];encodeStr=emojione.unicodeTo(encodeStr,function(unicode){return emojis.push(unicode),"~E"});var strArr=[],sum=0,result="";return encodeStr.replace(/~?./g,function(whole){var len=1;"~T"==whole&&(whole="~"),"~E"==whole&&(whole=emojis.shift(),len=whole.length),sum+=len,sum>num&&0===result.length&&(result=strArr.join("")),strArr.push(whole)}),sum<=num?str:result}function getMixStringLength(str){var reg=/[^\x00-\xff]/g,CNWord="囧";return str=emojione.unicodeTo(str,function(){return CNWord}),str.replace(reg,"mm").length}function whileTimeout(condition,fun,time){condition()&&(fun(),time>0?setTimeout(function(){whileTimeout(condition,fun,time)},time):whileTimeout(condition,fun,time))}function detectIE(){var ua=window.navigator.userAgent,msie=ua.indexOf("MSIE ");if(msie>0)return parseInt(ua.substring(msie+5,ua.indexOf(".",msie)),10);var trident=ua.indexOf("Trident/");if(trident>0){var rv=ua.indexOf("rv:");return parseInt(ua.substring(rv+3,ua.indexOf(".",rv)),10)}var edge=ua.indexOf("Edge/");return edge>0&&parseInt(ua.substring(edge+5,ua.indexOf(".",edge)),10)}function isSafari(){var ua=window.navigator.userAgent;return/safari/gi.test(ua)}function isSupportOfflineDataService(){return!_.isNumber(detectIE())}function folderNameTimeSuffix(){var time=new Date,month=time.getMonth()+1,day=time.getDate(),hours=time.getHours(),minutes=time.getMinutes(),seconds=time.getSeconds();return month=("0"+month).replace(/0(\d{2})/,"$1"),day=("0"+day).replace(/0(\d{2})/,"$1"),hours=("0"+hours).replace(/0(\d{2})/,"$1"),minutes=("0"+minutes).replace(/0(\d{2})/,"$1"),seconds=("0"+seconds).replace(/0(\d{2})/,"$1"),month+day+hours+minutes+seconds+count++}var isWindows=$("body.windows").length>0,isMacOS=$("body.macos").length>0,count=1;return{getMixStringLength:getMixStringLength,subMixString:subMixString,subMixStringNoDouble:subMixStringNoDouble,whileTimeout:whileTimeout,isSupportOfflineDataService:isSupportOfflineDataService,isIE8:function(){return $(".ie8").length>0},folderNameTimeSuffix:folderNameTimeSuffix,getTimeDiff:function(cloudTime){var diff=0;return _.isNumber(cloudTime)&&10==(cloudTime+"").length&&(cloudTime=1e3*cloudTime,diff=cloudTime-(new Date).getTime()),Math.abs(diff)<6e4&&(diff=0),diff},isWindows:function(){return isWindows},isMacOS:function(){return isMacOS},isSafari:isSafari}}]),app.factory("NoteService",["$rootScope","$filter","DialogService","NoteStringService","ImageStringService","DataEventService","SyncQueueService","TaskService","GlobalConfigService","FolderListFindService","ImmersiveModeService",function($rootScope,$filter,DialogService,NoteStringService,ImageStringService,DataEventService,SyncQueueService,TaskService,GlobalConfigService,FolderListFindService,ImmersiveModeService,NoteListService){function filterAttrName(note){_.isNumber(note.folderType)||(note.folderType=note.folder_type)}function normaliztion(noteList){_.isArray(noteList)||(noteList=[noteList]);for(var note,i=0;i<noteList.length;i++){if(note=noteList[i],note._id||(note._id="n"+NEW_NOTEID++ +"t"+(new Date).getTime()),note.detail=NoteStringService.removeSpecialEmpty(note.detail),note.title=NoteStringService.getTitle(note),_.isNumber(note.call_timestamp)&&note.call_timestamp>0?note.isCallNote=!0:note.isCallNote=!1,note.isImageNote=ImageStringService.hasImage(note.detail),_.isNumber(note.pos)||(note.pos=maxPos+1),_.isNumber(note.pos)&&note.pos>maxPos&&(maxPos=note.pos),_.isString(note.folderId)&&note.folderId.length<3&&(note.folderId=null),_.isString(note.rtf_style)||(note.rtf_style=""),_.isNumber(note.formatting_mode)||(note.formatting_mode=0),!note.folderLocalId&&note.folderId){var folder=FolderListFindService.findFolderBySyncId(note.folderId);folder&&(note.folderLocalId=folder._id)}if(note.folderLocalId&&!note.folderId){var folder=FolderListFindService.findFolder(note.folderLocalId);folder&&(note.folderId=folder.sync_id)}}}function createNote(folder){var folderLocalId=null,position_in_folder=0;folder&&(folderLocalId=folder._id,position_in_folder=folder.maxPos+1,folder.maxPos=position_in_folder);var note={uid:0,sync_id:null,favorite:0,markdown:0,call_timestamp:0,modify_time:(new Date).getTime(),detail:"",rtf_style:"",position_in_folder:position_in_folder,folderLocalId:folderLocalId};return normaliztion(note),note}function cloneNote(note){var folder={_id:note.folderLocalId},newNote=createNote(folder);return newNote.markdown=note.markdown,newNote.detail=note.detail,newNote.formatting_mode=note.formatting_mode,newNote.rtf_style=note.rtf_style,newNote}function saveNoteDetail(note,detail,rtf_style){(note.sync_id||0!==detail.length)&&(note.detail==detail&&note.rtf_style==rtf_style||(1==note.formatting_mode?note.rtf_style=rtf_style:note.rtf_style="",note.detail=detail,note.isImageNote=ImageStringService.hasImage(note.detail),note.title=NoteStringService.getTitle(note),SyncQueueService.push({type:DataEventService.UPDATE,dataName:DataEventService.NOTE,data:note,subType:DataEventService.DETAIL},"browser")))}function clearNoteStyle(note){note.rtf_style="",isSyncNote(note)&&SyncQueueService.push({type:DataEventService.UPDATE,dataName:DataEventService.NOTE,data:note,subType:DataEventService.DETAIL},"browser")}function updateNoteFavorite(note){$filter("isFavorite")(note)?note.favorite=0:note.favorite=1,isSyncNote(note)&&SyncQueueService.push({type:DataEventService.UPDATE,dataName:DataEventService.NOTE,data:note,subType:DataEventService.FAVORITE},"browser")}function updateNoteMarkdown(note){$filter("isMarkdown")(note)?note.markdown=0:note.markdown=1,isSyncNote(note)&&SyncQueueService.push({type:DataEventService.UPDATE,dataName:DataEventService.NOTE,data:note,subType:DataEventService.MARKDOWN},"browser")}function updateFormattingMode(note,val){_.isNumber(val)&&(_.indexOf([0,1,2],val)<0||note.formatting_mode!==val&&(note.formatting_mode=val,isSyncNote(note)&&SyncQueueService.push({type:DataEventService.UPDATE,dataName:DataEventService.NOTE,data:note,subType:DataEventService.FORMATTING_MODE},"browser")))}function isSyncNote(note){return!!note.sync_id}function isNullNote(note){return!note||!note._id}function updateFolder(noteList,folder){noteList&&(_.isArray(noteList)||(noteList=[noteList]),noteList.length<1||_.each(noteList,function(note){note.folderId==folder.sync_id&&note.folderType==folder.type||(note.folderLocalId=folder._id,note.folderId=folder.sync_id,note.folderType=folder.type,note.position_in_folder=folder.maxPos+1,folder.maxPos=note.position_in_folder,SyncQueueService.push({type:DataEventService.UPDATE,dataName:DataEventService.NOTE,data:note,subType:DataEventService.FOLDER},"browser"))}))}function openImmersiveMode(isOpen){ImmersiveModeService.openImmersiveMode(isOpen)}function getImmersiveMode(){return ImmersiveModeService.getImmersiveMode()}function getMaxPos(){return maxPos}function maxPosaAutIoncrement(){return maxPos+=1}var maxPos=0,NEW_NOTEID=1,NULL_NOTEID="n0";return{normaliztion:normaliztion,createNote:createNote,saveDetail:saveNoteDetail,clearStyle:clearNoteStyle,updateMarkdown:updateNoteMarkdown,updateFavorite:updateNoteFavorite,openImmersiveMode:openImmersiveMode,isSyncNote:isSyncNote,isNullNote:isNullNote,NULL_NOTEID:NULL_NOTEID,updateFolder:updateFolder,cloneNote:cloneNote,filterAttrName:filterAttrName,updateFormattingMode:updateFormattingMode,getImmersiveMode:getImmersiveMode,getMaxPos:getMaxPos,maxPosaAutIoncrement:maxPosaAutIoncrement}}]),app.factory("NoteListService",["$rootScope","$timeout","DataEventService","SyncQueueService","NoteService","SortAndFilterNoteListService","GlobalConfigService","NoteListFindService",function($rootScope,$timeout,DataEventService,SyncQueueService,NoteService,SortAndFilterNoteListService,GlobalConfigService,NoteListFindService){function trigger(eventName,data){_.each(binds,function(bind){bind.eventName==eventName&&bind.fn(data)})}function removeNote(note){SyncQueueService.push({type:DataEventService.REMOVE,dataName:DataEventService.NOTE,data:note})}function addNote(note){SyncQueueService.push({type:DataEventService.ADD,dataName:DataEventService.NOTE,data:note})}var binds=[],bindData={noteList:[],noteMap:{},syncIdMap:{}};return NoteListFindService.bindData(bindData),DataEventService.onInit(function(){_.isEmpty(bindData.noteList)&&addNote(NoteService.createNote())}),DataEventService.onAdd(DataEventService.NOTE,function(note,_undefined){note.sync_id&&NoteListFindService.findNoteBySyncId(note.sync_id)||(note.$$hashKey=_undefined,NoteService.normaliztion(note),bindData.noteList.push(note),bindData.noteMap[note._id]=note,note.sync_id&&(bindData.syncIdMap[note.sync_id]=note._id),trigger(DataEventService.ADD,note))}),DataEventService.onRemove(DataEventService.NOTE,function(note){bindData.noteList=_.without(bindData.noteList,note),trigger(DataEventService.REMOVE,note)}),DataEventService.onUpdate(DataEventService.NOTE,function(data,subType){var note=NoteListFindService.findNote(data._id);data.sync_id&&(bindData.syncIdMap[note.sync_id]=note._id),subType?(subType==DataEventService.SYNC_ID&&(note.sync_id=data.sync_id,note.modify_time=data.modify_time),subType==DataEventService.MODIFY_TIME&&(note.modify_time=data.modify_time)):(note.sync_id=data.sync_id,note.detail=data.detail,note.rtf_style=data.rtf_style,note.folderId=data.folderId,note.folderLocalId=data.folderLocalId,note.folderType=data.folderType,note.pos=data.pos,note.position_in_folder=data.position_in_folder,note.modify_time=data.modify_time,note.favorite=data.favorite,note.markdown=data.markdown,note.formatting_mode=data.formatting_mode,NoteService.normaliztion(note)),$timeout(function(){trigger(DataEventService.UPDATE,note)})}),{on:function(eventName,fn){binds.push({eventName:eventName,fn:fn})},addNote:addNote,removeNote:removeNote}}]),app.factory("NoteListFindService",[function(){function findNote(_id){return bindData.noteMap[_id]}function findNoteBySyncId(sync_id){var note=null,_id=bindData.syncIdMap[sync_id];return _id&&(note=findNote(_id)),note}var bindData={};return bindData.noteList=[],bindData.noteMap={},bindData.syncIdMap={},{bindData:function(bData){bindData=bData},findNote:findNote,findNoteBySyncId:findNoteBySyncId,getAll:function(){return bindData.noteList}}}]),app.factory("SyncQueueService",["$rootScope","DataService","DataEventService","SyncPushService","GlobalConfigService","OfflineDataService","UtilService","NoteListFindService","FolderListFindService","AccountService",function($rootScope,DataService,DataEventService,SyncPushService,GlobalConfigService,OfflineDataService,UtilService,NoteListFindService,FolderListFindService,AccountService){function makeQueueId(queue){var id="",subType="";return queue.data&&queue.data._id&&(queue.dataId=queue.data._id),queue.dataId&&(id=queue.dataId),queue.subType&&(subType=queue.subType),queue.type+queue.dataName+subType+id}function updateSyncQueueToLocalStorage(queueId,queue){var saveQueues={};for(var queueId in queues){var queue=queues[queueId];queue.status!=COMPLETE_STATUS&&(saveQueues[queueId]=queue)}var saveQueuesStr=JSON.stringify(saveQueues),saveQueuesName=GlobalConfigService.QUEUE_LOCAL_STORAGE_NAME;saveQueuesName=GlobalConfigService.getConfig("uid")+"::"+saveQueuesName,window.localStorage.setItem(saveQueuesName,saveQueuesStr)}function getSyncQueueFromLocalStorage(){var saveQueuesName=GlobalConfigService.QUEUE_LOCAL_STORAGE_NAME;saveQueuesName=GlobalConfigService.getConfig("uid")+"::"+saveQueuesName;var tempQueues=window.localStorage.getItem(saveQueuesName);if(_.isString(tempQueues)){tempQueues=JSON.parse(tempQueues),queues=tempQueues,_.each(queues,function(queue,queueId){queue.status==PENDING_STATUS&&waitingHandler(queueId)});for(var queueId in queues){var queue=queues[queueId],removeQueue=findQueueBySimilarQueue(DataEventService.REMOVE,queue);queue.type==DataEventService.UPDATE&&removeQueue&&completeHandler(queueId),queue.type!=DataEventService.UPDATE||queue.data.sync_id||completeHandler(queueId)}}}function push(queue,origin){queue.data.origin=origin,queue.time=(new Date).getTime(),queue.data&&queue.data._id&&(queue.dataId=queue.data._id),DataService.update(queue);var queueId=makeQueueId(queue);if(queue.type==DataEventService.REMOVE&&!queue.data.sync_id){var addQueue=findQueueBySimilarQueue(DataEventService.ADD,queue);completeHandler(makeQueueId(addQueue));var updateQueue=findQueueBySimilarQueue(DataEventService.UPDATE,queue);return void(updateQueue&&completeHandler(makeQueueId(updateQueue)))}queues[queueId]=queue,waitingHandler(queueId),updateSyncQueueToLocalStorage(queueId,queue)}function findQueueBySimilarQueue(type,queue){var q={type:type,dataName:queue.dataName,dataId:queue.dataId};return findQueue(q)}function findQueue(queue){var queueId=makeQueueId(queue);return queues[queueId]}function findQueueByNote(type,note){var q={type:type,dataName:DataEventService.NOTE,data:note},queueId=makeQueueId(q),queue=queues[queueId];return queue}function findQueueBySyncId(type,syncId){for(var queueId in queues){var queue=queues[queueId];if(queue.type==type&&queue.data.sync_id==syncId)return queue}return null}function onComplete(queue,fn){var queueId=makeQueueId(queue);COMPLETE_STATUS==queue.status?fn():$(window).one(queueId+COMPLETE_STATUS,fn)}function completeHandler(queueId){var queue=queues[queueId];queue&&(queue.status=COMPLETE_STATUS,$(window).trigger(queueId+COMPLETE_STATUS),$(window).trigger("statusChange"),updateSyncQueueToLocalStorage(queueId,queue))}function pendingHandler(queueId){var queue=queues[queueId];queue&&(queue.status=PENDING_STATUS,$(window).trigger(queueId+PENDING_STATUS),$(window).trigger("statusChange"),updateSyncQueueToLocalStorage(queueId,queue))}function waitingHandler(queueId){var queue=queues[queueId];queue&&(queue.status=WAITING_STATUS,$(window).trigger(queueId+WAITING_STATUS),$(window).trigger("statusChange"),updateSyncQueueToLocalStorage(queueId,queue))}function onChange(fn){$(window).on("statusChange",function(){fn()})}function complete(queue){completeHandler(makeQueueId(queue))}function hurryPush(queue,fn){var queueId=makeQueueId(queue);queue.status==WAITING_STATUS&&SyncPushService.send(queue,function(){pendingHandler(queueId)},function(){completeHandler(queueId),fn()},function(){waitingHandler(queueId)})}function pushRemoveTypeQueue(fn){var removeQueues=[];for(var queueId in queues){var queue=queues[queueId];queue.type==DataEventService.REMOVE&&queue.status==WAITING_STATUS&&removeQueues.push(queue)}var len=removeQueues.length;0===len&&fn(),_.each(removeQueues,function(queue){hurryPush(queue,function(){len-=1,0===len&&fn()})})}function heart(){enabledQueue&&setInterval(function(){if(AccountService.isLogin()){var time=(new Date).getTime();for(var queueId in queues){var queue=queues[queueId],waitingTime=getWaitingTime(queue);if(queue.status==WAITING_STATUS&&time-waitingTime>queue.time){if(validQueue(queue),queue.status!==WAITING_STATUS)continue;SyncPushService.send(queue,function(q){pendingHandler(makeQueueId(q))},function(q){var lastestQueue=queues[makeQueueId(q)];lastestQueue==q&&completeHandler(makeQueueId(q))},function(q){waitingHandler(makeQueueId(q))})}}}},1e3)}function validQueue(queue){if(queue.type==DataEventService.UPDATE||queue.type==DataEventService.ADD){if(queue.dataName==DataEventService.NOTE){var note=NoteListFindService.findNote(queue.dataId);note||completeHandler(makeQueueId(queue))}if(queue.dataName==DataEventService.FOLDER){var folder=FolderListFindService.findFolder(queue.dataId);folder||completeHandler(makeQueueId(queue))}}}function forcePush(){if(enabledQueue)for(var queueId in queues){var queue=queues[queueId];queue.status==WAITING_STATUS&&SyncPushService.send(queue,function(q){pendingHandler(makeQueueId(q))},function(q){var lastestQueue=queues[makeQueueId(q)];lastestQueue==q&&completeHandler(makeQueueId(q))},function(q){waitingHandler(makeQueueId(q))})}}function getWaitingTime(queue){return queue.dataName==DataEventService.NOTE&&queue.subType==DataEventService.DETAIL?MAX_WAITING_TIME:0}var queues={},MAX_WAITING_TIME=GlobalConfigService.SYNC_DELAY_TIME,enabledQueue=!1,WAITING_STATUS=1,PENDING_STATUS=2,COMPLETE_STATUS=3;return{WAITING_STATUS:WAITING_STATUS,PENDING_STATUS:PENDING_STATUS,COMPLETE_STATUS:COMPLETE_STATUS,push:push,findQueueByNote:findQueueByNote,findQueueBySyncId:findQueueBySyncId,onComplete:onComplete,onChange:onChange,complete:complete,hasAllComplete:function(){for(var queueId in queues){var q=queues[queueId];if(q&&q.status!==COMPLETE_STATUS){if(q.dataName==DataEventService.NOTE&&q.type==DataEventService.ADD&&_.isEmpty(q.data.detail))continue;return!1}}return!0},forcePush:forcePush,hurryPush:hurryPush,pushRemoveTypeQueue:pushRemoveTypeQueue,heart:heart,start:function(){enabledQueue=!0,heart()},getLocalStorage:getSyncQueueFromLocalStorage}}]),app.factory("SyncPullService",["OnlineDataService","DataEventService","DataMergeService","DataService","NoteService","GlobalConfigService","UtilService",function(OnlineDataService,DataEventService,DataMergeService,DataService,NoteService,GlobalConfigService,UtilService){return function(fn){OnlineDataService.getInitData().then(function(data){_.each(data.folder,function(folder){DataMergeService.merge(DataEventService.FOLDER,folder)}),_.each(data.note,function(note){NoteService.filterAttrName(note),DataMergeService.merge(DataEventService.NOTE,note)}),GlobalConfigService.setConfig("timeDiff",UtilService.getTimeDiff(data.timestamp)),GlobalConfigService.setConfig("noteVersion",data.note_version),DataService.update({type:DataEventService.UPDATE,dataName:DataEventService.VERSION,data:data.note_version}),fn()})}}]),app.factory("SyncPushService",["OnlineDataService","DataEventService","NoteListFindService","FolderListFindService","GlobalConfigService",function(OnlineDataService,DataEventService,NoteListFindService,FolderListFindService,GlobalConfigService){function filterQueue(queue){if(queue.dataName==NOTE){if(!queue.data)return null;if((queue.type==UPDATE||queue.type==REMOVE)&&!queue.data.sync_id)return null;if(queue.type==ADD&&_.isEmpty(queue.data.detail))return null}if(queue.dataName==FOLDER){if(!queue.data)return null;if((queue.type==UPDATE||queue.type==REMOVE)&&!queue.data.sync_id)return null}return queue}var ADD=DataEventService.ADD,UPDATE=DataEventService.UPDATE,REMOVE=DataEventService.REMOVE,ATTR_FAVORITE=DataEventService.FAVORITE,ATTR_MARKDOWN=DataEventService.MARKDOWN,ATTR_FORMATTING_MODE=DataEventService.FORMATTING_MODE,ATTR_FOLDER=DataEventService.FOLDER,ATTR_DETAIL=DataEventService.DETAIL,NOTE=DataEventService.NOTE,FOLDER=(DataEventService.GLOBAL_NOTE_FORMAT,DataEventService.VERSION,DataEventService.FOLDER),apiMap={};return apiMap[ADD]={},apiMap[UPDATE]={},apiMap[REMOVE]={},apiMap[ADD][NOTE]=OnlineDataService.createNote,apiMap[ADD][FOLDER]=OnlineDataService.createFolder,apiMap[UPDATE][NOTE+ATTR_DETAIL]=OnlineDataService.updateNote,apiMap[UPDATE][NOTE+ATTR_FAVORITE]=OnlineDataService.updateFavorite,apiMap[UPDATE][NOTE+ATTR_MARKDOWN]=OnlineDataService.updateMarkdown,apiMap[UPDATE][NOTE+ATTR_FORMATTING_MODE]=OnlineDataService.updateFormattingMode,apiMap[UPDATE][NOTE+ATTR_FOLDER]=OnlineDataService.batchUpdateFolder,apiMap[UPDATE][FOLDER]=OnlineDataService.updateFolderTitle,apiMap[REMOVE][NOTE]=OnlineDataService.batchDeleteNotes,apiMap[REMOVE][FOLDER]=OnlineDataService.deleteFolder,{send:function(queue,passFn,successFn,failFn){var api;queue.subType||(queue.subType="");var fQueue=filterQueue(queue);fQueue&&(passFn(queue),api=apiMap[queue.type][queue.dataName+queue.subType],api(queue.data).then(function(){successFn(queue)},function(){failFn(queue)}))}}}]),app.factory("TypoService",["AnimationService","ImageStringService",function(AnimationService,ImageStringService){var completeHandler=null;return{typo:function(text){text=ImageStringService.convertImage(text,function(attrs){return'<img src="/notesimage/'+attrs.name+'" alt="'+attrs.describe+'" />'});var typography=new Typography($("#page-container"));$("#page-container").html(""),$("#page-container").removeClass("markdown"),typography.do(text),setTimeout(function(){completeHandler&&completeHandler(),completeHandler=null},50)},markdown:function(text){text=ImageStringService.convertImage(text,function(attrs){return'<img src="/notesimage/'+attrs.name+'" alt="'+attrs.describe+'" />'});var typography=new Typography($("#page-container"),{end_type:"return_string",allow_tag:!0}),markdownHtml=MarkdownTypography(text,typography);$("#page-container").removeClass("rtf-preview"),$("#page-container").addClass("markdown").html(markdownHtml),typography.end_treatment(),setTimeout(function(){completeHandler&&completeHandler(),completeHandler=null},50)},rtf:function(text,styleData){var container=$("#page-container");RtfTypography(container,text,styleData),setTimeout(function(){completeHandler&&completeHandler(),completeHandler=null},50)},onComplete:function(fn){completeHandler=fn}}}]),app.factory("ShareService",["$rootScope","OnlineToolService","I18NService","UtilService","DialogService","GlobalConfigService","ToastService","ImageStringService",function($rootScope,OnlineToolService,I18NService,UtilService,DialogService,GlobalConfigService,ToastService,ImageStringService){function getShareText(note,len){var text=note.title;return len=len||180,text=emojione.toShort(text,function(shoreName){return"[$1]".replace("$1",shoreName.replace(/:/g,""))}),text=UtilService.subMixString(text,len)}function getStrLength(str){var temp_str=str,len=temp_str.replace(/[^\x00-\xff]/g,"**").length;return Math.ceil(len/2)}function showShortWeiboDialog(note){DialogService.setContent("ShortWeiboShare",{weiboName:GlobalConfigService.getConfig("weiboName")}),DialogService.open("ShortWeiboShare",function(){var content=$("#short-weibo-share-content").val();return getStrLength(content)>140?void AnimationService.action("shakeHead")($("#short-weibo-share-content").parent()):(OnlineToolService.shareWeibo({content:content,note_content:note.detail,sync_id:note.sync_id,title:note.title,markdown:note.markdown,formatting_mode:note.formatting_mode,rtf_style:note.rtf_style}).then(function(){ToastService.open("SHARE_SUCCESS")}),void DialogService.close())}),setTimeout(function(){var textarea=$("#short-weibo-share-content");textarea.val(weiboShareContent),textarea.off().on("keyup blur paste",function(){var self=this;setTimeout(function(){var len=getStrLength(self.value);140-len>-1?$(".short-weibo-share-dialog .words-left").html("还可以输入&nbsp;<span>"+(140-len)+"</span>&nbsp;字"):$(".short-weibo-share-dialog .words-left").html("已超过&nbsp;<span>"+(len-140)+"</span>&nbsp;字")},1)}),textarea.trigger("keyup")},100)}function vaildWeiboQrcode(note,fn){var hasQrcode=!1,imgList=[],validCallback=function(){};if(QrcodeDecode.callback=function(result){_.isString(result)&&(hasQrcode=!0),validCallback()},ImageStringTool.convertImage(note.detail,function(attrs){imgList.push(ImageStringService.imagePath(attrs.name))}),imgList.length>0){var validCallback=_.after(imgList.length,function(){fn(hasQrcode?"hasQrcode":"noQrcode")});_.each(imgList,function(src){QrcodeDecode.decode(src)})}else fn("noQrcode")}var weiboURL="http://service.weibo.com/share/share.php?appkey=1669909353",weiboShareContent="",weiboShareNote=null;return window.shareLongWeiboAuthCallback=function(referUrl){var weiboName="";referUrl&&(weiboName=decodeURI(referUrl.match(/weibo_name=([^\&]+)/)[1])),GlobalConfigService.setConfig("weiboAuthorize",!0),GlobalConfigService.setConfig("weiboName",weiboName),showShortWeiboDialog(weiboShareNote),$rootScope.$$phase||$rootScope.$apply()},{webShare:function(note){OnlineToolService.createWebShareLink(note).then(function(data){var isAuth=!1;data.weibo_authorize+""=="1"&&(isAuth=!0,GlobalConfigService.setConfig("weiboName",data.weibo_name)),weiboShareNote=note,weiboShareContent=getShareText(note,160)+"...新浪长微博版 http://weibo.com/p/"+data.biz_id+data.id,isAuth?vaildWeiboQrcode(note,function(result){"hasQrcode"==result?DialogService.open("QrcodeTip",function(){showShortWeiboDialog(weiboShareNote)}):showShortWeiboDialog(weiboShareNote)}):window.open("https://cloud.smartisan.com/apps/note-share/index.php?r=web/oauth","newwindow","height=100,width=400,top=0,left=0,toolbar=no,menubar=no,scrollbars=no, resizable=no,location=no, status=no")})},imgShare:function(imgSrc,note){var title=getShareText(note,180)+encodeURIComponent(I18NService("WEIBO_TAIL")),url=weiboURL+"&pic="+imgSrc+"&title="+title;window.open(encodeURI(url),"","")}}}]),app.factory("FolderService",["$rootScope","TaskService","UtilService","DataEventService","SyncQueueService","FolderListFindService","ToastService","GlobalConfigService",function($rootScope,TaskService,UtilService,DataEventService,SyncQueueService,FolderListFindService,ToastService,GlobalConfigService){function validName(str){return!!_.isString(str)&&str.length<=85}function normaliztion(folderList){$.isArray(folderList)||(folderList=[folderList]);for(var folder,i=0;i<folderList.length;i++)folder=folderList[i],(!folder._id&&folder._id!=GlobalConfigService.ALL_FOLDER_ID||folder._id+""=="")&&(folder._id="f"+NEW_FOLDERID++ +"t"+(new Date).getTime()),_.isNumber(folder.position)||(folder.position=_maxPosition+1),_.isNumber(folder.position)&&folder.position>_maxPosition&&(_maxPosition=folder.position),folder.sum=0}function createFolder(title){if(validName(title)){var id="f"+NEW_FOLDERID++ +"t"+(new Date).getTime(),folder={_id:id,sync_id:null,title:title,modify_time:Math.floor((new Date).getTime()/1e3)};return normaliztion(folder),folder}}function updateFolderTitle(folder,title){if(title=$.trim(title),0===title.length)return void ToastService.open("FOLDER_NAME_CAN_NOT_BE_EMPTY");if(folder.title!=title){var hasSameName=!1;if(_.each(FolderListFindService.findAll(),function(tFolder){title==tFolder.title&&(hasSameName=!0)}),hasSameName)return ToastService.open("FOLDER_NAME_MUST_BE_UNIQUE"),!1;folder.title=title,folder.modify_time=Math.floor((new Date).getTime()/1e3),SyncQueueService.push({type:DataEventService.UPDATE,dataName:DataEventService.FOLDER,data:folder})}}function isTrashFolder(folder){return folder&&folder._id==GlobalConfigService.TRASH_FOLDER_ID;
}var NEW_FOLDERID=1,_maxPosition=0;return{createFolder:createFolder,validName:validName,normaliztion:normaliztion,updateFolderTitle:updateFolderTitle,isTrashFolder:isTrashFolder}}]),app.factory("FolderNameInputService",["$rootScope","DialogService","TaskService","ImageStringService","EditorImageDecodeService","EditorImageDragService","EditorToolService","EmojiService","UtilService","GlobalConfigService",function($rootScope,DialogService,TaskService,ImageStringService,EditorImageDecodeService,EditorImageDragService,EditorToolService,EmojiService,UtilService,GlobalConfigService){function creatFolderNameInputField(){var dom=$(".a-folder-name-input"),wrap=$(".a-folder-name-input-wrap");folderNameEditor=CodeMirror(dom[0],{lineWrapping:!1,cursorHeight:.65,dragDrop:!1,scrollbarStyle:"null"}),folderNameEditor.on("blur",function(){setTimeout(function(){saveFolderName(folderNameEditor.getValue()),wrap.removeClass("on"),saveFolderName=function(){},folderNameEditor.setValue("")},100)}),EditorToolService.singleLineInputCtrl({editor:folderNameEditor,wordCount:function(text){return text.length},subString:function(text,len){return UtilService.subMixStringNoDouble(text,len)},maxLength:GlobalConfigService.FOLDER_NAME_MAX})}function showFolderNameInput(folderName,targetDom,saveFn){folderNameEditor||creatFolderNameInputField();var wrap=$(".a-folder-name-input-wrap"),container=$(".a-folder-container"),parentTop=$(".a-folder-container").offset().top,top=targetDom.offset().top+container.scrollTop(),scrollTop=$(".a-folder-container").scrollTop();folderNameEditor.setValue(folderName),setTimeout(function(){folderNameEditor.setCursor({line:0,ch:100}),folderNameEditor.focus(),$(".a-folder-container").scrollTop(scrollTop)},10),wrap.addClass("on"),wrap.css({top:top-parentTop}),saveFolderName=saveFn}var folderNameEditor,saveFolderName;return{init:showFolderNameInput}}]),app.factory("DialogFolderNameInputService",["$rootScope","TaskService","EditorToolService","EmojiService","UtilService","GlobalConfigService",function($rootScope,TaskService,EditorToolService,EmojiService,UtilService,GlobalConfigService){function creatFolderNameInputField(){var dom=$(".move-note-dialog .input"),wrap=$(".move-note-dialog .input-wrap");folderNameEditor=CodeMirror(dom[0],{lineWrapping:!1,placeholder:"111",cursorHeight:.65,dragDrop:!1,scrollbarStyle:"null"}),folderNameEditor.on("blur",function(){setTimeout(function(){saveFolderName(folderNameEditor.getValue()),wrap.removeClass("on"),saveFolderName=function(){},folderNameEditor.setValue("")},100)}),EditorToolService.singleLineInputCtrl({editor:folderNameEditor,wordCount:function(text){return text.length},subString:function(text,len){return UtilService.subMixStringNoDouble(text,len)},maxLength:GlobalConfigService.FOLDER_NAME_MAX})}function showFolderNameInput(folderName,targetDom,saveFn){folderNameEditor||creatFolderNameInputField();var container=$(".move-note-dialog .list-wrap"),wrap=$(".move-note-dialog .input-wrap"),parentTop=container.offset().top,top=targetDom.offset().top,scrollTop=container.scrollTop();folderNameEditor.setValue(folderName),setTimeout(function(){folderNameEditor.setCursor({line:0,ch:100}),folderNameEditor.focus(),container.scrollTop(scrollTop)},10),wrap.addClass("on"),wrap.css({top:top-parentTop}),saveFolderName=saveFn}var folderNameEditor,saveFolderName;return{init:showFolderNameInput}}]),app.factory("FolderListService",["$rootScope","SyncQueueService","DataEventService","FolderService","FolderListFindService","GlobalConfigService","ToastService",function($rootScope,SyncQueueService,DataEventService,FolderService,FolderListFindService,GlobalConfigService,ToastService){function removeFolder(folder){SyncQueueService.push({type:DataEventService.REMOVE,dataName:DataEventService.FOLDER,data:folder})}function addFolder(folder){if(folder.title=$.trim(folder.title),0===folder.title.length)return ToastService.open("FOLDER_NAME_CAN_NOT_BE_EMPTY"),!1;var hasSameName=!1;return _.each(bindData.folderList,function(tFolder){folder.title==tFolder.title&&(hasSameName=!0)}),hasSameName?(ToastService.open("FOLDER_NAME_MUST_BE_UNIQUE"),!1):(SyncQueueService.push({type:DataEventService.ADD,dataName:DataEventService.FOLDER,data:folder}),!0)}function sortFolderList(fList){var list=[];return list=_.without(fList,all,trash,fav,call),list=list.sort(function(a,b){return b.position===a.position?b.modify_time>a.modify_time?1:-1:b.position>a.position?1:-1}),list.unshift(call),list.unshift(fav),list.unshift(all),list.push(trash),list}function trigger(eventName,data){_.each(binds,function(bind){bind.eventName==eventName&&bind.fn(data)})}function bind(eventName,fn){bindData.folderList.length>0&&"add"==eventName&&_.each(bindData.folderList,function(folder){fn(folder)}),binds.push({eventName:eventName,fn:fn})}var all={_id:GlobalConfigService.ALL_FOLDER_ID,type:GlobalConfigService.ALL_FOLDER_ID,sync_id:"",title:"全部便签"},trash={_id:GlobalConfigService.TRASH_FOLDER_ID,type:GlobalConfigService.TRASH_FOLDER_ID,sync_id:"",title:"回收站"},fav={_id:GlobalConfigService.FAV_FOLDER_ID,type:GlobalConfigService.FAV_FOLDER_ID,sync_id:"",title:"加星便签"},call={_id:GlobalConfigService.CALL_FOLDER_ID,type:GlobalConfigService.CALL_FOLDER_ID,sync_id:"",title:"通话便签"},bindData={folderList:[],all:all,trash:trash,call:call,fav:fav},binds=[];return FolderListFindService.bindData(bindData),FolderService.normaliztion(all),FolderService.normaliztion(trash),FolderService.normaliztion(fav),FolderService.normaliztion(call),bindData.folderList.push(all),bindData.folderList.push(trash),bindData.folderList.push(fav),bindData.folderList.push(call),DataEventService.onAdd(DataEventService.FOLDER,function(folder,_undefined){folder.$$hashKey=_undefined,FolderService.normaliztion(folder),bindData.folderList.push(folder),trigger(DataEventService.ADD,folder)}),DataEventService.onRemove(DataEventService.FOLDER,function(folder){bindData.folderList=_.without(bindData.folderList,folder),trigger(DataEventService.REMOVE,folder)}),DataEventService.onUpdate(DataEventService.FOLDER,function(data){var folder=FolderListFindService.findFolder(data._id);folder.sync_id=data.sync_id,folder.title=data.title,folder.position=data.position,folder.modify_time=data.modify_time,trigger(DataEventService.UPDATE,folder)}),{on:bind,addFolder:addFolder,removeFolder:removeFolder,sortFolderList:sortFolderList}}]),app.factory("FolderListFindService",["GlobalConfigService",function(GlobalConfigService){function getFolderByNote(note){if(note.folderType==GlobalConfigService.TRASH_FOLDER_ID)return bindData.trash;var folder=null;return note.folderLocalId&&(folder=_.find(bindData.folderList,function(f){return f._id==note.folderLocalId})),folder?folder:bindData.all}function getFolderByLocalId(localId){var folder=_.find(bindData.folderList,function(f){return f._id==localId});return folder}function getFolderBySyncId(SyncId){if(!SyncId)return null;var folder=_.find(bindData.folderList,function(f){return f.sync_id==SyncId});return folder}function getFolderByTitle(folder){if(!folder)return null;var folder=_.find(bindData.folderList,function(f){return f.title==folder.title&&f.sync_id!=folder.sync_id});return folder}var bindData={folderList:[],all:{},trash:{}};return{bindData:function(bData){bindData=bData},findFolderByNote:getFolderByNote,findFolder:getFolderByLocalId,findFolderBySyncId:getFolderBySyncId,findFolderByTitle:getFolderByTitle,findAll:function(){return bindData.folderList}}}]),app.factory("ContextMenuService",["$rootScope","TaskService",function($rootScope,TaskService){function show(contextMenuName,targetDom,e){var x=e.pageX,y=e.pageY;layer[contextMenuName].targetDom=targetDom,layer[contextMenuName].menuDom.css({top:y,left:x}),layer[contextMenuName].menuDom.removeClass("on"),setTimeout(function(){layer[contextMenuName].menuDom.addClass("on")},100),setTimeout(function(){$("body").one("click."+contextMenuName,function(){$("body").off("mousewheel."+contextMenuName),layer[contextMenuName].menuDom.removeClass("on")}),$("body").one("mousewheel."+contextMenuName,function(){$("body").off("click."+contextMenuName),layer[contextMenuName].menuDom.removeClass("on")})},1)}function makeEventName(contextMenuName,actionName){return contextMenuName+"."+actionName}function getContextMenuNameByEventName(eventName){return eventName.split(".")[0]}function bind(evnetName,attrName,fn){angular.isFunction(attrName)&&(fn=attrName,attrName="id"),$(window).on(evnetName,function(){var contextMenuName=getContextMenuNameByEventName(evnetName),targetDom=layer[contextMenuName].targetDom,attrVal=targetDom.attr(attrName);fn(attrVal,targetDom)})}function trigger(actionName){$(window).trigger(actionName)}var layer={};return{on:bind,trigger:trigger,makeEventName:makeEventName,show:show,add:function(contextMenuName,dom){layer[contextMenuName]={menuDom:dom}}}}]),app.factory("DataMergeService",["NoteListFindService","NoteService","FolderService","FolderListFindService","DataEventService","DataService","UtilService","SyncQueueService","NoteStringService","ImageStringService",function(NoteListFindService,NoteService,FolderService,FolderListFindService,DataEventService,DataService,UtilService,SyncQueueService,NoteStringService,ImageStringService){function isContain(text1,text2){var text1s=ImageStringService.splitImage(text1).split("\n"),text2s=ImageStringService.splitImage(text2).split("\n");if(text1s.length<text2s.length)return!1;for(var len=text2s.length,i=0;i<len;i++)if(0!==text2s[i].length&&text1s[i].indexOf(text2s[i])<0)return!1;return!0}function updateNote(cloudData,localData){localData?(cloudData._id=localData._id,NoteService.normaliztion(cloudData),DataService.update({type:DataEventService.UPDATE,dataName:DataEventService.NOTE,data:cloudData})):(NoteService.normaliztion(cloudData),DataService.update({type:DataEventService.ADD,dataName:DataEventService.NOTE,data:cloudData}))}function mergeNote(data){var updateQueue=SyncQueueService.findQueueBySyncId(DataEventService.UPDATE,data.sync_id),note=NoteListFindService.findNoteBySyncId(data.sync_id);if(updateQueue&&updateQueue.status!=SyncQueueService.COMPLETE_STATUS)if(data.detail=NoteStringService.removeSpecialEmpty(data.detail),data.detail!==updateQueue.data.detail)if(isContain(data.detail,updateQueue.data.detail)||isContain(updateQueue.data.detail,data.detail)){var mergeData=updateQueue.data;data.detail.length>updateQueue.data.detail.length&&(mergeData=data,SyncQueueService.complete(updateQueue)),updateNote(mergeData,note)}else{var cloneNote=NoteService.cloneNote(updateQueue.data);SyncQueueService.complete(updateQueue),updateNote(data,note),DataEventService.onInit(function(){SyncQueueService.push({type:DataEventService.ADD,dataName:DataEventService.NOTE,data:cloneNote})})}else updateNote(data,note);else updateNote(data,note)}function updateFolder(cloudData,localData){var sameNameFolder=FolderListFindService.findFolderByTitle(cloudData);if(localData?(cloudData._id=localData._id,FolderService.normaliztion(cloudData),DataService.update({type:DataEventService.UPDATE,dataName:DataEventService.FOLDER,data:cloudData})):(FolderService.normaliztion(cloudData),DataService.update({type:DataEventService.ADD,dataName:DataEventService.FOLDER,data:cloudData})),sameNameFolder){var folder=FolderListFindService.findFolder(cloudData._id);FolderService.updateFolderTitle(folder,folder.title+UtilService.folderNameTimeSuffix())}}function mergeFolder(data){var updateQueue=SyncQueueService.findQueueBySyncId(DataEventService.UPDATE,data.sync_id),folder=FolderListFindService.findFolderBySyncId(data.sync_id);updateQueue&&updateQueue.status!=SyncQueueService.COMPLETE_STATUS?(SyncQueueService.complete(updateQueue),updateFolder(data,folder)):updateFolder(data,folder)}var service={};return service.merge=function(dataName,data){dataName==DataEventService.NOTE&&mergeNote(data),dataName==DataEventService.FOLDER&&mergeFolder(data)},service}]),app.factory("PushManageService",["OnlineDataService","SyncQueueService","DataEventService","NoteService",function(OnlineDataService,SyncQueueService,DataEventService,NoteService){$(document).on("visibilitychange",function(){"visible"==document.visibilityState?SyncQueueService.heart():SyncQueueService.forcePush()}),$(window).focus(function(){SyncQueueService.heart()}),$(window).blur(function(){SyncQueueService.forcePush()})}]),app.factory("InitManageService",["SyncPullService","SyncQueueService","DataEventService","DataService","GlobalConfigService","NoteListFindService","OnlineDataService","OfflineDataService","UtilService","SyncDiffManageService","ImmersiveModeService",function(SyncPullService,SyncQueueService,DataEventService,DataService,GlobalConfigService,NoteListFindService,OnlineDataService,OfflineDataService,UtilService,SyncDiffManageService,ImmersiveModeService){function main(){OnlineDataService.getUid().then(function(data){if(_.isNumber(data.uid)){var agreeTime=data.agree,uid=data.uid.toString(36);GlobalConfigService.setConfig("uid",uid),SyncQueueService.getLocalStorage(),getAppData(agreeTime)}})}function getAppData(agreeTime){if(UtilService.isSupportOfflineDataService()){var localFeatureVersion=window.localStorage.getItem("feature_version"),localAgreeTime=window.localStorage.getItem("agree_time");localFeatureVersion==FEATURE_VERSION&&agreeTime==localAgreeTime?DataService.get(DataEventService.VERSION).then(function(version){version?(GlobalConfigService.setConfig("noteVersion",version),getLocalData()):getOnlineData()}):OfflineDataService.clearDB(function(){window.localStorage.setItem("agree_time",agreeTime),window.localStorage.setItem("feature_version",FEATURE_VERSION),getOnlineData()})}else getOnlineData()}function getLocalData(){DataService.get(DataEventService.FOLDER).then(function(folderList){folderList.length>0&&_.each(folderList,function(folder){DataEventService.trigger(DataEventService.ADD,DataEventService.FOLDER,folder)}),DataService.get(DataEventService.NOTE).then(function(noteList){noteList.length>0&&_.each(noteList,function(note){DataEventService.trigger(DataEventService.ADD,DataEventService.NOTE,note)}),SyncQueueService.pushRemoveTypeQueue(function(){SyncQueueService.start(),DataEventService.trigger("init"),SyncDiffManageService.update()})})})}function getOnlineData(){SyncPullService(function(){SyncQueueService.start(),DataEventService.trigger("init")})}var FEATURE_VERSION="20170522imagedescbugfix";main(),DataEventService.onInit(function(){ImmersiveModeService.immersiveRefresh(function(){$("body").removeClass("data-loading")})})}]),app.factory("WebSocketService",["DataService","SyncDiffManageService","GlobalConfigService","AccountService","ErrorService",function(DataService,SyncDiffManageService,GlobalConfigService,AccountService,ErrorService){function createTunnel(){top.disabledTunnel||(window.WebSocket&&!top.disabledWebSocket?createWebsocket():createPolling())}function isJson(str){try{JSON.parse(str)}catch(e){return!1}return!0}function createWebsocket(){WebSocketSrc=WebSocketSrc.replace("$1",authKey.node_id).replace("$2",authKey.token);var websocket=new WebSocket(WebSocketSrc);websocket.onmessage=function(event){var data=event.data;if("pong"==data&&websocketPing(websocket),isJson(data)){var json=JSON.parse(data);isJson(json.msg)&&(json=JSON.parse(json.msg),_.isNumber(json.uid)&&GlobalConfigService.getConfig("uid")==json.uid.toString(36)&&SyncDiffManageService.update())}},websocket.onopen=function(event){websocketPing(websocket)}}function websocketPing(websocket){clearTimeout(closeWSTimeout),setTimeout(function(){websocket.send("ping"),closeWSTimeout=setTimeout(function(){websocket.close(),setTimeout(function(){auth()},1e3)},1e4)},1e3*webSocketHeart-5e3)}function createPolling(){$.ajax({type:"GET",url:pullSrc.replace("$1",authKey.node_id).replace("$2",authKey.token),dataType:"json",success:function(data){if(1==data.code)setTimeout(function(){auth()},3e3);else{if(data.data.msg){var json=JSON.parse(data.data.msg);_.isNumber(json.uid)&&GlobalConfigService.getConfig("uid")==json.uid.toString(36)&&SyncDiffManageService.update()}setTimeout(function(){createPolling()},3e3)}},error:function(){setTimeout(function(){auth()},3e3)}})}function auth(){if(clearTimeout(timeout),AccountService.isLogin()){var SCA_SESS=Cookies.get("SCA_SESS");SCA_SESS||(timeout=setTimeout(function(){auth()},1e4)),$.ajax({type:"GET",url:"//webpush.smartisan.com/auth",dataType:"json",xhrFields:{withCredentials:!0},success:function(msg){1==msg.code?(ErrorService.catch(msg),timeout=setTimeout(function(){auth()},1e4)):(clearTimeout(timeout),authKey=msg.data,createTunnel())},error:function(){timeout=setTimeout(function(){auth()},1e4)}})}}var authKey={},webSocketHeart=_.random(30,240),WebSocketSrc="wss://webpush.smartisan.com/sub?ni=$1&hb="+webSocketHeart+"&ap=tp&tk=$2";/^https/.test(window.location.href)||(WebSocketSrc="ws://webpush.smartisan.com/sub?ni=$1&hb="+webSocketHeart+"&ap=tp&tk=$2");var closeWSTimeout=null,pullSrc="//webpush.smartisan.com/pull?ni=$1&hb=15&ap=tp&tk=$2",timeout=null;window.LocalEnvironment||auth(),AccountService.onLogin(function(){window.LocalEnvironment||auth()})}]),app.factory("ScrollBarService",[function(){var domsMap={},isIE8=!1,mCustomScrollbarScrollHandler=function(){};return $(".ie8").length>0&&(isIE8=!0),{scroll:function(name,fn){domsMap[name]?isIE8?mCustomScrollbarScrollHandler=function(self){fn(-self.mcs.top)}:$(domsMap[name]).scroll(function(){var scrollTop=$(domsMap[name]).scrollTop();fn(scrollTop)}):$(window).one("scrollBar"+name,function(){isIE8?mCustomScrollbarScrollHandler=function(self){fn(-self.mcs.top)}:$(document).on("ps-scroll-y",function(event){if(event.target==domsMap[name][0]){var scrollTop=$(domsMap[name]).scrollTop();fn(scrollTop)}})})},scrollTop:function(name,top){_.isNumber(top)||(top=0),isIE8?$(domsMap[name]).mCustomScrollbar("scrollTo",top):$(domsMap[name]).scrollTop(top),this.update(name)},getScrollTop:function(name){return isIE8?$(domsMap[name]).find(".mCSB_dragger").position().top:$(domsMap[name]).scrollTop()},update:function(name){isIE8||setTimeout(function(){$(domsMap[name]).perfectScrollbar("update")},0)},addDom:function(name,dom,scope){isIE8?$(dom).mCustomScrollbar({theme:"dark-thick",scrollInertia:50,autoHideScrollbar:!1,callbacks:{onScroll:function(){mCustomScrollbarScrollHandler(this)}}}):$(dom).perfectScrollbar({suppressScrollX:!0,wheelPropagation:!0}),domsMap[name]=dom,$(window).trigger("scrollBar"+name)}}}]),app.factory("NoteListScrollService",["ScrollBarService","TaskService","GlobalConfigService",function(ScrollBarService,TaskService,GlobalConfigService){function getDataList(){return bindInfo.scope[bindInfo.dataListName]}function getViewList(){return bindInfo.scope[bindInfo.viewListName]}function setViewList(list){bindInfo.scope[bindInfo.viewListName]=list}function setViewTop(top){bindInfo.scope[bindInfo.viewTopName]=top}function sliceData(scrollTop){var top=Math.floor(scrollTop/noteTitleHeight),start=Math.floor(top/updateInterval+.5)*updateInterval-topMinHiddenHeight;start<0&&(start=0),oldStart!=start&&(oldStart=start,updateVisibleNoteList(start))}function updateVisibleNoteList(start){$.isNumeric(start)||(start=oldStart);var dataList=getDataList(),viewList=getViewList(),len=dataList.length;start+visibleMaxLength>len&&(start=len-visibleMaxLength,start<0&&(start=0));var sliceList=dataList.slice(start,start+visibleMaxLength);sliceList.length>0&&sliceList.length==viewList.length&&0===_.difference(sliceList,viewList).length&&sliceList[0].sync_id==viewList[0].sync_id||(setViewList(sliceList),setViewTop(noteTitleHeight*start),bindInfo.scope.$$phase||bindInfo.scope.$apply())}var bindInfo={},topMinHiddenHeight=5,updateInterval=10,noteTitleHeight=GlobalConfigService.NOTE_TITLE_HEIGHT,visibleMaxLength=GlobalConfigService.VISIBLE_MAX_LENGTH,oldStart=0;return ScrollBarService.scroll("NoteList",function(scrollTop){sliceData(scrollTop)}),{bind:function(scope,dataListName,viewListName,viewTopName){bindInfo.scope=scope,bindInfo.dataListName=dataListName,bindInfo.viewListName=viewListName,bindInfo.viewTopName=viewTopName},update:function(){updateVisibleNoteList()}}}]),app.factory("SyncDiffManageService",["DataEventService","DataService","GlobalConfigService","OnlineDataService","DataMergeService","UtilService","TaskService","FolderListFindService","NoteListFindService","NoteService",function(DataEventService,DataService,GlobalConfigService,OnlineDataService,DataMergeService,UtilService,TaskService,FolderListFindService,NoteListFindService,NoteService){function update(callback){var version=GlobalConfigService.getConfig("noteVersion");OnlineDataService.getDiff(version).then(function(data){if(UtilService.isSupportOfflineDataService()){var agreeTime=data.agree,localAgreeTime=window.localStorage.getItem("agree_time");if(_.isNumber(agreeTime)&&localAgreeTime!=agreeTime)return void window.top.location.reload()}var version=data.note_version;GlobalConfigService.setConfig("timeDiff",UtilService.getTimeDiff(data.timestamp)),GlobalConfigService.setConfig("noteVersion",version),DataService.update({type:DataEventService.UPDATE,dataName:DataEventService.VERSION,data:version}),digistNoteData(data),callback&&callback()})}function digistNoteData(data){data.note.delete.length>0&&_.each(data.note.delete,function(sync_id){var note=NoteListFindService.findNoteBySyncId(sync_id);note&&DataService.update({type:DataEventService.REMOVE,dataName:DataEventService.NOTE,data:note})}),data.folder.delete.length>0&&_.each(data.folder.delete,function(sync_id){var folder=FolderListFindService.findFolderBySyncId(sync_id);folder&&DataService.update({type:DataEventService.REMOVE,dataName:DataEventService.FOLDER,data:folder})}),data.folder.update.length>0&&_.each(data.folder.update,function(folder){DataMergeService.merge(DataEventService.FOLDER,folder)}),data.note.update.length>0&&_.each(data.note.update,function(note){tabId!=note.tab_id&&(NoteService.filterAttrName(note),DataMergeService.merge(DataEventService.NOTE,note))})}var tabId=GlobalConfigService.TAB_ID;return window.LocalEnvironment&&(window.diff=update,window.digistNoteData=digistNoteData),{update:update,digistNoteData:digistNoteData}}]),app.factory("AccountService",["TaskService",function(TaskService){var _isLogin=!0,service={};return service.logged=function(){_isLogin=!0,$(window).trigger("noteAppLogged")},service.reLogin=function(){_isLogin=!1,TaskService.fire("MainCtrl.relogin")},service.isLogin=function(){return _isLogin},service.onLogin=function(fn){$(window).on("noteAppLogged",fn)},service}]),app.factory("RtfService",["$compile","GlobalConfigService",function($compile,GlobalConfigService){function elt(tag,content,className,style){var e=document.createElement(tag);if(className&&(e.className=className),style&&(e.style.cssText=style),"string"==typeof content)e.appendChild(document.createTextNode(content));else if(content)for(var i=0;i<content.length;++i)e.appendChild(content[i]);return e}function isRtfModel(){return 1==_mode}function isBlockStyle(style){return _.indexOf(_blockStyles,style)>-1}function isAlignStyle(style){return _.indexOf(_alignStyles,style)>-1}function isInlineStyle(style){return _.indexOf(_inlineStyles,style)>-1}function isConcatStyle(style){return _.indexOf(_concatStyles,style)>-1}function validAlignment(alignStyle,blockStyle){return!(_.indexOf(_alignStyles,alignStyle)<0)&&_.indexOf(_allowOverlap[alignStyle],blockStyle)>-1}function isCompactStyle(curStyles,tStyle){var curBlock=curStyles[0],curAlign=curStyles[1];return isBlockStyle(tStyle)&&curBlock==NORMAL?validAlignment(curAlign,tStyle):!!isAlignStyle(tStyle)&&validAlignment(tStyle,curBlock)}function isImageLine(editor,lineNo){var className=editor.lineInfo(lineNo).wrapClass;return className&&className.indexOf("img-line")>-1}function isCompactInlineStyle(blockStyle,inlineStyle){var isCompact=!0;if(inlineStyle==NORMAL_INLINE)return isCompact;var rejectStyles=_rejectStyles[blockStyle];return _.isArray(rejectStyles)&&_.indexOf(rejectStyles,inlineStyle)>-1&&(isCompact=!1),isCompact}function sortStyle(styles){var result=[];return _.each(allStyles,function(style){_.indexOf(styles,style)>-1&&result.push(style)}),isBlockStyle(result[0])||result.unshift(NORMAL),1==styles.length&&result.push(LEFT),result}function getStyleByLineNo(editor,lineNo){var className=editor.lineInfo(lineNo).textClass,styles=[];return _.isString(className)?(className.replace(/rtf-([a-z_]{1,15})/g,function(whole,m1){return styles.push(m1),whole}),styles.length>0?sortStyle(styles):[NORMAL,LEFT]):[NORMAL,LEFT]}function getMarkRange(mark){var range,markedSpans=mark.lines[0].markedSpans,lineNo=mark.lines[0].lineNo();return _.each(markedSpans,function(span){span.marker.id==mark.id&&(range={from:{line:lineNo,ch:span.from},to:{line:lineNo,ch:span.to}})}),range}function getStyleByRange(editor,range){if(range.from.ch==range.to.ch&&0===range.from.ch)return[NORMAL_INLINE];var marks=editor.findMarks(range.from,range.to),styles=[];if(_.isArray(marks)&&marks.length>0){if(1==marks.length&&range.from.ch==range.to.ch){var markRange=getMarkRange(marks[0]);if(markRange.from.ch==range.from.ch)return[NORMAL_INLINE]}var rangeMap=_.range(range.from.ch,range.to.ch);return _.each(marks,function(mark){if(_.isString(mark.className)&&!(mark.className.indexOf("rtf-")<0)){var markRange=getMarkRange(mark);rangeMap=_.difference(rangeMap,_.range(markRange.from.ch,markRange.to.ch));var style=mark.className.replace("rtf-","");_.indexOf(styles,style)<0&&styles.push(style)}}),rangeMap.length>0&&styles.push(NORMAL_INLINE),styles}return[NORMAL_INLINE]}function getStyle(editor,range){var styles=getStyleByLineNo(editor,range.from.line),inline=getStyleByRange(editor,range);return{align:[styles[1]],block:[styles[0]],inline:inline}}function getStyles(editor,ranges){var collect={align:[],block:[],inline:[]};return _.each(ranges,function(range){if(!isImageLine(editor,range.from.line)){var styleInfo=getStyle(editor,range);collect.align=_.union(collect.align,styleInfo.align),collect.block=_.union(collect.block,styleInfo.block),collect.inline=_.union(collect.inline,styleInfo.inline)}}),collect}function toPos(range){return range.anchor.ch<range.head.ch?{from:{ch:range.anchor.ch,line:range.anchor.line},to:{ch:range.head.ch,line:range.anchor.line}}:{from:{ch:range.head.ch,line:range.anchor.line},to:{ch:range.anchor.ch,line:range.anchor.line}}}function spliteRangeToLinesX(from,to,editor){var ranges=[];return ranges.push({from:{ch:from.ch,line:from.line},to:{ch:editor.lineInfo(from.line).text.length,line:from.line}}),_.times(to.line-from.line-1,function(i){var lineNo=from.line+i+1;ranges.push({from:{ch:0,line:lineNo},to:{ch:editor.lineInfo(lineNo).text.length,line:lineNo}})}),ranges.push({from:{ch:0,line:to.line},to:{ch:to.ch,line:to.line}}),ranges}function spliteRangeToRanges(range,editor){return range.anchor.line===range.head.line?[toPos(range)]:range.anchor.line<range.head.line?spliteRangeToLinesX(range.anchor,range.head,editor):spliteRangeToLinesX(range.head,range.anchor,editor)}function getRanges(editor){var selections=editor.listSelections();if(0===selections.length)return[];var ranges=[];return _.each(selections,function(range){ranges=ranges.concat(spliteRangeToRanges(range,editor))}),ranges}function modifyStatus(rtfBtnStatus,style,status){rtfBtnStatus[style]&&(rtfBtnStatus[style]=status)}function getRtfBtnStatus(editor,defaultRtfBtnStatus,inlineStyleFollowStatus){var ranges=getRanges(editor),collect=getStyles(editor,ranges),rtfBtnStatus=_.clone(defaultRtfBtnStatus);return 1==collect.block.length&&modifyStatus(rtfBtnStatus,collect.block[0],ACTIVE_STATUS),1==collect.inline.length&&modifyStatus(rtfBtnStatus,collect.inline[0],ACTIVE_STATUS),1==collect.align.length&&modifyStatus(rtfBtnStatus,collect.align[0],ACTIVE_STATUS),_.each(collect.block,function(blockStyle){validAlignment(CENTER,blockStyle)||modifyStatus(rtfBtnStatus,CENTER,DISABLED_STATUS)}),_.each(collect.block,function(blockStyle){_.isArray(_rejectStyles[blockStyle])&&_.each(_rejectStyles[blockStyle],function(inlineStyle){modifyStatus(rtfBtnStatus,inlineStyle,DISABLED_STATUS)})}),selectionEmpty(ranges)&&_.each(inlineStyleFollowStatus.info,function(val,key){rtfBtnStatus[key]=val}),_currentRtfBtnStatus=rtfBtnStatus,rtfBtnStatus}function selectionEmpty(ranges){var isEmpty=!0;return _.isArray(ranges)&&ranges.length>0&&_.each(ranges,function(range){range.from.ch!=range.to.ch&&(isEmpty=!1)}),isEmpty}function marksCollect(marks){var markMap={};return markMap[BOLD]=[],_.each(marks,function(mark){var className=mark.className;if(_.isString(className)&&className.indexOf("rtf-")>-1){className=className.replace("rtf-","");var markRange=getMarkRange(mark);markMap[className].push(markRange)}}),markMap}function arrayToRanges(array,line){var ranges=[],range={from:{line:line},to:{line:line}},curNum=null,last=array.length-1;return array=array.sort(function(a,b){return a-b}),_.each(array,function(num,i){_.isNumber(curNum)?num-curNum==1?curNum=num:(range.to.ch=curNum+1,ranges.push(range),range={from:{line:line},to:{line:line}},range.from.ch=num,curNum=num):(range.from.ch=num,curNum=num),i==last&&(range.to.ch=curNum+1,ranges.push(range))}),ranges}function unionRanges(ranges1,ranges2){if(0===ranges1.length)return ranges2;var line=ranges2[0].from.line,ranges1ToArray=[],ranges2ToArray=[];return _.each(ranges1,function(range){ranges1ToArray=_.union(ranges1ToArray,_.range(range.from.ch,range.to.ch))}),_.each(ranges2,function(range){ranges2ToArray=_.union(ranges2ToArray,_.range(range.from.ch,range.to.ch))}),ranges1ToArray=_.union(ranges1ToArray,ranges2ToArray),arrayToRanges(ranges1ToArray,line)}function differenceRanges(ranges1,ranges2){if(0===ranges1.length)return[];var line=ranges2[0].from.line,ranges1ToArray=[],ranges2ToArray=[];return _.each(ranges1,function(range){ranges1ToArray=_.union(ranges1ToArray,_.range(range.from.ch,range.to.ch))}),_.each(ranges2,function(range){ranges2ToArray=_.union(ranges2ToArray,_.range(range.from.ch,range.to.ch))}),ranges1ToArray=_.difference(ranges1ToArray,ranges2ToArray),arrayToRanges(ranges1ToArray,line)}function markMerge(curCollect,addCollect){var defaultCollect={};return defaultCollect[BOLD]=[],curCollect=_.extend(defaultCollect,curCollect),_.each(curCollect,function(ranges,key){_.isArray(addCollect[NORMAL_INLINE])&&addCollect[NORMAL_INLINE].length>0?defaultCollect[key]=differenceRanges(ranges,addCollect[NORMAL_INLINE]):_.isArray(addCollect[key])&&addCollect[key].length>0&&(defaultCollect[key]=unionRanges(ranges,addCollect[key]))}),defaultCollect}function addMarksByCollect(editor,collect){_.each(collect,function(ranges,style){var className="rtf-"+style;_.each(ranges,function(range){editor.markText({line:range.from.line,ch:range.from.ch},{line:range.to.line,ch:range.to.ch},{className:className})})})}function cleanMarks(marks){_.each(marks,function(mark){mark.clear()})}function addInlineStyle(editor,ranges,style){_.each(ranges,function(range){if(!isImageLine(editor,range.from.line)&&range.from.ch!=range.to.ch){var blockStyle=getStyleByLineNo(editor,range.from.line)[0];if(isCompactInlineStyle(blockStyle,style)){var marks=editor.findMarks(range.from,range.to),collect=marksCollect(marks),addCollect={};addCollect[style]=[range],collect=markMerge(collect,addCollect),cleanMarks(marks),addMarksByCollect(editor,collect)}}})}function addBlockStyle(editor,ranges,style,originStyle){if(!(style==NORMAL&&originStyle==NORMAL||style==LEFT&&originStyle==LEFT)){var className="rtf-"+style;_.each(ranges,function(range){if(!isImageLine(editor,range.from.line)&&style!=IMAGE){var curStyles=getStyleByLineNo(editor,range.from.line);if(style==NORMAL||style==LEFT)_.indexOf(curStyles,originStyle)>-1&&(originStyle.indexOf(TODO)>-1&&(editor.lineInfo(range.from.line).widgets[0].clear(),editor.removeLineClass(range.from.line,"wrap","todo-line")),editor.removeLineClass(range.from.line,"text","rtf-"+originStyle));else if(isCompactStyle(curStyles,style))editor.addLineClass(range.from.line,"text","rtf-"+style);else if(_.each(curStyles,function(style){style.indexOf(TODO)>-1&&(editor.lineInfo(range.from.line).widgets[0].clear(),editor.removeLineClass(range.from.line,"wrap","todo-line")),editor.removeLineClass(range.from.line,"text","rtf-"+style);
}),editor.addLineClass(range.from.line,"text",className),className.indexOf(TODO)>-1){var todoNode=null;todoNode=className.indexOf(TODO_CHECKED)>-1?elt("div",null,"line-todo line-todo-checked",null):elt("div",null,"line-todo line-todo-unchecked",null),editor.addLineWidget(range.from.line,todoNode,{handleMouseEvents:!0}),editor.addLineClass(range.from.line,"wrap","todo-line")}}}),style==QUOTE&&isConcatStyle(QUOTE)&&_.each(ranges,function(range,i){0!==i&&addConcatStyle(editor,range)}),cleanConcatStyle(editor)}}function addConcatStyle(editor,range){var className="rtf-"+CONCAT;editor.addLineClass(range.from.line,"text",className)}function cleanConcatStyle(editor){var prevLine=null;editor.eachLine(function(line){var lineNo=line.lineNo();if(0===lineNo)return void(prevLine=line);var textClass=line.textClass,prevTextClass=prevLine.textClass,needClear=!0;_.isString(textClass)&&_.isString(prevTextClass)&&textClass.indexOf(QUOTE)>-1&&prevTextClass.indexOf(QUOTE)>-1&&(needClear=!1),needClear&&editor.removeLineClass(lineNo,"text","rtf-"+CONCAT),prevLine=line})}function actualStyle(style){var status=_currentRtfBtnStatus[style];if(isBlockStyle(style)){if(status==DISABLED_STATUS)return!1;if(status==ACTIVE_STATUS)return NORMAL;if(status==NORMAL_STATUS)return style}if(isAlignStyle(style)){if(status==DISABLED_STATUS)return!1;if(status==ACTIVE_STATUS)return LEFT;if(status==NORMAL_STATUS)return style}if(isInlineStyle(style)){if(status==DISABLED_STATUS)return!1;if(status==ACTIVE_STATUS)return NORMAL_INLINE;if(status==NORMAL_STATUS)return style}return!1}function addStyle(editor,style,inlineStyleFollowStatus){var originStyle=style;if(style=actualStyle(style)){var ranges=getRanges(editor);isBlockStyle(style)||isAlignStyle(style)?addBlockStyle(editor,ranges,style,originStyle):selectionEmpty(ranges)?style==NORMAL_INLINE?inlineStyleFollowStatus.info[originStyle]=NORMAL_STATUS:inlineStyleFollowStatus.info[originStyle]=ACTIVE_STATUS:addInlineStyle(editor,ranges,style,originStyle),editor.refresh(),getStyleData(editor)}}function getActiveInlineStyles(){var inlineStyles=[];return _.each(_currentRtfBtnStatus,function(status,style){status==ACTIVE_STATUS&&inlineStyles.push(style)}),0===inlineStyles.length&&inlineStyles.push(NORMAL_INLINE),inlineStyles}function followModel(editor,addRanges,removeRanges,inlineStyleFollowStatus){var ranges=getRanges(editor);if(selectionEmpty(ranges)){var activeInlineStyles=getActiveInlineStyles(inlineStyleFollowStatus);_.each(removeRanges,function(range){addInlineStyle(editor,[range],NORMAL_INLINE)}),_.each(addRanges,function(range){_.each(activeInlineStyles,function(style){addInlineStyle(editor,[range],style)})})}}function isKeepStyle(styles){return _.indexOf(styles,UL)>-1||(_.indexOf(styles,TODO)>-1||(_.indexOf(styles,TODO_CHECKED)>-1||(_.indexOf(styles,NORMAL)>-1&&_.indexOf(styles,CENTER)>-1||_.indexOf(styles,HEAD)>-1&&_.indexOf(styles,CENTER)>-1)))}function preInput(editor,prevlineNo,callback){var styles=getStyleByLineNo(editor,prevlineNo),prevText=editor.lineInfo(prevlineNo).text,line=prevlineNo+1;if(isKeepStyle(styles))prevText.length>0?(editor.replaceSelection("\n","end"),_.each(styles,function(style){style==TODO_CHECKED&&(style=TODO),addBlockStyle(editor,[{from:{line:line,ch:0},to:{line:line,ch:0}}],style,style)}),editor.refresh(),callback&&callback()):(addBlockStyle(editor,[{from:{line:prevlineNo,ch:0},to:{line:prevlineNo,ch:0}}],NORMAL,styles[0]),callback&&callback(),editor.refresh());else{if(styles[0]==NORMAL){if(/^\d{1,3}\. ./.test(prevText)){editor.replaceSelection("\n","end");var num=parseInt(prevText.match(/^\d{1,3}/)[0],10)+1;return num<1e3&&editor.replaceRange(num+". ",{line:line,ch:0},{line:line,ch:0}),void(callback&&callback())}if(/^\d{1,3}\. $/.test(prevText))return editor.replaceRange("",{line:prevlineNo,ch:0},{line:prevlineNo}),void(callback&&callback())}editor.replaceSelection("\n","end")}}function addExtraAttr(prevLineStyleData,curlineStyleData){if(curlineStyleData||prevLineStyleData)return!prevLineStyleData&&curlineStyleData?void(isConcatStyle(_mapToStyle[curlineStyleData.type])&&(curlineStyleData.first=1)):!curlineStyleData&&prevLineStyleData?void(isConcatStyle(_mapToStyle[prevLineStyleData.type])&&(prevLineStyleData.last=1)):void(curlineStyleData.type!=prevLineStyleData.type&&(isConcatStyle(_mapToStyle[curlineStyleData.type])&&(curlineStyleData.first=1),isConcatStyle(_mapToStyle[prevLineStyleData.type])&&(prevLineStyleData.last=1)))}function getStyleData(editor){var styleData={},prevLineStyleData=null,lastLineNo=editor.lastLine(),firstLineNo=editor.firstLine(),lastLine=editor.getLineHandle(lastLineNo),firstLine=editor.getLineHandle(firstLineNo),needClearFirst=!1,needClearLast=!1;return"cm-polish-line"==lastLine.wrapClass&&0===lastLine.text.length&&(needClearLast=!0),"cm-polish-line"==firstLine.wrapClass&&0===firstLine.text.length,editor.eachLine(function(line){var lineNo=line.lineNo();if(!(0===lineNo&&needClearFirst||lineNo===lastLineNo&&needClearLast)){var lineStyleData={};if(isImageLine(editor,lineNo))lineStyleData.type=_typeMap[IMAGE],lineStyleData.content=editor.lineInfo(lineNo).text;else{var styles=getStyleByLineNo(editor,lineNo),blockStyle=styles[0],alignStyle=styles[1];lineStyleData.type=_typeMap[blockStyle],lineStyleData.length=editor.lineInfo(lineNo).text.length,_.isNumber(_alignMap[alignStyle])&&(lineStyleData.alignment=_alignMap[alignStyle]),getInlineStyleData(editor,lineNo,lineStyleData)}addExtraAttr(prevLineStyleData,lineStyleData),needClearFirst?styleData[lineNo-1]=lineStyleData:styleData[lineNo]=lineStyleData,prevLineStyleData=lineStyleData}}),addExtraAttr(prevLineStyleData,null),styleData}function getInlineStyleData(editor,lineNo,lineData){var markers=editor.findMarks({line:lineNo,ch:0},{line:lineNo});_.each(markers,function(marker){var pos=getMarkRange(marker),className=marker.className;if(_.isString(className)&&className.indexOf("rtf-")>-1){var inlineStyle=className.replace("rtf-","");_.isArray(lineData[inlineStyle])?lineData[inlineStyle].push(pos.from.ch+","+(pos.to.ch-pos.from.ch)):lineData[inlineStyle]=[pos.from.ch+","+(pos.to.ch-pos.from.ch)]}})}function setInlineStyleData(editor,styleData,lineNo){_.each(_inlineStyles,function(style){_.isArray(styleData[style])&&_.each(styleData[style],function(pos){pos=pos.split(",");var start=parseInt(pos[0],10),len=parseInt(pos[1],10),from={line:lineNo,ch:start},to={line:lineNo,ch:start+len};addInlineStyle(editor,[{from:from,to:to}],style,style)})})}function setAlignment(editor,styleData,lineNo){_.isNumber(styleData.alignment)&&_.each(_alignMap,function(val,style){styleData.alignment===val&&addBlockStyle(editor,[{from:{line:lineNo,ch:0},to:{line:lineNo,ch:0}}],style,style)})}function setStyleData(editor,styleData){editor.eachLine(function(line){var lineNo=line.lineNo(),index=lineNo;if(!(index<0)){var style=styleData[index];style&&(style.type!=_typeMap[NORMAL]&&addBlockStyle(editor,[{from:{line:lineNo,ch:0},to:{line:lineNo,ch:0}}],_mapToStyle[style.type],_mapToStyle[style.type]),style.type==_typeMap[QUOTE]&&isConcatStyle(QUOTE)&&(style.first||addConcatStyle(editor,{from:{line:lineNo,ch:0},to:{line:lineNo,ch:0}})),setAlignment(editor,style,lineNo),setInlineStyleData(editor,style,lineNo))}})}function hasStyleData(styleData){var bool=!0;return bool}function symbolConvertStyle(editor){var pos=editor.getCursor(),lineNo=pos.line,text=editor.lineInfo(lineNo).text,styles=getStyleByLineNo(editor,lineNo),blockStyle=styles[0],alignStyle=styles[1];blockStyle==NORMAL&&/^\- /.test(text)&&alignStyle==LEFT&&(editor.replaceRange("",{line:lineNo,ch:0},{line:lineNo,ch:2}),addBlockStyle(editor,[{from:{line:lineNo,ch:0},to:{line:lineNo,ch:0}}],UL,UL),editor.refresh())}function mockStyle(editor,curLine,originLine,originStyleData){if(originStyleData=toJson(originStyleData),originStyleData[originLine]){var type=originStyleData[originLine].type,style=(originStyleData[originLine].alignment,_mapToStyle[type]);_.isArray(_mockStyleMap[style])&&_.each(_mockStyleMap[style],function(mockStyle){addBlockStyle(editor,[{from:{line:curLine,ch:0},to:{line:curLine,ch:0}}],mockStyle,mockStyle)})}}function toJson(string){if(!_.isString(string))return{};if(0===string.length)return{};try{return JSON.parse(string)}catch(err){return{}}}function cloneStyle(editor,targetLine,cloneLine){var styles=getStyleByLineNo(editor,targetLine);_.each(styles,function(style){addBlockStyle(editor,[{from:{line:cloneLine,ch:0},to:{line:cloneLine,ch:0}}],style,style)})}function clearAllLineStyle(editor,lineNo){var styles=getStyleByLineNo(editor,lineNo),block=styles[0],align=styles[1];addBlockStyle(editor,[{from:{line:lineNo,ch:0},to:{line:lineNo,ch:0}}],NORMAL,block),addBlockStyle(editor,[{from:{line:lineNo,ch:0},to:{line:lineNo,ch:0}}],LEFT,align),editor.refresh()}function deleteKeyHandler(editor){var cursor=editor.listSelections(),lineInfo=editor.lineInfo(cursor[0].head.line),textClass=lineInfo.textClass;if(_.isString(textClass)&&textClass.indexOf("rtf")>-1){var text=lineInfo.text;if(1==cursor.length&&0===text.length)return void clearAllLineStyle(editor,cursor[0].head.line)}else if(/^\d{1,3}\. $/.test(lineInfo.text))return void editor.replaceRange("",{line:lineInfo.line,ch:0},{line:lineInfo.line});editor.deleteH(-1,"char")}function todoToggle(ifChecked){addStyle(editor,style,inlineStyleFollowStatus)}var _currentRtfBtnStatus,HEAD="head",UL="ul",BOLD="bold",QUOTE="quote",CENTER="center",LEFT="left",TODO="todo",TODO_CHECKED="todo_checked",IMAGE="image",NORMAL="normal",NORMAL_INLINE="normal_in",CONCAT="concat",ACTIVE_STATUS="active",DISABLED_STATUS="disabled",NORMAL_STATUS="normal",allStyles=[HEAD,UL,QUOTE,TODO,TODO_CHECKED,IMAGE,NORMAL,CENTER,LEFT,BOLD,NORMAL_INLINE],_blockStyles=[HEAD,UL,TODO,TODO_CHECKED,QUOTE,IMAGE,NORMAL],_inlineStyles=[BOLD,NORMAL_INLINE],_concatStyles=[UL,TODO,TODO_CHECKED],_alignStyles=[CENTER,LEFT],_allowOverlap={};_allowOverlap[LEFT]=[HEAD,UL,QUOTE,NORMAL],_allowOverlap[CENTER]=[HEAD,NORMAL];var _rejectStyles={};_rejectStyles[HEAD]=[BOLD];var _typeMap={};_typeMap[NORMAL]=1,_typeMap[IMAGE]=2,_typeMap[HEAD]=3,_typeMap[QUOTE]=4,_typeMap[UL]=5,_typeMap[TODO]=6,_typeMap[TODO_CHECKED]=7;var _mapToStyle=[null,NORMAL,IMAGE,HEAD,QUOTE,UL,TODO,TODO_CHECKED],_alignMap={};_alignMap[CENTER]=1;var _mode=0,LINE_STYLE_MARK_PRE_NAME="line-style-mark-",_mockStyleMap={};return _mockStyleMap[HEAD]=[HEAD],_mockStyleMap[UL]=[UL,CONCAT],{modifyStatus:function(){isRtfModel()&&addStyle.apply(null,arguments)},getRtfBtnStatus:function(editor){if(isRtfModel())return getRtfBtnStatus.apply(null,arguments)},addStyle:function(){isRtfModel()&&addStyle.apply(null,arguments)},setStyleData:function(editor,styleData,content){isRtfModel()&&(styleData=toJson(styleData),styleData=AppStyleDataToStyleData(styleData,content),setStyleData(editor,styleData))},getStyleData:function(editor){cleanConcatStyle(editor);var styleData=getStyleData(editor);return hasStyleData(styleData)?(styleData=StyleDataToAppStyleData(styleData),JSON.stringify(styleData)):""},followModel:function(){isRtfModel()&&followModel.apply(null,arguments)},preInput:function(){isRtfModel()&&preInput.apply(null,arguments)},symbolConvertStyle:function(){isRtfModel()&&symbolConvertStyle.apply(null,arguments)},mockStyle:mockStyle,toJson:toJson,deleteKeyHandler:deleteKeyHandler,cloneStyle:function(){isRtfModel()&&cloneStyle.apply(null,arguments)},setMode:function(val){_mode=val},isRtfMode:function(){return 1==_mode},todoToggle:todoToggle,getStyleByRange:getStyleByRange,LINE_STYLE_MARK_PRE_NAME:LINE_STYLE_MARK_PRE_NAME}}]),app.factory("MoodService",[function(){function bind(bindFn){bindFnList.push(bindFn)}function trigger(origin,target){_.each(bindFnList,function(bindFn){bindFn(origin,target)})}var service={type:{},info:{}};service.type.EDIT="edit",service.type.MULTI="multi",service.type.PREVIEW="preview",service.type.ALL="all",service.info.BLUR="blur",service.info.FOCUS="focus",service.curMood={type:service.type.EDIT,info:service.info.BLUR};var _origin,_target,bindFnList=[];return service.change=function(mood){if(service.curMood.type!=mood.type||service.curMood.info!=mood.info){var curMood=service.curMood;service.curMood=mood,_origin=curMood,_target=mood,trigger(curMood,mood)}},service.isChange=function(from,to){return from==service.type.ALL&&to==_target.type||(from==_origin.type&&to==service.type.ALL||from==_origin.type&&to==_target.type)},service.isType=function(type){return service.curMood.type==type},service.isInfo=function(info){return service.curMood.info==info},service.getMood=function(){return service.curMood},service.onChange=function(bindFn){bind(bindFn)},service}]),app.factory("StatusService",["$rootScope",function($rootScope){$rootScope.globalStatus={};var service={};service.name={},service.name.CUR_FOLDER="curFolder",service.name.CUR_KEYWORD="curKeyword",service.name.CUR_NOTE="curNote",service.name.CUR_SEARCH_TYPE="curSearchType",service.name.SELECTED_NOTES="selectedNotes",service.name.PREVIEW_IMAGE_LOADING="previewImageLoading";var names=["curFolder","curKeyword","curNote","curSearchType","selectedNotes","previewImageLoading"];return service.isValue=function(name,value){if(_.indexOf(names,name)<0)throw"StatusService.isValue:unknown name";$rootScope.globalStatus[name]===value},service.setValue=function(name,value){if(_.indexOf(names,name)<0)throw"StatusService.setValue:unknown name";_.isArray(value)&&(value=_.clone(value)),$rootScope.globalStatus[name]=value},service.getValue=function(name,value){if(_.indexOf(names,name)<0)throw"StatusService.getValue:unknown name";return $rootScope.globalStatus[name]},service}]),app.factory("ImmersiveModeService",["$rootScope","$timeout",function($rootScope,$timeout){function openImmersiveMode(isOpen){0==isOpen?($rootScope.ifPreventSide=!0,$(".note-right").removeClass("fadeIn"),$(".note-left").show(),$timeout(function(){$(".toolbar-view").removeClass("slideInDown"),$(".edit-status").removeClass("slideInDown"),$(".note-right").removeClass("note-immersive"),$(".wrapper").addClass("immersiveOff"),$(".note-left").addClass("fadeOut"),$(".note-right").addClass("fadeOut"),$rootScope.ifImmersive=!!isOpen,$timeout(function(){$(".wrapper").removeClass("immersiveOff"),$(".note-left").addClass("fadeIn"),$(".note-right").addClass("fadeIn"),$timeout(function(){$(".note-left").removeClass("fadeIn").removeClass("fadeOut"),$(".note-right").removeClass("fadeIn").removeClass("fadeOut"),sessionStorage.length>0&&sessionStorage.removeItem("immersiveCurId")},200)},200)},110)):($rootScope.ifPreventSide=!1,$(".note-left").addClass("fadeOut"),$(".note-right").addClass("fadeOut"),$timeout(function(){$rootScope.ifImmersive=!!isOpen,$(".note-left").hide(),$(".note-right").addClass("note-immersive"),$timeout(function(){$(".note-left").removeClass("fadeOut"),$(".note-right").removeClass("fadeOut"),$(".note-right").addClass("fadeIn"),$(".toolbar-view").addClass("slideInDown"),$(".edit-status").addClass("slideInDown"),$(".edit-status").addClass("fadeIn");var curId="note"+$rootScope.globalStatus.curNote._id;sessionStorage.immersiveCurId=curId},110)},120))}function getImmersiveMode(){return $rootScope.ifImmersive}function immersiveRefresh(callback){if(sessionStorage.immersiveCurId&&sessionStorage.immersiveCurId.length>0){var curId=sessionStorage.immersiveCurId;$rootScope.ifImmersive=!0,$timeout(function(){$("#"+curId).click(),callback&&"function"==typeof callback&&callback(),$(".immersiveOn .note-left").hide(),$(".immersiveOn .note-right").addClass("note-immersive"),$(".immersiveOn .note-right").addClass("fadeIn"),$(".immersiveOn .edit-status").addClass("fadeIn")},1)}else callback&&"function"==typeof callback&&callback()}return{openImmersiveMode:openImmersiveMode,getImmersiveMode:getImmersiveMode,immersiveRefresh:immersiveRefresh}}]),app.run(["AnimationService","UtilService",function(AnimationService,UtilService){AnimationService.add("openDialog",function(){$(".a-dialog-wrap").addClass("on"),$(".a-mask").addClass("on"),$(".a-dialog").addClass("on")}),AnimationService.add("closeDialog",function(){$(".a-dialog").hasClass("on")&&($(".a-login-timeout-dialog").hasClass("on")||($(".a-dialog").removeClass("on"),$(".a-mask").removeClass("on"),$(".a-dialog-wrap").addClass("off"),UtilService.isIE8()?$(".a-dialog-wrap").removeClass("on off"):setTimeout(function(){$(".a-login-timeout-dialog").hasClass("on")||$(".a-dialog-wrap").removeClass("on off")},500)))})}]),app.run(["AnimationService",function(AnimationService){AnimationService.add("openToast",function(){var element=$(".a-tips"),step=0,timer1=null,timer2=null,timer3=null;0==step?(element.addClass("on").css({"margin-left":-element.width()/2+"px"}),timer1=setTimeout(function(){step=1,element.addClass("animate animate-show")},100),timer2=setTimeout(function(){step=2,element.removeClass("animate-show")},3400),timer3=setTimeout(function(){step=0,element.removeClass("animate show on")},3700)):1!=step&&2!=step||(clearTimeout(timer2),clearTimeout(timer3),step=1,element.addClass("animate-show"),timer2=setTimeout(function(){step=2,element.removeClass("animate-show")},3e3),timer3=setTimeout(function(){step=0,element.removeClass("animate show on")},3300))})}]),app.run(["AnimationService",function(AnimationService){AnimationService.add("changeFilterStyle",function(){var filterWrapDom=$(".a-filter-wrap"),width=filterWrapDom.width(),right=width+parseInt(filterWrapDom.css("right"),10)+12;$(".a-search-bar").css("right",right),$(".a-filter-options").css("width",width)})}]),app.run(["AnimationService",function(AnimationService){AnimationService.add("updateProgressBar",function(precent){var progressBarDom=$(".a-upload-progress-bar");progressBarDom.css("width",precent+"%")})}]),app.run(["AnimationService","ScrollBarService",function(AnimationService,ScrollBarService){function flowOutQueue(){return flowing=!0,0==actions.length?void(flowing=!1):(flowOut(actions.shift()),void setTimeout(function(){flowOutQueue()},50))}function flowOut(action){var id=Math.uuid(10),dom=$('<div class="flow-out" id="'+id+'"><span>'+action.char+"</span></div>");$(".edit-area").append(dom),dom=$("#"+id),dom.css({left:action.exitPos.left,top:action.exitPos.top}).show(),dom.addClass("flow-out-animate");var random=Math.floor(300*(Math.random()-.5));dom.css({left:action.exitPos.left+600+random,opacity:0}),dom.find("span").css({top:1500,transform:"rotate(1000deg)"}),setTimeout(function(){dom.remove(),ScrollBarService.update("EditWrap")},2e3)}var actions=[],flowing=!1;AnimationService.add("charFlowOut",function(exitPos,char){actions.push({exitPos:exitPos,char:char}),flowing||flowOutQueue()})}]),app.run(["AnimationService","TaskService",function(AnimationService,TaskService){function flyInDeleteButton(copyContainer){var toWidth=50,viewWidth=copyContainer.width(),viewHeight=copyContainer.height(),conWidth=copyContainer.find(".copy0").width(),scale=toWidth/conWidth,deleteBtnW=66,deleteBtnH=38,deleteBtnRight=14,deleteBtnTop=12,x=viewWidth/2-(deleteBtnW/2+deleteBtnRight),y=-(viewHeight/2-(deleteBtnH/2+deleteBtnTop));TweenLite.to(copyContainer,.15,{scaleX:.9,scaleY:.9,delay:0,ease:Quad.easeIn}),TweenLite.to(copyContainer,.35,{scaleX:scale,scaleY:scale,delay:.15,ease:Linear.easeNone}),TweenLite.to(copyContainer,.35,{x:x,delay:.15,ease:Sine.easeInOut}),TweenLite.to(copyContainer,.35,{y:y+50,delay:.15,ease:Cubic.easeIn}),TweenLite.to(copyContainer,.1,{y:y,scaleX:scale,scaleY:.001,delay:.5,ease:Linear.easeNone})}function openDeleteButton(deteteBtn){setTimeout(function(){deteteBtn.addClass("delete-button-active-intro")},200),setTimeout(function(){deteteBtn.removeClass("delete-button-active-intro")},750)}AnimationService.add("deleteNote",function(callback){var copyContainer=$(".a-edit-wrap-copy"),deteteBtn=$(".a-delete-button-container");copyContainer.hasClass("on")||TaskService.fire("NoteCopyDirc.show"),flyInDeleteButton(copyContainer),openDeleteButton(deteteBtn),setTimeout(function(){TaskService.fire("NoteCopyDirc.hide"),TweenLite.set(copyContainer,{scaleX:1,scaleY:1,x:0,y:0})},1e3),setTimeout(function(){callback()},300)})}]),app.run(["AnimationService","TaskService",function(AnimationService,TaskService){AnimationService.add("deleteImage",function(dom,callback){var height=dom.height();dom.width();dom.css({height:height}),setTimeout(function(){dom.css({overflow:"hidden",transition:"all .5s ease",height:0}),dom.find(".cm-img-wrap").css({transition:"all .5s ease","margin-top":-height,transform:"scaleX(0.8)"}),setTimeout(function(){callback()},600)},100)})}]),app.run(["AnimationService",function(AnimationService){AnimationService.add("deleteNoteInList",function(note,callback){var dom=$("#note"+note._id);dom.length>0?(dom.css({overflow:"hidden",border:"none"}),TweenLite.to(dom,.4,{height:0,delay:0,ease:Cubic.easeOut}),setTimeout(function(){callback()},500)):callback()})}]),app.run(["AnimationService","ScrollBarService",function(AnimationService,ScrollBarService){AnimationService.add("preview",function(type,fn){var previewContainer=$(".a-note-preview"),webContainer=$(".a-web-preview"),imgContainer=$(".a-img-preview");if("web"==type&&(fn&&fn(),$(".a-preview-loading").show(),$(".edit-wrap").addClass("transparent"),previewContainer.addClass("on"),webContainer.addClass("on"),imgContainer.removeClass("on")),"img"==type&&(fn&&fn(),$(".edit-wrap").addClass("transparent"),previewContainer.addClass("on"),imgContainer.addClass("on"),webContainer.removeClass("on")),"loadComplete"==type&&(fn&&fn(),$(".a-preview-loading").hide(),$(".a-page-wrap").css("visibility","visible")),"exit"==type){if(!previewContainer.hasClass("on"))return;fn&&fn(),$(".a-preview-loading").hide(),$(".a-img-preview .preview-img").attr("src","#"),$(".a-page-wrap").css("visibility","hidden"),$(".a-note-preview").scrollTop(0),$(".a-web-preview .page-container").html(""),ScrollBarService.update("Preview"),$(".edit-wrap").removeClass("transparent"),previewContainer.removeClass("on")}})}]),app.run(["AnimationService",function(AnimationService){AnimationService.add("shakeHead",function(dom){dom&&(TweenLite.to(dom,.1,{x:6,delay:0,ease:Quad.easeOut}),TweenLite.to(dom,.1,{x:-6,delay:.1,ease:Quad.easeOut}),TweenLite.to(dom,.1,{x:6,delay:.2,ease:Quad.easeOut}),TweenLite.to(dom,.1,{x:-6,delay:.3,ease:Quad.easeOut}),TweenLite.to(dom,.1,{x:0,delay:.4,ease:Quad.easeOut}))})}]),app.run(["AnimationService","GlobalConfigService",function(AnimationService,GlobalConfigService){AnimationService.add("screenWidthResize",function(){function resize(){2==GlobalConfigService.getConfig("column")?(maxFolderWidth=0,minFolderWidth=0,maxLeftWidth=460,minLeftWidth=350):(maxFolderWidth=285,minFolderWidth=205,maxLeftWidth=745,minLeftWidth=555);var width=$(window).width(),wRate=(width-minWidth)/(maxWidth-minWidth),leftWidth=0,folderWidth=0;width>=maxWidth&&(leftWidth=maxLeftWidth,folderWidth=maxFolderWidth),width<=minWidth&&(leftWidth=minLeftWidth,folderWidth=minFolderWidth),width<maxWidth&&width>minWidth&&(leftWidth=minLeftWidth+(maxLeftWidth-minLeftWidth)*wRate,folderWidth=minFolderWidth+(maxFolderWidth-minFolderWidth)*wRate,leftWidth=Math.floor(leftWidth),folderWidth=Math.floor(folderWidth)),$(".column-1").css({width:folderWidth}),$(".column-2").css({left:folderWidth}),$(".note-left").css({width:leftWidth}),$(".note-right").css({left:leftWidth})}var maxFolderWidth=285,minFolderWidth=205,maxLeftWidth=745,minLeftWidth=555,maxWidth=1080+maxLeftWidth,minWidth=1280;resize(),$(window).on("resize",function(){resize()})})}]),app.run(["AnimationService",function(AnimationService){AnimationService.add("noteHeightResize",function(){function resize(){var height=$(window).height(),noteHeight=height-titleHeight-menuHeight-bottomPadding;noteHeight+=50-noteHeight%50,noteHeight<minHeight&&(noteHeight=minHeight),$(".edit-wrap .note-editor").css({minHeight:noteHeight})}var titleHeight=61,menuHeight=63,bottomPadding=100,minHeight=350;resize(),$(window).on("resize",function(){resize()})})}]),app.filter("titleTime",["$filter","I18NService","GlobalConfigService",function($filter,I18NService,GlobalConfigService){function todayStartTime(timestamp){var today=new Date(timestamp);return today.setHours(0),today.setMinutes(0),today.setSeconds(0),today.setMilliseconds(0),today.valueOf()}var oneDaySecond=864e5;return function(time){var timeDiff=GlobalConfigService.getConfig("timeDiff"),now=(new Date).valueOf()+timeDiff,tst=todayStartTime(now);if(time>=tst){var tempDate=new Date(time),hours=tempDate.getHours(),minutes=tempDate.getMinutes(),prefix="";return prefix=I18NService(hours>=12?"AFTERNOON":"MORNING"),hours=hours>12?hours-12:hours,prefix+hours+":"+(minutes>9?"":"0")+minutes}if(tst-oneDaySecond<=time&&time<tst)return I18NService("YESTERDAY");var tempDate=new Date(time);return tempDate.getFullYear()===(new Date).getFullYear()?tempDate.getMonth()+1+I18NService("MONTH")+tempDate.getDate()+I18NService("DAY"):tempDate.getFullYear()+I18NService("YEAR")+(tempDate.getMonth()+1)+I18NService("MONTH")+tempDate.getDate()+I18NService("DAY")}}]),app.filter("editTime",["$filter","I18NService","GlobalConfigService",function($filter,I18NService,GlobalConfigService){function todayStartTime(timestamp){var today=new Date(timestamp);return today.setHours(0),today.setMinutes(0),today.setSeconds(0),today.setMilliseconds(0),today.valueOf()}function editTime(time){var timeDiff=GlobalConfigService.getConfig("timeDiff"),now=(new Date).valueOf()+timeDiff,today=todayStartTime(now),yesterday=today-ONE_DAY_SECOND,noteDate=new Date(time),todayDate=new Date(today),partOne="";time>now+6e4?partOne=I18NService("FUTURE"):time>=today?partOne=I18NService("TODAY"):time>=yesterday?partOne=I18NService("YESTERDAY"):noteDate.getFullYear()==todayDate.getFullYear()?partOne=noteDate.getMonth()+1+"-"+noteDate.getDate():noteDate.getFullYear()<todayDate.getFullYear()&&(partOne=noteDate.getFullYear()+"-",partOne+=noteDate.getMonth()+1+"-"+noteDate.getDate());var partTwo="",h=noteDate.getHours();partTwo=h>=12?"PM":"AM",h=h>12?h-12:h;var m=noteDate.getMinutes();return partTwo=h+":"+zeroFix(m)+" "+partTwo,partOne+" "+partTwo}function zeroFix(num){return num>9?num:"0"+num}var ONE_DAY_SECOND=864e5;return editTime}]),app.filter("titleEmoji",["EmojiService","$sce","TaskService","ImageStringService","StatusService",function(EmojiService,$sce,TaskService,ImageStringService,StatusService){return function(title){if(!title)return"";var title=ImageStringService.encodeHtmlSymbol(title),keyword=StatusService.getValue(StatusService.name.CUR_KEYWORD);if(_.isString(keyword)&&keyword.length>0){keyword=ImageStringService.encodeHtmlSymbol(keyword);var reg=new RegExp(keyword.replace(/([\-!$%^&*()_+|~=`{}\[\]:";'<>?,.\/])/g,"\\$1"),"g");title=title.replace(reg,"<i>"+keyword+"</i>")}var titleHtml=EmojiService.toImage(title);return $sce.trustAsHtml(titleHtml)}}]),app.filter("isBlank",[function(){return function(note){return!note||!note._id}}]),app.filter("isFavorite",[function(){return function(note){return!!note&&note.favorite+""=="1"}}]),app.filter("isMarkdown",[function(){return function(note){return!!note&&note.markdown+""=="1"}}]),app.filter("isSelected",[function(){return function(note,selectedNotes){return _.indexOf(selectedNotes,note)>-1}}]),app.filter("creatInCall",["$filter","I18NService",function($filter,I18NService){return function(note){if(!note)return"";var callSearchName=note.call_search_name,callSearchNumber=note.call_search_number;return callSearchName?I18NService("CALL_RECORD",callSearchName):!callSearchName&&callSearchNumber?I18NService("CALL_RECORD",callSearchNumber):""}}]),app.filter("folderName",["FolderListFindService","EmojiService","$sce",function(FolderListFindService,EmojiService,$sce){return function(note){if(!note)return"";var folder=FolderListFindService.findFolderByNote(note),title=folder.title.replace(/</g,"&lt;").replace(/>/g,"&gt;");return title=EmojiService.toImage(title),$sce.trustAsHtml(title)}}]),app.filter("modeName",[function(){return function(formatting_mode){_.isNumber(formatting_mode)||(formatting_mode=0);var nameMap=["纯文本模式","富文本模式","Markdown 模式"],name=nameMap[formatting_mode];return name||(name=nameMap[0]),name}}]),app.directive("stopbubble",[function(){return{restrict:"A",link:function(scope,elm,attrs,ctrl){var enableBodyClick=attrs.stopbubble;elm.click(function(event){event.stopPropagation?event.stopPropagation():event.cancelBubble=!0,"bodyclick"==enableBodyClick&&$("body").click()})}}}]),app.directive("stopdragclick",[function(){return{restrict:"A",link:function(scope,elm,attrs,ctrl){var press=!1,pressX=0,pressY=0,dragDistance=0;elm.on("mousedown",function(event){press=!0,pressX=event.pageX,pressY=event.pageY}),elm.on("mousemove",function(event){if(press){var moveX=event.pageX,moveY=event.pageY,w=moveX-pressX,h=moveY-pressY;dragDistance=w*w+h*h}}),elm.click(function(event){dragDistance>100&&(event.stopPropagation?event.stopPropagation():event.cancelBubble=!0),press=!1,dragDistance=0})}}}]),app.directive("layer",["LayerService",function(LayerService){return{restrict:"A",link:function(scope,elm,attrs,ctrl){var params=attrs.layer.split("|"),layerName=params[0],disBodyClick="noGlobalClose"==params[1];LayerService.add(layerName,elm,disBodyClick)}}}]),app.directive("dialog",["DialogService",function(DialogService){return{restrict:"A",link:function(scope,element,attrs,ctrl){scope.dialogContent={},DialogService.addDom(attrs.dialog,element,scope)}}}]),app.directive("appsads",["$rootScope","TaskService","AnimationService",function($rootScope,TaskService,AnimationService){return{restrict:"A",link:function($scope,elm,attrs,ctrl){var apps={notes:{arrowPos:66,itemPos:0,appUrl:"http://www.smartisan.com/apps/notes",appName:"下载锤子便签 APP"}};$scope.apps=apps,$scope.appsKey=["notes"],AnimationService.install("appsAdsInit",function(){for(var i in apps)new QRCode("apps-ads-qrcode-"+i,{text:apps[i].appUrl,width:110,height:110,colorDark:"#7a706b",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H})},"#apps-ads-qrcode-notes")}}}]),app.directive("uploader",["DialogService","AnimationService","ToastService","ErrorService","TaskService","MoodService",function(DialogService,AnimationService,ToastService,ErrorService,TaskService,MoodService){return{restrict:"A",scope:!0,link:function(scope,element,attrs){var uploader,uploadImageButton=element[0],task=TaskService(scope,"UploaderDirc");uploader=new plupload.Uploader({runtimes:"html5,html4",flash_swf_url:"/apps/note/js/plugins/plupload/Moxie.swf",silverlight_xap_url:"/apps/note/js/plugins/plupload/Moxie.xap",browse_button:uploadImageButton,container:$(uploadImageButton).parent()[0],url:"/apps/note/index.php?r=image/upload",file_data_name:"image",multi_selection:!1,drop_element:$(".note-editor")[0],filters:{max_file_size:"5mb",mime_types:[{title:"Image files",extensions:"jpg,jpeg,png,webp"}]},init:{Init:function(uploader){},PostInit:function(){},FilesAdded:function(up,files){uploader.start(),DialogService.open("ProgressBar",function(){up.files.length>0&&up.removeFile(up.files[0]),up.state==plupload.STARTED&&up.stop()})},UploadProgress:function(up,file){AnimationService.action("updateProgressBar")(file.percent)},Error:function(up,err){DialogService.close(),up.files.length>0&&up.removeFile(up.files[0]),"File extension error."==err.message?ToastService.open("FILE_UNSUPPORT"):"File size error."==err.message?ToastService.open("IMAGE_OVERSIZE"):ToastService.open(err.message)},FileUploaded:function(up,file,response){DialogService.close();var data=response.response;data.code||(data=$.parseJSON(data)),0==data.code?TaskService.fire("NoteEditCtrl.insertImage",data.data):ErrorService.catch(data);var inputList_immersive=$(".a-insert-image input");$("#IE9FileBugLabel-immersive").attr({for:$(inputList_immersive[inputList_immersive.length-1]).attr("id")});var inputList_normal=$(".a-insert-image-button input");$("#IE9FileBugLabel-normal").attr({for:$(inputList_normal[inputList_normal.length-1]).attr("id")})}}}),uploader.init(),window.uploaders||(window.uploaders=[],task.add("disableUpload",function(bool){setTimeout(function(){window.uploaders.forEach(function(item){item.disableBrowse(bool)})},100)}),task.add("uploadImageByDragging",function(files){uploader.addFile(files);
})),window.uploaders.push(uploader)}}}]),app.directive("preventdefault",[function(){return{restrict:"A",link:function(scope,elm,attrs,ctrl){elm.on("mousedown",function(event){var evt=event?event:window.event;return evt.preventDefault&&evt.preventDefault(),evt.returnValue=!1,!1})}}}]),app.directive("notecopy",["$filter","EmojiService","TaskService","ImageStringService","EditorImageDecodeService","EditorToolService","MoodService",function($filter,EmojiService,TaskService,ImageStringService,EditorImageDecodeService,EditorToolService,MoodService){function copyEditor(dom){var editor=CodeMirror(dom,{lineWrapping:!0,readOnly:"nocursor",dragDrop:!1,scrollbarStyle:"null"});return editor.on("change",function(cm,changeObj){EditorToolService.polishContent(editor),EditorToolService.decodeEmoji(editor),(ImageStringService.hasImage(changeObj.removed.join(""))||ImageStringService.hasImage(changeObj.text.join("")))&&EditorImageDecodeService(editor)}),editor}function checkNodeLoaded(selectors,callback){var len=selectors.length;$.each(selectors,function(i){$(selectors[i]).length>0&&len--}),0!==len?setTimeout(function(){checkNodeLoaded(selectors,callback)},50):callback()}function asyncSet(note){asyncSetFun.push(function(){TaskService.fire("notecopy.set",note)})}var asyncSetFun=[],editorCopys=[];return{restrict:"A",controller:function($scope,$element){function setHeightAndsetSelectedSumClassName(){var sum=setSelectedSumClassName(),wHeight=$("body").height(),noteHeight=wHeight-63-57-18-100;noteHeight-=noteHeight%50,sum>1?$(".edit-wrap-copy .note-editor").height(noteHeight):$(".edit-wrap-copy .note-editor").css("height","auto")}$scope.$filter=$filter,$scope.note0=null,$scope.note1=null,$scope.note2=null;var selectedList=[],refresh=function(){$([0,1,2]).each(function(i){var note=$scope["note"+i],detail="";note&&note.detail&&(detail=note.detail),detail=ImageStringService.splitImage(detail),editorCopys[i].setValue(detail),$scope["wordCounter"+i]=EditorToolService.wordsCount(editorCopys[i])})},setSelectedSumClassName=function(){var i=selectedList.length;return selectedList.length>3&&(i=3),$(".edit-wrap-copy").removeClass("selected0 selected1 selected2 selected3").addClass("selected"+i),i},updateCopy=function(){var len=selectedList.length;return 0==len?($scope.note0=null,$scope.note1=null,$scope.note2=null,$(".a-edit-wrap-copy").addClass("transparent")):$(".a-edit-wrap-copy").removeClass("transparent"),1==len?($scope.note0=selectedList[0],$scope.note1=null,void($scope.note2=null)):2==len?($scope.note0=selectedList[0],$scope.note1=selectedList[1],void($scope.note2=null)):($scope.note0=selectedList[len-3],$scope.note1=selectedList[len-2],void($scope.note2=selectedList[len-1]))};checkNodeLoaded("#editorcopy0,#editorcopy1,#editorcopy2".split(","),function(){if(editorCopys.push(copyEditor($("#editorcopy0")[0])),editorCopys.push(copyEditor($("#editorcopy1")[0])),editorCopys.push(copyEditor($("#editorcopy2")[0])),asyncSetFun.length>0)for(var i=0;i<asyncSetFun.length;i++)asyncSetFun[i]()});var task=TaskService($scope,"NoteCopyDirc");task.add("set",function(note){if(0==editorCopys.length)return void asyncSet(note);if(_.isArray(note))note.length>1?selectedList=note:(note=note[0],selectedList=note&&note._id?[note]:[]);else{if(!note||!note._id)return;var index=_.indexOf(selectedList,note);index>-1?selectedList.splice(index,1):selectedList.push(note)}updateCopy(),refresh(),setHeightAndsetSelectedSumClassName()}),task.add("clear",function(){selectedList=[],updateCopy(),refresh(),setHeightAndsetSelectedSumClassName()}),task.add("show",function(){$(".edit-wrap-copy").addClass("on"),setTimeout(function(){$(".edit-wrap").addClass("transparent")},50)}),task.add("hide",function(){$(".edit-wrap-copy").removeClass("on"),setTimeout(function(){$(".edit-wrap").removeClass("transparent")},50)}),setHeightAndsetSelectedSumClassName(),$(window).on("resize",function(){setHeightAndsetSelectedSumClassName()})}}}]),app.directive("contextmenuhandler",["ContextMenuService",function(ContextMenuService){return{restrict:"A",link:function(scope,elm,attrs,ctrl){var contextMenu=attrs.contextmenuhandler;elm.on("contextmenu",function(e){e.preventDefault(),contextMenu&&contextMenu.length>0&&ContextMenuService.show(contextMenu,elm,e)})}}}]),app.directive("contextmenu",["ContextMenuService",function(ContextMenuService){return{restrict:"A",link:function(scope,elm,attrs,ctrl){var contextMenuName=attrs.contextmenu;ContextMenuService.add(contextMenuName,elm),elm.children().each(function(){var dom=$(this),actionName=dom.attr("action-name");actionName&&actionName.length>0&&dom.on("click",function(){var eventName=ContextMenuService.makeEventName(contextMenuName,actionName);ContextMenuService.trigger(eventName)})})}}}]),app.directive("folderlist",["DialogService","TaskService","FolderListFindService","FolderListService","NoteService","DialogFolderNameInputService","$timeout","GlobalConfigService","ToastService","StatusService",function(DialogService,TaskService,FolderListFindService,FolderListService,NoteService,DialogFolderNameInputService,$timeout,GlobalConfigService,ToastService,StatusService){return{restrict:"A",link:function(scope,element,attrs,ctrl){scope.temp={sum:0,title:"",isShow:!1},scope.curFolder=null,scope.folderList=[],scope.isDisabled=function(folder){var notes=StatusService.getValue(StatusService.name.SELECTED_NOTES);if(!notes)return!1;if(notes.length>1)return!1;var note=notes[0];if(!folder)return!1;if(!note)return!1;var id=folder._id,curFolderId=FolderListFindService.findFolderByNote(note)._id;return id==curFolderId};var task=TaskService(scope,"FolderListDirc");FolderListService.on("add",function(folder){scope.folderList.push(folder),scope.folderList=FolderListService.sortFolderList(scope.folderList),scope.folderList=_.filter(scope.folderList,function(folder){return folder._id!=GlobalConfigService.TRASH_FOLDER_ID&&folder._id!=GlobalConfigService.FAV_FOLDER_ID&&folder._id!=GlobalConfigService.CALL_FOLDER_ID}),scope.all=scope.folderList[0]}),FolderListService.on("remove",function(folder){scope.folderList=_.without(scope.folderList,folder)}),task.add("showFolderNameInput",function(){return scope.folderList.length>=GlobalConfigService.FOLDER_MAX?void ToastService.open("FOLDER_NUMBER_EXCEEDED"):(scope.temp.isShow=!0,$(".move-note-dialog .list-wrap").scrollTop(0),void $timeout(function(){DialogFolderNameInputService.init("",$(".move-note-dialog .item-temp"),function(val){val.length>0&&(TaskService.fire("FolderListCtrl.createFolder",val),scope.curFolder=scope.folderList[1]),scope.temp.isShow=!1,scope.$$phase||scope.$apply()})}))}),task.add("listClick",function(folder){scope.isDisabled(folder)||(scope.curFolder=folder)}),task.add("reset",function(folder){scope.curFolder=null}),task.add("moveToFolder",function(fn){var notes=StatusService.getValue(StatusService.name.SELECTED_NOTES);if(_.isArray(notes)){if(!scope.curFolder)return void ToastService.open("请选中一个文件夹");TaskService.fire("NoteListCtrl.moveToFolder",notes,scope.curFolder),scope.curFolder=null,fn()}})}}}]),app.directive("notelistscroll",["TaskService","GlobalConfigService",function(TaskService,GlobalConfigService){return{restrict:"A",link:function(scope,elm,attrs,ctrl){function sliceData(){var scrollTop=elm.scrollTop(),top=Math.floor(scrollTop/noteTitleHeight),start=Math.floor(top/updateInterval+.5)*updateInterval-topMinHiddenHeight;start<0&&(start=0),elm.data("sliceStart")!=start&&(elm.data("sliceStart",start),TaskService.fire("NoteListCtrl.updateVisibleNoteList",start,start+visibleMaxLength))}elm.perfectScrollbar({suppressScrollX:!0,wheelPropagation:!0});var topMinHiddenHeight=5,updateInterval=10,noteTitleHeight=GlobalConfigService.NOTE_TITLE_HEIGHT,visibleMaxLength=GlobalConfigService.VISIBLE_MAX_LENGTH,task=TaskService(scope,"NoteListScrollDirc");task.add("setScrollTop",function(scrollTop){_.isNumber(scrollTop)||(scrollTop=0),elm.scrollTop(scrollTop),elm.perfectScrollbar("update")}),$(document).on("ps-scroll-y",function(){sliceData()}),$(document).on("ps-y-reach-start",function(){sliceData()}),$(document).on("ps-y-reach-end",function(){sliceData()})}}}]),app.directive("scrollbar",["ScrollBarService",function(ScrollBarService){return{restrict:"A",link:function(scope,element,attrs,ctrl){ScrollBarService.addDom(attrs.scrollbar,element,scope)}}}]),app.directive("btnactive",[function(){return{restrict:"A",link:function(scope,elm,attrs,ctrl){elm.on("mousedown",function(){elm.hasClass("disabled")||elm.addClass("active")}).on("mouseup",function(){elm.removeClass("active")})}}}]);